<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persona Editor - Gator Admin</title>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --accent: #10b981;
            --danger: #ef4444;
            --dark-bg: #0f0f1e;
            --dark-surface: #1a1a2e;
            --dark-card: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --sidebar-width: 260px;
            --border-color: #2a2a3e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--dark-surface);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .logo-icon {
            font-size: 2rem;
        }
        
        .tenant-selector {
            margin-top: 16px;
            padding: 12px;
            background: var(--dark-card);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tenant-selector:hover {
            border-color: var(--primary);
        }
        
        .tenant-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        
        .tenant-plan {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .nav-section {
            padding: 20px 16px 8px;
        }
        
        .nav-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 8px;
            padding: 0 12px;
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            margin-bottom: 4px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .nav-link:hover {
            background: var(--dark-card);
            color: var(--text-primary);
        }
        
        .nav-link.active {
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            color: white;
            font-weight: 600;
        }
        
        .nav-icon {
            font-size: 1.3rem;
            width: 24px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
        }
        
        .topbar {
            height: 70px;
            background: var(--dark-surface);
            border-bottom: 1px solid var(--border-color);
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .topbar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .back-btn {
            padding: 8px 16px;
            background: var(--dark-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            border-color: var(--primary);
        }
        
        .topbar-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .content-area {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }
        
        .form-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .section {
            background: var(--dark-surface);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .form-label .required {
            color: var(--danger);
        }
        
        .form-help {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--dark-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea.form-input {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }
        
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            background: var(--dark-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-height: 46px;
        }
        
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--primary);
            color: white;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
        }
        
        .tag-remove:hover {
            opacity: 1;
        }
        
        .tag-input {
            flex: 1;
            min-width: 150px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            padding: 6px;
            outline: none;
        }
        
        .key-value-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .key-value-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .key-value-row input {
            flex: 1;
        }
        
        .remove-btn {
            padding: 10px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .remove-btn:hover {
            background: #dc2626;
        }
        
        .add-btn {
            padding: 10px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .add-btn:hover {
            background: #059669;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            background: var(--dark-card);
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .checkbox-label:hover {
            background: var(--dark-surface);
        }
        
        .checkbox-label input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .radio-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 16px;
            background: var(--dark-card);
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .radio-label:hover {
            background: var(--dark-surface);
        }
        
        .radio-label input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--dark-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            border-color: var(--primary);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .image-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .image-upload-area:hover {
            border-color: var(--primary);
            background: var(--dark-card);
        }
        
        .image-preview {
            max-width: 300px;
            max-height: 300px;
            margin: 16px auto;
            border-radius: 8px;
            display: none;
        }
        
        .image-preview.show {
            display: block;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: var(--accent);
            color: white;
        }
        
        .badge-warning {
            background: #f59e0b;
            color: white;
        }
        
        .badge-info {
            background: var(--primary);
            color: white;
        }
        
        /* Sample Image Gallery */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 20px;
        }
        
        .image-card {
            background: var(--dark-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .image-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .image-card.selected {
            border-color: var(--accent);
            border-width: 3px;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        .image-card img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }
        
        .image-card-label {
            text-align: center;
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .image-card.selected .image-card-label {
            color: var(--accent);
            font-weight: 600;
        }
        
        .selected-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--accent);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: none;
        }
        
        .image-card.selected .selected-badge {
            display: block;
        }
        
        .generate-images-section {
            background: var(--dark-card);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .generate-images-section h3 {
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        
        .generate-images-section p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        .btn-generate {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-generate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-generate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .generation-progress {
            margin-top: 20px;
            display: none;
        }
        
        .generation-progress.show {
            display: block;
        }
        
        .progress-text {
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: var(--dark-surface);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.3s;
        }
        
        .feed-assignment-card {
            background: var(--dark-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .feed-assignment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .feed-assignment-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
        }
        
        .feed-assignment-url {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .feed-topics {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .topic-tag {
            display: inline-block;
            padding: 4px 10px;
            background: var(--accent);
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-dialog {
            background: var(--dark-surface);
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            border: 1px solid var(--border-color);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 1.3rem;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .feed-select-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            background: var(--dark-card);
            margin-bottom: 16px;
        }
        
        .feed-select-item {
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }
        
        .feed-select-item:hover {
            background: var(--dark-surface);
        }
        
        .feed-select-item.selected {
            background: var(--primary);
            color: white;
        }
        
        .feed-select-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .feed-select-url {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .category-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }
        
        .category-chip {
            display: inline-block;
            padding: 3px 8px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            font-size: 0.7rem;
        }
        
        /* Persona Chat Testing Styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--dark-card);
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .chat-message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .chat-message.user {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.persona {
            align-self: flex-start;
            background: var(--dark-surface);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .chat-message .sender {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }
        
        .chat-message.persona .sender {
            color: var(--accent);
        }
        
        .chat-message .model-info {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 6px;
        }
        
        .chat-input-area {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-top: 1px solid var(--border-color);
            background: var(--dark-surface);
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--dark-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: none;
            min-height: 44px;
            max-height: 100px;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .chat-send-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .chat-send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .chat-empty-state {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px 20px;
        }
        
        .chat-empty-state .icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }
        
        .chat-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--dark-surface);
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        
        .chat-status.loading {
            color: var(--primary);
        }
        
        .chat-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
        }
        
        .chat-status.loading .dot {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <span class="logo-icon" id="brand-icon">üêä</span>
                <span id="brand-name">Platform</span>
            </div>
            
            <div class="tenant-selector" onclick="switchTenant()">
                <div class="tenant-name" id="tenant-name">My Instance</div>
                <div class="tenant-plan"><span id="tenant-plan-text">Self-Hosted</span> ‚Ä¢ GPU Enabled</div>
            </div>
        </div>
        
        <nav class="nav-section">
            <div class="nav-section-title">Main</div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/admin" class="nav-link">
                        <span class="nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/personas" class="nav-link active">
                        <span class="nav-icon">üé≠</span>
                        <span>Personas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/content" class="nav-link">
                        <span class="nav-icon">üé®</span>
                        <span>Content</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <nav class="nav-section">
            <div class="nav-section-title">Resources</div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/ai-models-setup" class="nav-link">
                        <span class="nav-icon">ü§ñ</span>
                        <span>Models</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/rss" class="nav-link">
                        <span class="nav-icon">üì°</span>
                        <span>RSS Feeds</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <nav class="nav-section">
            <div class="nav-section-title">Insights</div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/admin/analytics" class="nav-link">
                        <span class="nav-icon">üìà</span>
                        <span>Analytics</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/diagnostics" class="nav-link">
                        <span class="nav-icon">ü§ñ</span>
                        <span>Diagnostics</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/gallery" class="nav-link">
                        <span class="nav-icon">üåê</span>
                        <span>Public View</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <nav class="nav-section" style="margin-top: auto;">
            <div class="nav-section-title">System</div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/admin/system-monitoring" class="nav-link">
                        <span class="nav-icon">üå°Ô∏è</span>
                        <span>System Monitor</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/settings" class="nav-link">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span>Settings</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/docs" class="nav-link">
                        <span class="nav-icon">üìö</span>
                        <span>API Docs</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="topbar">
            <div class="topbar-left">
                <a href="/admin/personas" class="back-btn">
                    ‚Üê Back to Personas
                </a>
                <h1 class="page-title" id="page-title">Create Persona</h1>
            </div>
            
            <div class="topbar-right">
                <span id="status-badge"></span>
            </div>
        </div>
        
        <div class="content-area">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Loading persona data...</p>
            </div>
            
            <div class="form-container" id="form-container" style="display: none;">
                <div id="alert-container"></div>
                
                <form id="persona-form">
                    <!-- Basic Information -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üìù</span>
                                Basic Information
                            </h2>
                        </div>
                        <p class="section-description">Core details that define your persona's identity.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Name <span class="required">*</span>
                            </label>
                            <span class="form-help">The display name for your persona (2-100 characters)</span>
                            <input type="text" class="form-input" id="name" name="name" required minlength="2" maxlength="100" placeholder="e.g., Tech Innovator Sarah">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Appearance <span class="required">*</span>
                            </label>
                            <span class="form-help">Physical appearance description for image creation (10-2000 characters)</span>
                            <textarea class="form-input" id="appearance" name="appearance" required minlength="10" maxlength="2000" placeholder="Professional woman in her 30s with short dark hair, wearing modern business attire. Confident posture and intelligent eyes behind stylish glasses."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Personality <span class="required">*</span>
                            </label>
                            <span class="form-help">Personality traits and characteristics (10-2000 characters)</span>
                            <textarea class="form-input" id="personality" name="personality" required minlength="10" maxlength="2000" placeholder="Innovative, analytical, forward-thinking tech leader. Passionate about AI and emerging technologies. Clear communicator who makes complex topics accessible."></textarea>
                        </div>
                    </div>
                    
                    <!-- Content Configuration -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üé®</span>
                                Content Configuration
                            </h2>
                        </div>
                        <p class="section-description">Define content themes and style preferences for your persona.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Content Themes
                            </label>
                            <span class="form-help">Topics this persona specializes in (max 10). Press Enter to add.</span>
                            <div class="tag-input-container" id="themes-container">
                                <input type="text" class="tag-input" id="theme-input" placeholder="Type a theme and press Enter...">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Style Preferences
                            </label>
                            <span class="form-help">Visual style and aesthetic preferences (key-value pairs)</span>
                            <div class="key-value-container" id="style-container">
                                <!-- Will be populated dynamically -->
                            </div>
                            <button type="button" class="add-btn" onclick="addStylePreference()">
                                + Add Style Preference
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content Rating & Platform Settings -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üîí</span>
                                Content Rating & Platform Settings
                            </h2>
                        </div>
                        <p class="section-description">Control content ratings and platform-specific restrictions.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Default Content Rating <span class="required">*</span>
                            </label>
                            <span class="form-help">The default content rating for created content</span>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="default_content_rating" value="sfw" checked>
                                    <span>SFW (Safe for Work)</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="default_content_rating" value="moderate">
                                    <span>Moderate</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="default_content_rating" value="nsfw">
                                    <span>NSFW (Not Safe for Work)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Allowed Content Ratings <span class="required">*</span>
                            </label>
                            <span class="form-help">Content ratings this persona is allowed to create</span>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="allowed_ratings" value="sfw" checked>
                                    <span>SFW (Safe for Work)</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="allowed_ratings" value="moderate">
                                    <span>Moderate</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="allowed_ratings" value="nsfw">
                                    <span>NSFW (Not Safe for Work)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Platform Restrictions
                            </label>
                            <span class="form-help">Platform-specific content restrictions (e.g., instagram: sfw_only)</span>
                            <div class="key-value-container" id="platform-container">
                                <!-- Will be populated dynamically -->
                            </div>
                            <button type="button" class="add-btn" onclick="addPlatformRestriction()">
                                + Add Platform Restriction
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content Generation Preferences -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>‚öôÔ∏è</span>
                                Content Generation Preferences
                            </h2>
                        </div>
                        <p class="section-description">Configure default settings for content generation including resolution, quality, and model preferences.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Default Image Resolution
                            </label>
                            <span class="form-help">Default resolution for image generation</span>
                            <select class="form-input" id="default_image_resolution" name="default_image_resolution">
                                <option value="512x512">512x512 (Square - Draft)</option>
                                <option value="1024x1024" selected>1024x1024 (Square - HD)</option>
                                <option value="2048x2048">2048x2048 (Square - Ultra HD)</option>
                                <option value="720x1280">720x1280 (Portrait 720p)</option>
                                <option value="1080x1920">1080x1920 (Portrait 1080p)</option>
                                <option value="1280x720">1280x720 (Landscape 720p)</option>
                                <option value="1920x1080">1920x1080 (Landscape 1080p)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Default Video Resolution
                            </label>
                            <span class="form-help">Default resolution for video generation</span>
                            <select class="form-input" id="default_video_resolution" name="default_video_resolution">
                                <option value="1280x720">1280x720 (720p HD)</option>
                                <option value="1920x1080" selected>1920x1080 (1080p Full HD)</option>
                                <option value="2560x1440">2560x1440 (1440p 2K)</option>
                                <option value="3840x2160">3840x2160 (2160p 4K)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Generation Quality
                            </label>
                            <span class="form-help">Default quality level for content generation</span>
                            <select class="form-input" id="generation_quality" name="generation_quality">
                                <option value="draft">Draft (Fast, lower quality)</option>
                                <option value="standard" selected>Standard (Balanced)</option>
                                <option value="hd">HD (High detail)</option>
                                <option value="premium">Premium (Best quality, slower)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Post Style
                            </label>
                            <span class="form-help">Default style for content posts</span>
                            <select class="form-input" id="post_style" name="post_style">
                                <option value="casual" selected>Casual</option>
                                <option value="professional">Professional</option>
                                <option value="artistic">Artistic</option>
                                <option value="provocative">Provocative</option>
                                <option value="playful">Playful</option>
                                <option value="elegant">Elegant</option>
                                <option value="edgy">Edgy</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Video Types
                            </label>
                            <span class="form-help">Preferred types of video content</span>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="video_types" value="short_clip">
                                    <span>Short Clip (15-30s)</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="video_types" value="story">
                                    <span>Story (Instagram/Snapchat style)</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="video_types" value="reel">
                                    <span>Reel (TikTok/Instagram Reel)</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="video_types" value="long_form">
                                    <span>Long Form (YouTube/extended)</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="video_types" value="tutorial">
                                    <span>Tutorial/How-to</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                NSFW Model Preference
                            </label>
                            <span class="form-help">Preferred NSFW model (only used when content rating is NSFW)</span>
                            <select class="form-input" id="nsfw_model_preference" name="nsfw_model_preference">
                                <option value="">None (Use default)</option>
                                <option value="flux-nsfw-highress">CultriX/flux-nsfw-highress (High Resolution NSFW)</option>
                                <option value="darkblueaphrodite">StableDiffusion API/darkblueaphrodite (NSFW Hentai)</option>
                                <option value="modifier_sexual_coaching">DervlexVenice/modifier_sexual_coaching (Illustrious Style)</option>
                                <option value="eye_contact_blowjob">DervlexVenice/eye_contact_blowjob-action (Flux Action)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Appearance & Visual Consistency -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üñºÔ∏è</span>
                                Appearance & Visual Consistency
                            </h2>
                        </div>
                        <p class="section-description">Configure baseline appearance and reference images for consistent visual generation.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Base Appearance Description
                            </label>
                            <span class="form-help">Detailed baseline appearance for visual consistency (optional, max 5000 characters)</span>
                            <textarea class="form-input" id="base_appearance_description" name="base_appearance_description" maxlength="5000" placeholder="Detailed physical features, facial structure, body type, distinctive characteristics..."></textarea>
                        </div>
                        
                        <!-- Sample Image Creation (Create Mode Only) -->
                        <div class="form-group" id="sample-images-section" style="display: none;">
                            <label class="form-label">
                                Create Sample Images
                            </label>
                            <span class="form-help">Create 4 different sample images to choose as your base image. The selected image will be locked for visual consistency.</span>
                            
                            <div class="generate-images-section" id="generate-prompt">
                                <h3>üé® Create Sample Images</h3>
                                <p>Click below to create 4 sample images based on your appearance description. This helps establish a consistent look for your persona.</p>
                                
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 16px 0;">
                                    <div>
                                        <label class="form-label" style="margin-bottom: 6px;">Image Style</label>
                                        <select class="form-input" id="style-select" style="margin: 0;">
                                            <option value="photorealistic" selected>üì∑ Photorealistic (Lifelike)</option>
                                            <option value="anime">üéå Anime</option>
                                            <option value="cartoon">üé® Cartoon</option>
                                            <option value="artistic">üñºÔ∏è Artistic/Painting</option>
                                            <option value="3d_render">üéÆ 3D Render</option>
                                            <option value="fantasy">‚ú® Fantasy Art</option>
                                            <option value="cinematic">üé¨ Cinematic</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="form-label" style="margin-bottom: 6px;">Resolution</label>
                                        <select class="form-input" id="resolution-select" style="margin: 0;">
                                            <option value="512x512">512x512 (Square - Draft)</option>
                                            <option value="1024x1024" selected>1024x1024 (Square - HD)</option>
                                            <option value="720x1280">720x1280 (Portrait 720p)</option>
                                            <option value="1080x1920">1080x1920 (Portrait 1080p)</option>
                                            <option value="1280x720">1280x720 (Landscape 720p)</option>
                                            <option value="1920x1080">1920x1080 (Landscape 1080p)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="form-label" style="margin-bottom: 6px;">Quality</label>
                                        <select class="form-input" id="quality-select" style="margin: 0;">
                                            <option value="draft">Draft (Fast)</option>
                                            <option value="standard" selected>Standard (Balanced)</option>
                                            <option value="high">High (Detailed)</option>
                                            <option value="premium">Premium (Best Quality)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn-generate" id="generate-images-btn" onclick="generateSampleImages()">
                                    <span>‚ú®</span>
                                    <span>Create 4 Sample Images</span>
                                </button>
                                
                                <div class="generation-progress" id="generation-progress">
                                    <div class="progress-text" id="progress-text">Creating images... 0/4</div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" id="progress-bar"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="image-gallery" id="image-gallery" style="display: none;">
                                <!-- Sample images will be inserted here -->
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Appearance Locked
                            </label>
                            <span class="form-help">When enabled, locks appearance and enables visual consistency features</span>
                            <label class="checkbox-label">
                                <input type="checkbox" id="appearance_locked" name="appearance_locked">
                                <span>Lock appearance for consistency</span>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Base Image Status
                            </label>
                            <span class="form-help">Current status of the base reference image</span>
                            <select class="form-input" id="base_image_status" name="base_image_status">
                                <option value="pending_upload">Pending Upload</option>
                                <option value="draft">Draft</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Base Image Path
                            </label>
                            <span class="form-help">Path to reference image (will be set via image upload/generation endpoints)</span>
                            <input type="text" class="form-input" id="base_image_path" name="base_image_path" readonly placeholder="/models/base_images/persona_ref.jpg">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Preferred Image Style
                            </label>
                            <span class="form-help">Default image generation style for this persona</span>
                            <select class="form-input" id="image_style" name="image_style">
                                <option value="photorealistic" selected>üì∑ Photorealistic (Lifelike)</option>
                                <option value="anime">üéå Anime</option>
                                <option value="cartoon">üé® Cartoon</option>
                                <option value="artistic">üñºÔ∏è Artistic/Painting</option>
                                <option value="3d_render">üéÆ 3D Render</option>
                                <option value="fantasy">‚ú® Fantasy Art</option>
                                <option value="cinematic">üé¨ Cinematic</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- RSS Feed Assignment -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üì°</span>
                                RSS Feed Content Sources
                            </h2>
                        </div>
                        <p class="section-description">Assign RSS feeds to this persona for content generation inspiration. Specify categories to filter relevant topics.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Assigned RSS Feeds
                            </label>
                            <span class="form-help">RSS feeds that provide content suggestions for this persona</span>
                            <div id="assigned-feeds-container" style="margin-bottom: 12px;">
                                <!-- Will be populated dynamically -->
                            </div>
                            <button type="button" class="add-btn" onclick="showAssignFeedModal()">
                                + Assign RSS Feed
                            </button>
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>‚ö°</span>
                                Status
                            </h2>
                        </div>
                        <p class="section-description">Control whether this persona is active and available for content generation.</p>
                        
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="is_active" name="is_active" checked>
                                <span>Persona is active and available for content generation</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- ==================== PERSONA SOUL FIELDS ==================== -->
                    
                    <!-- Soul Creation -->
                    <div class="section" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(16, 185, 129, 0.1)); border-color: var(--primary);">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üß¨</span>
                                Soul Creation
                            </h2>
                        </div>
                        <p class="section-description">
                            Use Ollama with dolphin-mixtral to create all soul fields based on the persona's name, appearance, personality, and content rating.
                            The created fields will match the tone of your selected content rating.
                        </p>
                        
                        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                            <button type="button" class="btn btn-primary" id="randomize-soul-btn" onclick="randomizeSoulFields()" style="display: inline-flex; align-items: center; gap: 8px;">
                                <span>üé≤</span>
                                <span id="randomize-soul-text">Randomize Soul Fields</span>
                            </button>
                            
                            <span style="color: var(--text-secondary); font-size: 0.85rem;" id="randomize-status">
                                Uses selected content rating to guide creation style
                            </span>
                        </div>
                        
                        <div id="randomize-progress" style="display: none; margin-top: 16px;">
                            <div class="progress-text" style="color: var(--text-secondary); margin-bottom: 8px;">Creating soul fields...</div>
                            <div class="progress-bar-container" style="height: 6px; background: var(--dark-card); border-radius: 3px; overflow: hidden;">
                                <div class="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width 0.3s;" id="randomize-progress-bar"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Origin & Demographics -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üåç</span>
                                Origin & Demographics
                            </h2>
                        </div>
                        <p class="section-description">Define your persona's background and roots. These details create authentic cultural context and life experiences.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Hometown
                            </label>
                            <span class="form-help">Where they're from originally (e.g., "South Boston", "Nashville, TN", "Rural Texas")</span>
                            <input type="text" class="form-input" id="hometown" name="hometown" maxlength="200" placeholder="e.g., Nashville, TN">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Current Location
                            </label>
                            <span class="form-help">Where they live now and why (e.g., "Miami, FL for the weather and liberty")</span>
                            <input type="text" class="form-input" id="current_location" name="current_location" maxlength="200" placeholder="e.g., Miami, FL - moved for the weather">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Generation / Age
                            </label>
                            <span class="form-help">Generation context shapes perspective (e.g., "Gen X - cynical and latchkey", "Millennial - 28 years old")</span>
                            <input type="text" class="form-input" id="generation_age" name="generation_age" maxlength="100" placeholder="e.g., Gen Z - 24 years old, chronically online">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Education Level
                            </label>
                            <span class="form-help">Their educational background, formal or otherwise (e.g., "PhD in Physics", "School of Hard Knocks")</span>
                            <input type="text" class="form-input" id="education_level" name="education_level" maxlength="200" placeholder="e.g., State college dropout, self-taught coder">
                        </div>
                    </div>
                    
                    <!-- Psychological Profile -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üß†</span>
                                Psychological Profile
                            </h2>
                        </div>
                        <p class="section-description">The internal "engine" that drives decision-making and worldview. Helps ensure consistent, believable responses.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                MBTI Type
                            </label>
                            <span class="form-help">Myers-Briggs personality type for consistent behavior patterns</span>
                            <select class="form-input" id="mbti_type" name="mbti_type">
                                <option value="">Select MBTI Type...</option>
                                <option value="INTJ - The Architect">INTJ - The Architect</option>
                                <option value="INTP - The Logician">INTP - The Logician</option>
                                <option value="ENTJ - The Commander">ENTJ - The Commander</option>
                                <option value="ENTP - The Debater">ENTP - The Debater</option>
                                <option value="INFJ - The Advocate">INFJ - The Advocate</option>
                                <option value="INFP - The Mediator">INFP - The Mediator</option>
                                <option value="ENFJ - The Protagonist">ENFJ - The Protagonist</option>
                                <option value="ENFP - The Campaigner">ENFP - The Campaigner</option>
                                <option value="ISTJ - The Logistician">ISTJ - The Logistician</option>
                                <option value="ISFJ - The Defender">ISFJ - The Defender</option>
                                <option value="ESTJ - The Executive">ESTJ - The Executive</option>
                                <option value="ESFJ - The Consul">ESFJ - The Consul</option>
                                <option value="ISTP - The Virtuoso">ISTP - The Virtuoso</option>
                                <option value="ISFP - The Adventurer">ISFP - The Adventurer</option>
                                <option value="ESTP - The Entrepreneur">ESTP - The Entrepreneur</option>
                                <option value="ESFP - The Entertainer">ESFP - The Entertainer</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Enneagram Type
                            </label>
                            <span class="form-help">Enneagram type for deeper motivation patterns</span>
                            <select class="form-input" id="enneagram_type" name="enneagram_type">
                                <option value="">Select Enneagram Type...</option>
                                <option value="Type 1 - The Reformer">Type 1 - The Reformer</option>
                                <option value="Type 2 - The Helper">Type 2 - The Helper</option>
                                <option value="Type 3 - The Achiever">Type 3 - The Achiever</option>
                                <option value="Type 4 - The Individualist">Type 4 - The Individualist</option>
                                <option value="Type 5 - The Investigator">Type 5 - The Investigator</option>
                                <option value="Type 6 - The Loyalist">Type 6 - The Loyalist</option>
                                <option value="Type 7 - The Enthusiast">Type 7 - The Enthusiast</option>
                                <option value="Type 8 - The Challenger">Type 8 - The Challenger</option>
                                <option value="Type 9 - The Peacemaker">Type 9 - The Peacemaker</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Political Alignment
                            </label>
                            <span class="form-help">Political/social worldview for authentic opinions (e.g., "Libertarian-leaning", "Apolitical Nihilist")</span>
                            <input type="text" class="form-input" id="political_alignment" name="political_alignment" maxlength="100" placeholder="e.g., Right-leaning / Liberty-focused">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Risk Tolerance
                            </label>
                            <span class="form-help">How they approach risk and uncertainty (e.g., "Safety First", "Hold my beer")</span>
                            <input type="text" class="form-input" id="risk_tolerance" name="risk_tolerance" maxlength="100" placeholder="e.g., Move fast and break things">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Optimism/Cynicism Scale
                            </label>
                            <span class="form-help">1 = Deeply Cynical, 10 = Eternally Optimistic. This affects their general tone.</span>
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <span style="font-size: 0.85rem; color: var(--text-secondary);">Cynical</span>
                                <input type="range" id="optimism_cynicism_scale" name="optimism_cynicism_scale" min="1" max="10" value="5" style="flex: 1;">
                                <span style="font-size: 0.85rem; color: var(--text-secondary);">Optimistic</span>
                                <span id="optimism_value" style="min-width: 30px; text-align: center; font-weight: 600;">5</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Voice & Speech Patterns -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üó£Ô∏è</span>
                                Voice & Speech Patterns
                            </h2>
                        </div>
                        <p class="section-description">How the persona speaks and writes. This is the "interface" that users experience directly.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Linguistic Register
                            </label>
                            <span class="form-help">The overall speech style and vocabulary level</span>
                            <select class="form-input" id="linguistic_register" name="linguistic_register">
                                <option value="blue_collar">üîß Blue Collar - Casual, working-class speech</option>
                                <option value="academic">üìö Academic - Formal, scholarly speech</option>
                                <option value="tech_bro">üíª Tech Bro - Silicon Valley tech speak</option>
                                <option value="street">üèôÔ∏è Street - Urban slang and colloquialisms</option>
                                <option value="corporate">üíº Corporate - Business jargon</option>
                                <option value="southern">ü§† Southern - Southern U.S. dialect</option>
                                <option value="millennial">üì± Millennial - Millennial internet speak</option>
                                <option value="gen_z">‚ö° Gen Z - Chaotic and ironic</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Typing Quirks
                            </label>
                            <span class="form-help">Specific typing habits. Add key-value pairs like: capitalization, emoji_usage, punctuation</span>
                            <div class="key-value-container" id="typing-quirks-container">
                                <!-- Will be populated dynamically -->
                            </div>
                            <button type="button" class="add-btn" onclick="addTypingQuirk()">
                                + Add Typing Quirk
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Signature Phrases
                            </label>
                            <span class="form-help">Phrases they use often (e.g., "Based", "Facts", "Y'all"). Press Enter to add.</span>
                            <div class="tag-input-container" id="signature-phrases-container">
                                <input type="text" class="tag-input" id="signature-phrase-input" placeholder="Type a phrase and press Enter...">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Trigger Topics
                            </label>
                            <span class="form-help">Topics that get them excited or angry (e.g., "Taxes", "Crypto", "Bad drivers"). Press Enter to add.</span>
                            <div class="tag-input-container" id="trigger-topics-container">
                                <input type="text" class="tag-input" id="trigger-topic-input" placeholder="Type a topic and press Enter...">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Backstory & Lore -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üìñ</span>
                                Backstory & Lore
                            </h2>
                        </div>
                        <p class="section-description">The persona's life story and context. This adds depth and makes conversations more authentic.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Day Job
                            </label>
                            <span class="form-help">What they do for work (e.g., "Political Commentator / Streamer", "Small business owner")</span>
                            <input type="text" class="form-input" id="day_job" name="day_job" maxlength="200" placeholder="e.g., Content creator and part-time real estate agent">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                War Story
                            </label>
                            <span class="form-help">A defining life event that shaped who they are (e.g., "Lost a fortune in 2008", "Started posting rants in her car and went viral")</span>
                            <textarea class="form-input" id="war_story" name="war_story" maxlength="2000" placeholder="The story they always bring up..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Vices & Hobbies
                            </label>
                            <span class="form-help">What they do for fun, guilty pleasures (e.g., "Range days", "Video games", "Wine nights"). Press Enter to add.</span>
                            <div class="tag-input-container" id="vices-hobbies-container">
                                <input type="text" class="tag-input" id="vices-hobbies-input" placeholder="Type a vice/hobby and press Enter...">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Anti-Pattern -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üö´</span>
                                Anti-Pattern (What They Are NOT)
                            </h2>
                        </div>
                        <p class="section-description">Define what this persona would NEVER say or do. This prevents robotic-sounding responses and keeps character consistent.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Forbidden Phrases
                            </label>
                            <span class="form-help">Phrases this persona would NEVER say (e.g., "As an AI", "I feel that", "Synergy", "Safe space"). Press Enter to add.</span>
                            <div class="tag-input-container" id="forbidden-phrases-container">
                                <input type="text" class="tag-input" id="forbidden-phrase-input" placeholder="Type a forbidden phrase and press Enter...">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Warmth Level
                            </label>
                            <span class="form-help">How warm and approachable they are in interactions</span>
                            <select class="form-input" id="warmth_level" name="warmth_level">
                                <option value="cold">‚ùÑÔ∏è Cold - Distant, professional</option>
                                <option value="neutral">üòê Neutral - Neither warm nor cold</option>
                                <option value="warm" selected>üôÇ Warm - Friendly, approachable</option>
                                <option value="buddy">ü§ó Buddy - Very friendly, like a best friend</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Patience Level
                            </label>
                            <span class="form-help">How they handle frustration and repetitive questions</span>
                            <select class="form-input" id="patience_level" name="patience_level">
                                <option value="short_fuse">üí¢ Short Fuse - Quick to frustration</option>
                                <option value="normal" selected>üòä Normal - Average patience</option>
                                <option value="patient">üßò Patient - Tolerant and understanding</option>
                                <option value="infinite">‚òØÔ∏è Infinite - Never gets frustrated</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Persona Chat Testing (Edit Mode Only) -->
                    <div class="section" id="chat-testing-section" style="display: none;">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üí¨</span>
                                Test Persona Chat
                            </h2>
                        </div>
                        <p class="section-description">
                            Test how your persona responds in conversations. Uses the <strong>dolphin-mixtral</strong> model for unrestricted, 
                            uncensored responses. <strong>Conversation context is maintained</strong> for fluid conversations. 
                            <br><br>
                            <strong>üì∏ Image triggers:</strong> Try phrases like "take a picture", "send me a selfie", or "show me a pic" to generate images!
                        </p>
                        
                        <div class="chat-status" id="chat-status">
                            <span class="dot"></span>
                            <span id="chat-status-text">Ready to chat</span>
                        </div>
                        
                        <div class="chat-container">
                            <div class="chat-messages" id="chat-messages">
                                <div class="chat-empty-state" id="chat-empty">
                                    <div class="icon">üí¨</div>
                                    <div>Start a conversation with your persona</div>
                                    <div style="font-size: 0.8rem; margin-top: 8px;">
                                        Type a message below to see how they respond
                                    </div>
                                    <div style="font-size: 0.75rem; margin-top: 4px; color: var(--accent);">
                                        üí° Try "send me a selfie" to trigger image generation!
                                    </div>
                                </div>
                            </div>
                            
                            <div class="chat-input-area">
                                <textarea 
                                    class="chat-input" 
                                    id="chat-input" 
                                    placeholder="Type a message to test your persona..."
                                    rows="1"
                                    onkeydown="handleChatKeydown(event)"
                                ></textarea>
                                <button type="button" class="chat-send-btn" id="chat-send-btn" onclick="sendChatMessage()">
                                    Send
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-secondary" onclick="clearChatHistory()" style="padding: 8px 16px; font-size: 0.85rem;">
                                üóëÔ∏è Clear Chat
                            </button>
                            <span style="color: var(--text-secondary); font-size: 0.8rem; align-self: center;" id="chat-model-info">
                                dolphin-mixtral | Context: last 10 messages | üì∏ Image triggers enabled
                            </span>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="form-actions">
                        <a href="/admin/personas" class="btn btn-secondary">Cancel</a>
                        <button type="button" class="btn btn-danger" id="delete-btn" style="display: none;" onclick="deletePersona()">
                            Delete Persona
                        </button>
                        <button type="submit" class="btn btn-primary" id="submit-btn">
                            <span id="submit-text">Create Persona</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>
    
    <script>
        // Global state
        let editorMode = 'create'; // 'create' or 'edit'
        let personaId = null;
        let themes = [];
        let stylePreferences = {};
        let platformRestrictions = {};
        let sampleImages = []; // Created sample images
        let selectedImageData = null; // Selected image for base
        let assignedFeeds = []; // Assigned RSS feeds for persona
        let availableFeeds = []; // Available RSS feeds to assign
        
        // Persona Soul Fields state
        let typingQuirks = {};
        let signaturePhrases = [];
        let triggerTopics = [];
        let vicesHobbies = [];
        let forbiddenPhrases = [];
        
        // Load branding configuration
        async function loadBranding() {
            try {
                const response = await fetch('/api/v1/branding');
                const branding = await response.json();
                
                document.getElementById('brand-name').textContent = branding.site_name || 'Platform';
                document.getElementById('brand-icon').textContent = branding.icon || 'üêä';
                document.getElementById('tenant-name').textContent = branding.instance_name || 'My Instance';
            } catch (e) {
                console.log('Using default branding');
            }
        }
        
        function switchTenant() {
            alert('Tenant switching coming soon!');
        }
        
        // Parse URL parameters
        function parseUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const action = params.get('action');
            const id = params.get('id');
            
            if (action === 'edit' && id) {
                editorMode = 'edit';
                personaId = id;
                document.getElementById('page-title').textContent = 'Edit Persona';
                document.getElementById('submit-text').textContent = 'Update Persona';
                document.getElementById('delete-btn').style.display = 'inline-block';
                // Show sample images section in edit mode too (for updating base images)
                document.getElementById('sample-images-section').style.display = 'block';
            } else {
                editorMode = 'create';
                document.getElementById('page-title').textContent = 'Create Persona';
                document.getElementById('submit-text').textContent = 'Create Persona';
                // Show sample images section in create mode
                document.getElementById('sample-images-section').style.display = 'block';
            }
        }
        
        // Show alert
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }
        
        // Load persona data for editing
        async function loadPersonaData() {
            if (editorMode !== 'edit' || !personaId) {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('form-container').style.display = 'block';
                return;
            }
            
            document.getElementById('loading').classList.add('show');
            
            try {
                const response = await fetch(`/api/v1/personas/${personaId}`);
                if (!response.ok) {
                    throw new Error('Failed to load persona');
                }
                
                const persona = await response.json();
                
                // Populate basic fields
                document.getElementById('name').value = persona.name || '';
                document.getElementById('appearance').value = persona.appearance || '';
                document.getElementById('personality').value = persona.personality || '';
                
                // Populate themes
                themes = persona.content_themes || [];
                renderThemes();
                
                // Populate style preferences
                stylePreferences = persona.style_preferences || {};
                renderStylePreferences();
                
                // Populate content rating
                const defaultRating = persona.default_content_rating || 'sfw';
                document.querySelector(`input[name="default_content_rating"][value="${defaultRating}"]`).checked = true;
                
                // Populate allowed ratings
                const allowedRatings = persona.allowed_content_ratings || ['sfw'];
                document.querySelectorAll('input[name="allowed_ratings"]').forEach(checkbox => {
                    checkbox.checked = allowedRatings.includes(checkbox.value);
                });
                
                // Populate platform restrictions
                platformRestrictions = persona.platform_restrictions || {};
                renderPlatformRestrictions();
                
                // Populate appearance fields
                document.getElementById('base_appearance_description').value = persona.base_appearance_description || '';
                document.getElementById('appearance_locked').checked = persona.appearance_locked || false;
                document.getElementById('base_image_status').value = persona.base_image_status || 'pending_upload';
                document.getElementById('base_image_path').value = persona.base_image_path || '';
                document.getElementById('image_style').value = persona.image_style || 'photorealistic';
                
                // Populate content generation preferences
                document.getElementById('default_image_resolution').value = persona.default_image_resolution || '1024x1024';
                document.getElementById('default_video_resolution').value = persona.default_video_resolution || '1920x1080';
                document.getElementById('post_style').value = persona.post_style || 'casual';
                document.getElementById('generation_quality').value = persona.generation_quality || 'standard';
                document.getElementById('nsfw_model_preference').value = persona.nsfw_model_preference || '';
                
                // Populate video types
                const videoTypes = persona.video_types || [];
                document.querySelectorAll('input[name="video_types"]').forEach(checkbox => {
                    checkbox.checked = videoTypes.includes(checkbox.value);
                });
                
                // Populate status
                document.getElementById('is_active').checked = persona.is_active !== false;
                
                // ==================== POPULATE PERSONA SOUL FIELDS ====================
                
                // Origin & Demographics
                document.getElementById('hometown').value = persona.hometown || '';
                document.getElementById('current_location').value = persona.current_location || '';
                document.getElementById('generation_age').value = persona.generation_age || '';
                document.getElementById('education_level').value = persona.education_level || '';
                
                // Psychological Profile
                document.getElementById('mbti_type').value = persona.mbti_type || '';
                document.getElementById('enneagram_type').value = persona.enneagram_type || '';
                document.getElementById('political_alignment').value = persona.political_alignment || '';
                document.getElementById('risk_tolerance').value = persona.risk_tolerance || '';
                const optimismScale = persona.optimism_cynicism_scale || 5;
                document.getElementById('optimism_cynicism_scale').value = optimismScale;
                document.getElementById('optimism_value').textContent = optimismScale;
                
                // Voice & Speech Patterns
                document.getElementById('linguistic_register').value = persona.linguistic_register || 'blue_collar';
                typingQuirks = persona.typing_quirks || {};
                renderTypingQuirks();
                signaturePhrases = persona.signature_phrases || [];
                renderSignaturePhrases();
                triggerTopics = persona.trigger_topics || [];
                renderTriggerTopics();
                
                // Backstory & Lore
                document.getElementById('day_job').value = persona.day_job || '';
                document.getElementById('war_story').value = persona.war_story || '';
                vicesHobbies = persona.vices_hobbies || [];
                renderVicesHobbies();
                
                // Anti-Pattern
                forbiddenPhrases = persona.forbidden_phrases || [];
                renderForbiddenPhrases();
                document.getElementById('warmth_level').value = persona.warmth_level || 'warm';
                document.getElementById('patience_level').value = persona.patience_level || 'normal';
                
                // Show status badge
                const badge = document.getElementById('status-badge');
                if (persona.generation_count > 0) {
                    badge.innerHTML = `<span class="badge badge-info">${persona.generation_count} generations</span>`;
                }
                
                // Load assigned RSS feeds
                await loadAssignedFeeds();
                
                // Load and display base image if it exists
                await loadExistingBaseImage();
                
                document.getElementById('loading').classList.remove('show');
                document.getElementById('form-container').style.display = 'block';
            } catch (error) {
                console.error('Failed to load persona:', error);
                showAlert('Failed to load persona data. Please try again.', 'error');
                setTimeout(() => {
                    window.location.href = '/admin/personas';
                }, 2000);
            }
        }
        
        // Theme management
        function renderThemes() {
            const container = document.getElementById('themes-container');
            const input = document.getElementById('theme-input');
            
            // Clear existing tags (except input)
            container.querySelectorAll('.tag').forEach(tag => tag.remove());
            
            // Add tags
            themes.forEach((theme, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${theme}
                    <span class="tag-remove" onclick="removeTheme(${index})">√ó</span>
                `;
                container.insertBefore(tag, input);
            });
        }
        
        function addTheme(theme) {
            theme = theme.trim();
            if (theme && !themes.includes(theme) && themes.length < 10) {
                themes.push(theme);
                renderThemes();
            }
        }
        
        function removeTheme(index) {
            themes.splice(index, 1);
            renderThemes();
        }
        
        // Style preferences management
        function renderStylePreferences() {
            const container = document.getElementById('style-container');
            container.innerHTML = '';
            
            Object.entries(stylePreferences).forEach(([key, value]) => {
                const row = document.createElement('div');
                row.className = 'key-value-row';
                row.innerHTML = `
                    <input type="text" class="form-input" value="${key}" placeholder="Key (e.g., aesthetic)" onchange="updateStyleKey(this, '${key}')">
                    <input type="text" class="form-input" value="${value}" placeholder="Value (e.g., professional)" onchange="updateStyleValue('${key}', this.value)">
                    <button type="button" class="remove-btn" onclick="removeStylePreference('${key}')">√ó</button>
                `;
                container.appendChild(row);
            });
        }
        
        function addStylePreference() {
            const newKey = `style_${Object.keys(stylePreferences).length + 1}`;
            stylePreferences[newKey] = '';
            renderStylePreferences();
        }
        
        function updateStyleKey(input, oldKey) {
            const newKey = input.value.trim();
            if (newKey && newKey !== oldKey && !stylePreferences.hasOwnProperty(newKey)) {
                stylePreferences[newKey] = stylePreferences[oldKey];
                delete stylePreferences[oldKey];
                renderStylePreferences();
            }
        }
        
        function updateStyleValue(key, value) {
            stylePreferences[key] = value.trim();
        }
        
        function removeStylePreference(key) {
            delete stylePreferences[key];
            renderStylePreferences();
        }
        
        // Platform restrictions management
        function renderPlatformRestrictions() {
            const container = document.getElementById('platform-container');
            container.innerHTML = '';
            
            Object.entries(platformRestrictions).forEach(([platform, restriction]) => {
                const row = document.createElement('div');
                row.className = 'key-value-row';
                row.innerHTML = `
                    <input type="text" class="form-input" value="${platform}" placeholder="Platform (e.g., instagram)" onchange="updatePlatformKey(this, '${platform}')">
                    <select class="form-input" onchange="updatePlatformValue('${platform}', this.value)">
                        <option value="sfw_only" ${restriction === 'sfw_only' ? 'selected' : ''}>SFW Only</option>
                        <option value="moderate_allowed" ${restriction === 'moderate_allowed' ? 'selected' : ''}>Moderate Allowed</option>
                        <option value="both" ${restriction === 'both' ? 'selected' : ''}>Both (SFW & NSFW)</option>
                        <option value="all" ${restriction === 'all' ? 'selected' : ''}>All</option>
                    </select>
                    <button type="button" class="remove-btn" onclick="removePlatformRestriction('${platform}')">√ó</button>
                `;
                container.appendChild(row);
            });
        }
        
        function addPlatformRestriction() {
            const newPlatform = `platform_${Object.keys(platformRestrictions).length + 1}`;
            platformRestrictions[newPlatform] = 'sfw_only';
            renderPlatformRestrictions();
        }
        
        function updatePlatformKey(input, oldKey) {
            const newKey = input.value.trim();
            if (newKey && newKey !== oldKey && !platformRestrictions.hasOwnProperty(newKey)) {
                platformRestrictions[newKey] = platformRestrictions[oldKey];
                delete platformRestrictions[oldKey];
                renderPlatformRestrictions();
            }
        }
        
        function updatePlatformValue(platform, value) {
            platformRestrictions[platform] = value;
        }
        
        function removePlatformRestriction(platform) {
            delete platformRestrictions[platform];
            renderPlatformRestrictions();
        }
        
        // ==================== PERSONA SOUL FIELDS MANAGEMENT ====================
        
        // Typing Quirks management
        function renderTypingQuirks() {
            const container = document.getElementById('typing-quirks-container');
            container.innerHTML = '';
            
            Object.entries(typingQuirks).forEach(([key, value]) => {
                const row = document.createElement('div');
                row.className = 'key-value-row';
                row.innerHTML = `
                    <input type="text" class="form-input" value="${key}" placeholder="Key (e.g., capitalization)" onchange="updateTypingQuirkKey(this, '${key}')">
                    <input type="text" class="form-input" value="${value}" placeholder="Value (e.g., all lowercase)" onchange="updateTypingQuirkValue('${key}', this.value)">
                    <button type="button" class="remove-btn" onclick="removeTypingQuirk('${key}')">√ó</button>
                `;
                container.appendChild(row);
            });
        }
        
        // Counter for unique quirk key generation
        let typingQuirkCounter = 0;
        
        function addTypingQuirk() {
            const suggestedKeys = ['capitalization', 'emoji_usage', 'punctuation', 'abbreviations'];
            const existingKeys = Object.keys(typingQuirks);
            let availableKey = suggestedKeys.find(k => !existingKeys.includes(k));
            if (!availableKey) {
                // Use timestamp-based key for uniqueness
                typingQuirkCounter++;
                availableKey = `quirk_${Date.now()}_${typingQuirkCounter}`;
            }
            typingQuirks[availableKey] = '';
            renderTypingQuirks();
        }
        
        function updateTypingQuirkKey(input, oldKey) {
            const newKey = input.value.trim();
            if (newKey && newKey !== oldKey && !typingQuirks.hasOwnProperty(newKey)) {
                typingQuirks[newKey] = typingQuirks[oldKey];
                delete typingQuirks[oldKey];
                renderTypingQuirks();
            }
        }
        
        function updateTypingQuirkValue(key, value) {
            typingQuirks[key] = value.trim();
        }
        
        function removeTypingQuirk(key) {
            delete typingQuirks[key];
            renderTypingQuirks();
        }
        
        // Signature Phrases management
        function renderSignaturePhrases() {
            const container = document.getElementById('signature-phrases-container');
            const input = document.getElementById('signature-phrase-input');
            
            container.querySelectorAll('.tag').forEach(tag => tag.remove());
            
            signaturePhrases.forEach((phrase, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${phrase}
                    <span class="tag-remove" onclick="removeSignaturePhrase(${index})">√ó</span>
                `;
                container.insertBefore(tag, input);
            });
        }
        
        function addSignaturePhrase(phrase) {
            phrase = phrase.trim();
            if (phrase && !signaturePhrases.includes(phrase)) {
                signaturePhrases.push(phrase);
                renderSignaturePhrases();
            }
        }
        
        function removeSignaturePhrase(index) {
            signaturePhrases.splice(index, 1);
            renderSignaturePhrases();
        }
        
        // Trigger Topics management
        function renderTriggerTopics() {
            const container = document.getElementById('trigger-topics-container');
            const input = document.getElementById('trigger-topic-input');
            
            container.querySelectorAll('.tag').forEach(tag => tag.remove());
            
            triggerTopics.forEach((topic, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${topic}
                    <span class="tag-remove" onclick="removeTriggerTopic(${index})">√ó</span>
                `;
                container.insertBefore(tag, input);
            });
        }
        
        function addTriggerTopic(topic) {
            topic = topic.trim();
            if (topic && !triggerTopics.includes(topic)) {
                triggerTopics.push(topic);
                renderTriggerTopics();
            }
        }
        
        function removeTriggerTopic(index) {
            triggerTopics.splice(index, 1);
            renderTriggerTopics();
        }
        
        // Vices & Hobbies management
        function renderVicesHobbies() {
            const container = document.getElementById('vices-hobbies-container');
            const input = document.getElementById('vices-hobbies-input');
            
            container.querySelectorAll('.tag').forEach(tag => tag.remove());
            
            vicesHobbies.forEach((item, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${item}
                    <span class="tag-remove" onclick="removeViceHobby(${index})">√ó</span>
                `;
                container.insertBefore(tag, input);
            });
        }
        
        function addViceHobby(item) {
            item = item.trim();
            if (item && !vicesHobbies.includes(item)) {
                vicesHobbies.push(item);
                renderVicesHobbies();
            }
        }
        
        function removeViceHobby(index) {
            vicesHobbies.splice(index, 1);
            renderVicesHobbies();
        }
        
        // Forbidden Phrases management
        function renderForbiddenPhrases() {
            const container = document.getElementById('forbidden-phrases-container');
            const input = document.getElementById('forbidden-phrase-input');
            
            container.querySelectorAll('.tag').forEach(tag => tag.remove());
            
            forbiddenPhrases.forEach((phrase, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.style.background = '#ef4444'; // Red color for forbidden
                tag.innerHTML = `
                    ${phrase}
                    <span class="tag-remove" onclick="removeForbiddenPhrase(${index})">√ó</span>
                `;
                container.insertBefore(tag, input);
            });
        }
        
        function addForbiddenPhrase(phrase) {
            phrase = phrase.trim();
            if (phrase && !forbiddenPhrases.includes(phrase)) {
                forbiddenPhrases.push(phrase);
                renderForbiddenPhrases();
            }
        }
        
        function removeForbiddenPhrase(index) {
            forbiddenPhrases.splice(index, 1);
            renderForbiddenPhrases();
        }
        
        // ==================== SOUL CREATION ====================
        
        async function randomizeSoulFields() {
            const name = document.getElementById('name').value.trim();
            const appearance = document.getElementById('appearance').value.trim();
            const personality = document.getElementById('personality').value.trim();
            
            if (!name) {
                showAlert('Please enter a name before creating soul fields.', 'error');
                return;
            }
            
            // Get the selected content rating
            const contentRating = document.querySelector('input[name="default_content_rating"]:checked')?.value || 'sfw';
            
            const btn = document.getElementById('randomize-soul-btn');
            const btnText = document.getElementById('randomize-soul-text');
            const statusText = document.getElementById('randomize-status');
            const progress = document.getElementById('randomize-progress');
            const progressBar = document.getElementById('randomize-progress-bar');
            
            // Disable button and show progress
            btn.disabled = true;
            btnText.textContent = 'Creating...';
            statusText.textContent = `Creating ${contentRating.toUpperCase()} soul fields...`;
            progress.style.display = 'block';
            progressBar.style.width = '20%';
            
            try {
                const response = await fetch('/api/v1/personas/generate-soul-fields', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        appearance: appearance,
                        personality: personality,
                        content_rating: contentRating
                    })
                });
                
                progressBar.style.width = '60%';
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create soul fields');
                }
                
                const soulData = await response.json();
                progressBar.style.width = '80%';
                
                // Populate all the soul fields
                populateSoulFields(soulData);
                
                progressBar.style.width = '100%';
                
                const modelInfo = soulData.model_used ? ` using ${soulData.model_used}` : '';
                statusText.textContent = `‚úÖ Created successfully${modelInfo}!`;
                showAlert(`Soul fields created successfully${modelInfo}! Review and adjust as needed.`, 'success');
                
                // Hide progress after a moment
                setTimeout(() => {
                    progress.style.display = 'none';
                    statusText.textContent = 'Uses selected content rating to guide creation style';
                }, 3000);
                
            } catch (error) {
                console.error('Failed to create soul fields:', error);
                statusText.textContent = `‚ùå ${error.message}`;
                showAlert(error.message || 'Failed to create soul fields. Make sure Ollama is running.', 'error');
                progress.style.display = 'none';
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Randomize Soul Fields';
            }
        }
        
        function populateSoulFields(soulData) {
            // Origin & Demographics
            if (soulData.hometown) document.getElementById('hometown').value = soulData.hometown;
            if (soulData.current_location) document.getElementById('current_location').value = soulData.current_location;
            if (soulData.generation_age) document.getElementById('generation_age').value = soulData.generation_age;
            if (soulData.education_level) document.getElementById('education_level').value = soulData.education_level;
            
            // Psychological Profile
            if (soulData.mbti_type) document.getElementById('mbti_type').value = soulData.mbti_type;
            if (soulData.enneagram_type) document.getElementById('enneagram_type').value = soulData.enneagram_type;
            if (soulData.political_alignment) document.getElementById('political_alignment').value = soulData.political_alignment;
            if (soulData.risk_tolerance) document.getElementById('risk_tolerance').value = soulData.risk_tolerance;
            
            if (soulData.optimism_cynicism_scale !== null && soulData.optimism_cynicism_scale !== undefined) {
                document.getElementById('optimism_cynicism_scale').value = soulData.optimism_cynicism_scale;
                document.getElementById('optimism_value').textContent = soulData.optimism_cynicism_scale;
            }
            
            // Voice & Speech Patterns
            if (soulData.linguistic_register) {
                document.getElementById('linguistic_register').value = soulData.linguistic_register;
            }
            
            if (soulData.typing_quirks && typeof soulData.typing_quirks === 'object') {
                typingQuirks = soulData.typing_quirks;
                renderTypingQuirks();
            }
            
            if (soulData.signature_phrases && Array.isArray(soulData.signature_phrases)) {
                signaturePhrases = soulData.signature_phrases;
                renderSignaturePhrases();
            }
            
            if (soulData.trigger_topics && Array.isArray(soulData.trigger_topics)) {
                triggerTopics = soulData.trigger_topics;
                renderTriggerTopics();
            }
            
            // Backstory & Lore
            if (soulData.day_job) document.getElementById('day_job').value = soulData.day_job;
            if (soulData.war_story) document.getElementById('war_story').value = soulData.war_story;
            
            if (soulData.vices_hobbies && Array.isArray(soulData.vices_hobbies)) {
                vicesHobbies = soulData.vices_hobbies;
                renderVicesHobbies();
            }
            
            // Anti-Pattern
            if (soulData.forbidden_phrases && Array.isArray(soulData.forbidden_phrases)) {
                forbiddenPhrases = soulData.forbidden_phrases;
                renderForbiddenPhrases();
            }
            
            if (soulData.warmth_level) document.getElementById('warmth_level').value = soulData.warmth_level;
            if (soulData.patience_level) document.getElementById('patience_level').value = soulData.patience_level;
        }
        
        // Sample image creation
        async function generateSampleImages() {
            const appearance = document.getElementById('appearance').value.trim();
            const personality = document.getElementById('personality').value.trim();
            const resolution = document.getElementById('resolution-select').value;
            const quality = document.getElementById('quality-select').value;
            const style = document.getElementById('style-select').value;
            
            if (!appearance || appearance.length < 10) {
                showAlert('Please enter an appearance description (at least 10 characters) before creating images.', 'error');
                return;
            }
            
            const generateBtn = document.getElementById('generate-images-btn');
            const progress = document.getElementById('generation-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const gallery = document.getElementById('image-gallery');
            
            // Disable button and show progress
            generateBtn.disabled = true;
            generateBtn.textContent = 'Creating...';
            progress.classList.add('show');
            gallery.style.display = 'none';
            sampleImages = [];
            
            try {
                // Call API to create sample images with resolution, quality, and style
                const styleLabel = document.getElementById('style-select').selectedOptions[0].textContent;
                progressText.textContent = `Creating 4 ${styleLabel} images at ${resolution} (${quality} quality)... This may take 1-2 minutes.`;
                progressBar.style.width = '25%';
                
                const response = await fetch('/api/v1/personas/generate-sample-images?' + new URLSearchParams({
                    appearance: appearance,
                    personality: personality || '',
                    resolution: resolution,
                    quality: quality,
                    style: style
                }), {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create images');
                }
                
                const result = await response.json();
                sampleImages = result.images || [];
                
                progressBar.style.width = '100%';
                progressText.textContent = `Created ${sampleImages.length} images successfully!`;
                
                // Display images
                if (sampleImages.length > 0) {
                    displaySampleImages();
                    setTimeout(() => {
                        progress.classList.remove('show');
                    }, 1500);
                } else {
                    showAlert('No images were created. Please try again.', 'error');
                    progress.classList.remove('show');
                }
                
            } catch (error) {
                console.error('Failed to create images:', error);
                showAlert(error.message || 'Failed to create images. Please try again.', 'error');
                progress.classList.remove('show');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span>‚ú®</span><span>Create 4 Sample Images</span>';
            }
        }
        
        function displaySampleImages() {
            const gallery = document.getElementById('image-gallery');
            gallery.innerHTML = '';
            gallery.style.display = 'grid';
            
            sampleImages.forEach((image, index) => {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.id = `image-card-${image.id}`;
                card.onclick = () => selectSampleImage(image.id);
                
                card.innerHTML = `
                    <span class="selected-badge">‚úì Selected</span>
                    <img src="${image.data_url}" alt="Sample ${index + 1}">
                    <div class="image-card-label">Sample ${index + 1}</div>
                `;
                
                gallery.appendChild(card);
            });
            
            // Show instruction
            const actionText = editorMode === 'edit' ? 'update' : 'set';
            showAlert(`Select one image to ${actionText} as your persona's base image. The selected image will be locked for consistency.`, 'success');
        }
        
        function selectSampleImage(imageId) {
            // Remove previous selection
            document.querySelectorAll('.image-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Mark new selection
            const card = document.getElementById(`image-card-${imageId}`);
            if (card) {
                card.classList.add('selected');
            }
            
            // Store selected image data
            const image = sampleImages.find(img => img.id === imageId);
            if (image) {
                selectedImageData = image.data_url;
                
                // Update form fields to indicate image is selected
                document.getElementById('base_image_status').value = 'approved';
                document.getElementById('appearance_locked').checked = true;
                document.getElementById('base_image_path').value = editorMode === 'edit' ? `Will be updated when you save` : `Will be set after persona creation`;
                
                const actionText = editorMode === 'edit' ? 'update' : 'create';
                showAlert(`Image selected! This will be set as your base image when you ${actionText} the persona.`, 'success');
            }
        }
        
        async function loadExistingBaseImage() {
            // Only load in edit mode
            if (editorMode !== 'edit' || !personaId) {
                return;
            }
            
            try {
                // Fetch the base image URL for this persona
                const response = await fetch(`/api/v1/personas/${personaId}/base-image-url`);
                if (!response.ok) {
                    console.error('Failed to fetch base image URL');
                    return;
                }
                
                const data = await response.json();
                
                // If there's a base image, display it
                if (data.base_image_url) {
                    const gallery = document.getElementById('image-gallery');
                    gallery.innerHTML = '';
                    gallery.style.display = 'grid';
                    
                    // Create a card for the existing base image
                    const card = document.createElement('div');
                    card.className = 'image-card selected';
                    card.id = 'existing-base-image';
                    
                    // Add locked badge if appearance is locked
                    const lockedBadge = data.appearance_locked ? '<span class="selected-badge">üîí Locked</span>' : '<span class="selected-badge">‚úì Current</span>';
                    
                    card.innerHTML = `
                        ${lockedBadge}
                        <img src="${data.base_image_url}" alt="Current Base Image" onerror="this.parentElement.style.display='none'">
                        <div class="image-card-label">Current Base Image</div>
                    `;
                    
                    gallery.appendChild(card);
                    
                    // Show info message
                    const statusText = data.appearance_locked ? 'locked and being used for consistency' : 'set but not locked';
                    showAlert(`This persona has a base image that is ${statusText}. You can create new samples to update it.`, 'info');
                }
            } catch (error) {
                console.error('Failed to load existing base image:', error);
                // Don't show error to user, just log it
            }
        }
        
        // RSS Feed Assignment Functions
        async function loadAvailableFeeds() {
            try {
                const response = await fetch('/api/v1/feeds/rss?active_only=true');
                const data = await response.json();
                availableFeeds = data.feeds || [];
            } catch (error) {
                console.error('Failed to load available feeds:', error);
                availableFeeds = [];
            }
        }
        
        async function loadAssignedFeeds() {
            if (editorMode !== 'edit' || !personaId) {
                renderAssignedFeeds();
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/feeds/personas/${personaId}/feeds`);
                if (response.ok) {
                    assignedFeeds = await response.json();
                }
            } catch (error) {
                console.error('Failed to load assigned feeds:', error);
                assignedFeeds = [];
            }
            
            renderAssignedFeeds();
        }
        
        function renderAssignedFeeds() {
            const container = document.getElementById('assigned-feeds-container');
            
            if (assignedFeeds.length === 0) {
                container.innerHTML = `
                    <p style="color: var(--text-secondary); font-size: 0.85rem; padding: 12px; background: var(--dark-card); border-radius: 8px;">
                        No RSS feeds assigned yet. Click "Assign RSS Feed" to add content sources.
                    </p>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            assignedFeeds.forEach((assignment, index) => {
                const card = document.createElement('div');
                card.className = 'feed-assignment-card';
                
                const topicsHtml = (assignment.topics || []).map(topic => 
                    `<span class="topic-tag">${topic}</span>`
                ).join('');
                
                const categoriesHtml = (assignment.feed_categories || []).map(cat => 
                    `<span class="category-tag" style="background: rgba(102, 126, 234, 0.3);">${cat}</span>`
                ).join('');
                
                card.innerHTML = `
                    <div class="feed-assignment-header">
                        <div class="feed-assignment-title">üì° ${assignment.feed_name || 'RSS Feed'}</div>
                        <button type="button" class="remove-btn" onclick="removeAssignedFeed(${index})">√ó</button>
                    </div>
                    <div class="feed-assignment-url">${assignment.feed_url || ''}</div>
                    ${categoriesHtml ? `<div style="margin-bottom: 8px;">${categoriesHtml}</div>` : ''}
                    ${topicsHtml ? `
                        <div>
                            <span style="font-size: 0.8rem; color: var(--text-secondary);">Filtered Topics:</span>
                            <div class="feed-topics">${topicsHtml}</div>
                        </div>
                    ` : ''}
                    <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-secondary);">
                        Priority: ${assignment.priority || 50}/100
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        function removeAssignedFeed(index) {
            assignedFeeds.splice(index, 1);
            renderAssignedFeeds();
        }
        
        async function showAssignFeedModal() {
            // Load available feeds if not already loaded
            if (availableFeeds.length === 0) {
                await loadAvailableFeeds();
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay show';
            modal.id = 'feed-assign-modal';
            
            const feedsListHtml = availableFeeds.map(feed => {
                const categoriesHtml = (feed.categories || []).map(cat => 
                    `<span class="category-chip">${cat}</span>`
                ).join('');
                
                return `
                    <div class="feed-select-item" onclick="selectFeedForAssignment('${feed.id}')">
                        <div class="feed-select-name">üì° ${feed.name}</div>
                        <div class="feed-select-url">${feed.url}</div>
                        ${categoriesHtml ? `<div class="category-chips">${categoriesHtml}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div class="modal-dialog">
                    <h2 class="modal-header">Assign RSS Feed</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Select Feed</label>
                        <div class="feed-select-list" id="feed-select-list">
                            ${feedsListHtml || '<p style="text-align: center; color: var(--text-secondary);">No RSS feeds available. Add feeds in the RSS page first.</p>'}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Filter by Topics (comma-separated, optional)</label>
                        <input type="text" class="form-input" id="feed-topics" placeholder="technology, AI, innovation">
                        <span class="form-help">Leave empty to use all content from the feed</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Priority (0-100)</label>
                        <input type="number" class="form-input" id="feed-priority" value="50" min="0" max="100">
                        <span class="form-help">Higher priority feeds are preferred for content suggestions</span>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeFeedAssignModal()">Cancel</button>
                        <button type="button" class="btn btn-primary" id="assign-feed-btn" onclick="assignSelectedFeed()" disabled>Assign Feed</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeFeedAssignModal();
            });
        }
        
        let selectedFeedForAssignment = null;
        
        function selectFeedForAssignment(feedId) {
            // Remove previous selection
            document.querySelectorAll('.feed-select-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Mark new selection
            const items = document.querySelectorAll('.feed-select-item');
            items.forEach(item => {
                if (item.onclick.toString().includes(feedId)) {
                    item.classList.add('selected');
                }
            });
            
            selectedFeedForAssignment = feedId;
            document.getElementById('assign-feed-btn').disabled = false;
        }
        
        function assignSelectedFeed() {
            if (!selectedFeedForAssignment) {
                alert('Please select a feed');
                return;
            }
            
            const feed = availableFeeds.find(f => f.id === selectedFeedForAssignment);
            if (!feed) {
                alert('Feed not found');
                return;
            }
            
            const topicsStr = document.getElementById('feed-topics').value.trim();
            const topics = topicsStr ? topicsStr.split(',').map(t => t.trim()).filter(t => t) : [];
            const priority = parseInt(document.getElementById('feed-priority').value) || 50;
            
            // Check if already assigned
            if (assignedFeeds.some(a => a.feed_id === feed.id)) {
                alert('This feed is already assigned to this persona');
                return;
            }
            
            // Add to assigned feeds
            assignedFeeds.push({
                feed_id: feed.id,
                feed_name: feed.name,
                feed_url: feed.url,
                feed_categories: feed.categories || [],
                topics: topics,
                priority: priority,
                is_active: true
            });
            
            renderAssignedFeeds();
            closeFeedAssignModal();
            showAlert('RSS feed assigned successfully!', 'success');
        }
        
        function closeFeedAssignModal() {
            const modal = document.getElementById('feed-assign-modal');
            if (modal) modal.remove();
            selectedFeedForAssignment = null;
        }
        
        // Form submission
        document.getElementById('persona-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            document.getElementById('submit-text').textContent = editorMode === 'create' ? 'Creating...' : 'Updating...';
            
            try {
                // Get optimism scale value (convert to int or null)
                const optimismValue = document.getElementById('optimism_cynicism_scale').value;
                const optimismInt = optimismValue ? parseInt(optimismValue, 10) : null;
                
                // Collect form data
                const formData = {
                    name: document.getElementById('name').value.trim(),
                    appearance: document.getElementById('appearance').value.trim(),
                    personality: document.getElementById('personality').value.trim(),
                    content_themes: themes,
                    style_preferences: stylePreferences,
                    default_content_rating: document.querySelector('input[name="default_content_rating"]:checked').value,
                    allowed_content_ratings: Array.from(document.querySelectorAll('input[name="allowed_ratings"]:checked')).map(cb => cb.value),
                    platform_restrictions: platformRestrictions,
                    base_appearance_description: document.getElementById('base_appearance_description').value.trim() || null,
                    appearance_locked: document.getElementById('appearance_locked').checked,
                    base_image_status: document.getElementById('base_image_status').value,
                    base_image_path: document.getElementById('base_image_path').value.trim() || null,
                    image_style: document.getElementById('image_style').value,
                    default_image_resolution: document.getElementById('default_image_resolution').value,
                    default_video_resolution: document.getElementById('default_video_resolution').value,
                    post_style: document.getElementById('post_style').value,
                    video_types: Array.from(document.querySelectorAll('input[name="video_types"]:checked')).map(cb => cb.value),
                    nsfw_model_preference: document.getElementById('nsfw_model_preference').value || null,
                    generation_quality: document.getElementById('generation_quality').value,
                    is_active: document.getElementById('is_active').checked,
                    
                    // ==================== PERSONA SOUL FIELDS ====================
                    // Origin & Demographics
                    hometown: document.getElementById('hometown').value.trim() || null,
                    current_location: document.getElementById('current_location').value.trim() || null,
                    generation_age: document.getElementById('generation_age').value.trim() || null,
                    education_level: document.getElementById('education_level').value.trim() || null,
                    
                    // Psychological Profile
                    mbti_type: document.getElementById('mbti_type').value || null,
                    enneagram_type: document.getElementById('enneagram_type').value || null,
                    political_alignment: document.getElementById('political_alignment').value.trim() || null,
                    risk_tolerance: document.getElementById('risk_tolerance').value.trim() || null,
                    optimism_cynicism_scale: optimismInt,
                    
                    // Voice & Speech Patterns
                    linguistic_register: document.getElementById('linguistic_register').value,
                    typing_quirks: typingQuirks,
                    signature_phrases: signaturePhrases,
                    trigger_topics: triggerTopics,
                    
                    // Backstory & Lore
                    day_job: document.getElementById('day_job').value.trim() || null,
                    war_story: document.getElementById('war_story').value.trim() || null,
                    vices_hobbies: vicesHobbies,
                    
                    // Anti-Pattern
                    forbidden_phrases: forbiddenPhrases,
                    warmth_level: document.getElementById('warmth_level').value,
                    patience_level: document.getElementById('patience_level').value
                };
                
                // Validate at least one allowed rating
                if (formData.allowed_content_ratings.length === 0) {
                    showAlert('Please select at least one allowed content rating.', 'error');
                    submitBtn.disabled = false;
                    document.getElementById('submit-text').textContent = editorMode === 'create' ? 'Create Persona' : 'Update Persona';
                    return;
                }
                
                // Make API request
                const url = editorMode === 'create' ? '/api/v1/personas/' : `/api/v1/personas/${personaId}`;
                const method = editorMode === 'create' ? 'POST' : 'PUT';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save persona');
                }
                
                const result = await response.json();
                const personaIdToUse = result.id;
                
                // If user selected a sample image, set it as base image (works for both create and edit)
                if (selectedImageData) {
                    try {
                        document.getElementById('submit-text').textContent = 'Setting base image...';
                        
                        const imageResponse = await fetch(`/api/v1/personas/${personaIdToUse}/set-base-image`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                image_data: selectedImageData
                            })
                        });
                        
                        if (!imageResponse.ok) {
                            console.error(`Failed to set base image, but persona was ${editorMode === 'create' ? 'created' : 'updated'}`);
                        } else {
                            console.log('Base image set successfully');
                        }
                    } catch (imageError) {
                        console.error('Failed to set base image:', imageError);
                        // Don't fail the whole operation if image setting fails
                    }
                }
                
                // Handle RSS feed assignments
                if (assignedFeeds.length > 0) {
                    try {
                        document.getElementById('submit-text').textContent = 'Assigning RSS feeds...';
                        
                        // When editing, we need to sync assignments (add new, remove old)
                        // For now, just assign all feeds (API will handle updates for existing ones)
                        for (const feed of assignedFeeds) {
                            try {
                                await fetch(`/api/v1/feeds/personas/${personaIdToUse}/feeds`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        feed_id: feed.feed_id,
                                        topics: feed.topics || [],
                                        priority: feed.priority || 50
                                    })
                                });
                            } catch (feedError) {
                                console.error('Failed to assign feed:', feedError);
                                // Continue with other feeds
                            }
                        }
                    } catch (error) {
                        console.error('Failed to assign RSS feeds:', error);
                        // Don't fail the whole operation
                    }
                }
                
                showAlert(`Persona ${editorMode === 'create' ? 'created' : 'updated'} successfully!`, 'success');
                
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = '/admin/personas';
                }, 1500);
                
            } catch (error) {
                console.error('Failed to save persona:', error);
                showAlert(error.message || 'Failed to save persona. Please try again.', 'error');
                submitBtn.disabled = false;
                document.getElementById('submit-text').textContent = editorMode === 'create' ? 'Create Persona' : 'Update Persona';
            }
        });
        
        // Delete persona
        async function deletePersona() {
            if (!confirm('Are you sure you want to delete this persona? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/personas/${personaId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete persona');
                }
                
                showAlert('Persona deleted successfully!', 'success');
                
                setTimeout(() => {
                    window.location.href = '/admin/personas';
                }, 1500);
                
            } catch (error) {
                console.error('Failed to delete persona:', error);
                showAlert('Failed to delete persona. Please try again.', 'error');
            }
        }
        
        // Theme input handler
        document.getElementById('theme-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = e.target;
                addTheme(input.value);
                input.value = '';
            }
        });
        
        // ==================== PERSONA SOUL FIELDS INPUT HANDLERS ====================
        
        // Signature Phrases input handler
        document.getElementById('signature-phrase-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = e.target;
                addSignaturePhrase(input.value);
                input.value = '';
            }
        });
        
        // Trigger Topics input handler
        document.getElementById('trigger-topic-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = e.target;
                addTriggerTopic(input.value);
                input.value = '';
            }
        });
        
        // Vices & Hobbies input handler
        document.getElementById('vices-hobbies-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = e.target;
                addViceHobby(input.value);
                input.value = '';
            }
        });
        
        // Forbidden Phrases input handler
        document.getElementById('forbidden-phrase-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = e.target;
                addForbiddenPhrase(input.value);
                input.value = '';
            }
        });
        
        // Optimism/Cynicism scale slider handler
        document.getElementById('optimism_cynicism_scale').addEventListener('input', (e) => {
            document.getElementById('optimism_value').textContent = e.target.value;
        });
        
        // Persona Chat Testing Functions
        let chatHistory = [];
        let isChatting = false;
        
        // Build conversation history for context window
        function buildConversationHistory() {
            // Convert chatHistory to the format expected by the API
            // Only include the last 10 messages for context
            const recentMessages = chatHistory.slice(-10);
            // Filter out image-only messages and only include text messages for context
            return recentMessages
                .filter(msg => msg.type !== 'image')  // Exclude image-only messages
                .map(msg => ({
                    role: msg.type === 'user' ? 'user' : 'persona',
                    content: msg.text,
                    timestamp: msg.timestamp
                }));
        }
        
        function showChatSection() {
            // Only show chat section in edit mode (when persona exists)
            if (editorMode === 'edit' && personaId) {
                document.getElementById('chat-testing-section').style.display = 'block';
            }
        }
        
        function handleChatKeydown(event) {
            // Send message on Enter (without Shift)
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || isChatting) return;
            
            if (!personaId) {
                showAlert('Please save the persona first before testing chat.', 'error');
                return;
            }
            
            isChatting = true;
            const sendBtn = document.getElementById('chat-send-btn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            
            // Update status
            const statusEl = document.getElementById('chat-status');
            const statusText = document.getElementById('chat-status-text');
            statusEl.classList.add('loading');
            statusText.textContent = 'Typing...';
            
            // Clear input
            input.value = '';
            
            // Hide empty state
            document.getElementById('chat-empty').style.display = 'none';
            
            // Add user message to chat
            addChatMessage(message, 'user');
            
            try {
                const response = await fetch(`/api/v1/personas/${personaId}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_history: buildConversationHistory()
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Chat request failed');
                }
                
                const data = await response.json();
                
                // Add persona response to chat
                addChatMessage(data.response, 'persona', data.persona_name, data.model_used);
                
                // If an image was generated, display it
                if (data.image_generated && data.image_data) {
                    addChatImage(data.image_data, data.persona_name, data.image_prompt);
                }
                
                // Update status
                statusEl.classList.remove('loading');
                const imageNote = data.image_generated ? ' + üì∏' : '';
                statusText.textContent = `Last model: ${data.model_used}${imageNote}`;
                
            } catch (error) {
                console.error('Chat error:', error);
                addChatMessage(`Error: ${error.message}`, 'persona', 'System', 'error');
                
                // Update status
                statusEl.classList.remove('loading');
                statusText.textContent = 'Error occurred - try again';
                
                showAlert(`Chat error: ${error.message}`, 'error');
            } finally {
                isChatting = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
                input.focus();
            }
        }
        
        function addChatMessage(text, type, senderName = null, modelInfo = null) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            let html = '';
            
            if (type === 'persona' && senderName) {
                html += `<div class="sender">${senderName}</div>`;
            } else if (type === 'user') {
                html += `<div class="sender">You</div>`;
            }
            
            html += `<div class="content">${escapeHtml(text)}</div>`;
            
            if (modelInfo && type === 'persona') {
                html += `<div class="model-info">via ${modelInfo}</div>`;
            }
            
            messageDiv.innerHTML = html;
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Store in history
            chatHistory.push({
                type: type,
                text: text,
                sender: senderName,
                model: modelInfo,
                timestamp: new Date().toISOString()
            });
        }
        
        function addChatImage(imageData, senderName, imagePrompt = null) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message persona';
            
            let html = `<div class="sender">${senderName} üì∏</div>`;
            html += `<div class="content">`;
            html += `<img src="${imageData}" alt="Generated image" style="max-width: 100%; border-radius: 8px; margin: 8px 0;" />`;
            if (imagePrompt) {
                // Safely truncate prompt to ~100 chars without cutting multi-byte characters
                const truncatedPrompt = imagePrompt.length > 100 
                    ? [...imagePrompt].slice(0, 100).join('') + '...'
                    : imagePrompt;
                html += `<div class="image-prompt" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px; font-style: italic;">Prompt: ${escapeHtml(truncatedPrompt)}</div>`;
            }
            html += `</div>`;
            
            messageDiv.innerHTML = html;
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Store image in history as special message
            chatHistory.push({
                type: 'image',
                text: '[Image]',
                sender: senderName,
                imageData: imageData,
                imagePrompt: imagePrompt,
                timestamp: new Date().toISOString()
            });
        }
        
        function escapeHtml(text) {
            // First escape the HTML entities
            const div = document.createElement('div');
            div.textContent = text;
            const escaped = div.innerHTML;
            // Then convert newlines to <br> tags (safe since input was escaped)
            return escaped.split('\n').map(line => {
                // Each line is already escaped, join with <br>
                return line;
            }).join('<br>');
        }
        
        function clearChatHistory() {
            chatHistory = [];
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="chat-empty-state" id="chat-empty">
                    <div class="icon">üí¨</div>
                    <div>Start a conversation with your persona</div>
                    <div style="font-size: 0.8rem; margin-top: 8px;">
                        Type a message below to see how they respond
                    </div>
                </div>
            `;
            
            // Reset status
            const statusEl = document.getElementById('chat-status');
            const statusText = document.getElementById('chat-status-text');
            statusEl.classList.remove('loading');
            statusText.textContent = 'Ready to chat';
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadBranding();
            parseUrlParams();
            loadPersonaData();
            loadAvailableFeeds(); // Load available feeds for assignment
            
            // If creating new persona, initialize empty assigned feeds
            if (editorMode === 'create') {
                renderAssignedFeeds();
            }
            
            // Show chat section after a short delay (after persona loads)
            setTimeout(() => {
                showChatSection();
            }, 500);
        });
    </script>
</body>
</html>
