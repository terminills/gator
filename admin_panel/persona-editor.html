<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persona Editor - Gator Admin</title>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --accent: #10b981;
            --danger: #ef4444;
            --dark-bg: #0f0f1e;
            --dark-surface: #1a1a2e;
            --dark-card: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --sidebar-width: 260px;
            --border-color: #2a2a3e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--dark-surface);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .logo-icon {
            font-size: 2rem;
        }
        
        .tenant-selector {
            margin-top: 16px;
            padding: 12px;
            background: var(--dark-card);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tenant-selector:hover {
            border-color: var(--primary);
        }
        
        .tenant-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        
        .tenant-plan {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .nav-section {
            padding: 20px 16px 8px;
        }
        
        .nav-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 8px;
            padding: 0 12px;
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            margin-bottom: 4px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .nav-link:hover {
            background: var(--dark-card);
            color: var(--text-primary);
        }
        
        .nav-link.active {
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            color: white;
            font-weight: 600;
        }
        
        .nav-icon {
            font-size: 1.3rem;
            width: 24px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
        }
        
        .topbar {
            height: 70px;
            background: var(--dark-surface);
            border-bottom: 1px solid var(--border-color);
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .topbar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .back-btn {
            padding: 8px 16px;
            background: var(--dark-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            border-color: var(--primary);
        }
        
        .topbar-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .content-area {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }
        
        .form-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .section {
            background: var(--dark-surface);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .form-label .required {
            color: var(--danger);
        }
        
        .form-help {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--dark-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea.form-input {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }
        
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            background: var(--dark-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-height: 46px;
        }
        
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--primary);
            color: white;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
        }
        
        .tag-remove:hover {
            opacity: 1;
        }
        
        .tag-input {
            flex: 1;
            min-width: 150px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            padding: 6px;
            outline: none;
        }
        
        .key-value-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .key-value-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .key-value-row input {
            flex: 1;
        }
        
        .remove-btn {
            padding: 10px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .remove-btn:hover {
            background: #dc2626;
        }
        
        .add-btn {
            padding: 10px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .add-btn:hover {
            background: #059669;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            background: var(--dark-card);
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .checkbox-label:hover {
            background: var(--dark-surface);
        }
        
        .checkbox-label input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .radio-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 16px;
            background: var(--dark-card);
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .radio-label:hover {
            background: var(--dark-surface);
        }
        
        .radio-label input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--dark-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            border-color: var(--primary);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .image-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .image-upload-area:hover {
            border-color: var(--primary);
            background: var(--dark-card);
        }
        
        .image-preview {
            max-width: 300px;
            max-height: 300px;
            margin: 16px auto;
            border-radius: 8px;
            display: none;
        }
        
        .image-preview.show {
            display: block;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: var(--accent);
            color: white;
        }
        
        .badge-warning {
            background: #f59e0b;
            color: white;
        }
        
        .badge-info {
            background: var(--primary);
            color: white;
        }
        
        /* Sample Image Gallery */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 20px;
        }
        
        .image-card {
            background: var(--dark-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .image-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .image-card.selected {
            border-color: var(--accent);
            border-width: 3px;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        .image-card img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }
        
        .image-card-label {
            text-align: center;
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .image-card.selected .image-card-label {
            color: var(--accent);
            font-weight: 600;
        }
        
        .selected-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--accent);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: none;
        }
        
        .image-card.selected .selected-badge {
            display: block;
        }
        
        .generate-images-section {
            background: var(--dark-card);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .generate-images-section h3 {
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        
        .generate-images-section p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        .btn-generate {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-generate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-generate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .generation-progress {
            margin-top: 20px;
            display: none;
        }
        
        .generation-progress.show {
            display: block;
        }
        
        .progress-text {
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: var(--dark-surface);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.3s;
        }
        
        .feed-assignment-card {
            background: var(--dark-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .feed-assignment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .feed-assignment-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
        }
        
        .feed-assignment-url {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .feed-topics {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .topic-tag {
            display: inline-block;
            padding: 4px 10px;
            background: var(--accent);
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-dialog {
            background: var(--dark-surface);
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            border: 1px solid var(--border-color);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 1.3rem;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .feed-select-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            background: var(--dark-card);
            margin-bottom: 16px;
        }
        
        .feed-select-item {
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }
        
        .feed-select-item:hover {
            background: var(--dark-surface);
        }
        
        .feed-select-item.selected {
            background: var(--primary);
            color: white;
        }
        
        .feed-select-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .feed-select-url {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .category-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }
        
        .category-chip {
            display: inline-block;
            padding: 3px 8px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            font-size: 0.7rem;
        }
        
        /* Persona Chat Testing Styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--dark-card);
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .chat-message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .chat-message.user {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.persona {
            align-self: flex-start;
            background: var(--dark-surface);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .chat-message .sender {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }
        
        .chat-message.persona .sender {
            color: var(--accent);
        }
        
        .chat-message .model-info {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 6px;
        }
        
        .chat-input-area {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-top: 1px solid var(--border-color);
            background: var(--dark-surface);
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--dark-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: none;
            min-height: 44px;
            max-height: 100px;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .chat-send-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .chat-send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .chat-empty-state {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px 20px;
        }
        
        .chat-empty-state .icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }
        
        .chat-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--dark-surface);
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        
        .chat-status.loading {
            color: var(--primary);
        }
        
        .chat-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
        }
        
        .chat-status.loading .dot {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Trigger Card Styles */
        .trigger-card {
            background: var(--dark-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.2s;
        }
        
        .trigger-card:hover {
            border-color: var(--primary);
        }
        
        .trigger-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .trigger-card-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .trigger-card-title input {
            font-size: 1.1rem;
            font-weight: 600;
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            width: 200px;
        }
        
        .trigger-card-title input:focus {
            outline: none;
            background: var(--dark-surface);
        }
        
        .trigger-card-actions {
            display: flex;
            gap: 8px;
        }
        
        .trigger-card-body {
            display: grid;
            gap: 16px;
        }
        
        .trigger-section {
            padding: 16px;
            background: var(--dark-surface);
            border-radius: 8px;
        }
        
        .trigger-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .lora-row {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 8px;
            background: var(--dark-card);
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .lora-row input[type="text"] {
            flex: 2;
        }
        
        .lora-row input[type="range"] {
            flex: 1;
            min-width: 100px;
        }
        
        .weight-display {
            min-width: 50px;
            text-align: center;
            font-family: monospace;
            color: var(--accent);
        }
        
        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .category-select {
            padding: 6px 12px;
            background: var(--dark-surface);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        
        .trigger-toggle {
            position: relative;
            width: 48px;
            height: 24px;
        }
        
        .trigger-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .trigger-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: .3s;
            border-radius: 24px;
        }
        
        .trigger-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        .trigger-toggle input:checked + .trigger-toggle-slider {
            background-color: var(--accent);
        }
        
        .trigger-toggle input:checked + .trigger-toggle-slider:before {
            transform: translateX(24px);
        }
        
        .collapsible-trigger {
            cursor: pointer;
            user-select: none;
        }
        
        .collapsible-content {
            display: none;
        }
        
        .collapsible-content.show {
            display: block;
        }
        
        .collapse-icon {
            transition: transform 0.2s;
        }
        
        .collapsible-trigger.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <span class="logo-icon" id="brand-icon">üêä</span>
                <span id="brand-name">Platform</span>
            </div>
            
            <div class="tenant-selector" onclick="switchTenant()">
                <div class="tenant-name" id="tenant-name">My Instance</div>
                <div class="tenant-plan"><span id="tenant-plan-text">Self-Hosted</span> ‚Ä¢ GPU Enabled</div>
            </div>
        </div>
        
        <nav class="nav-section">
            <div class="nav-section-title">Main</div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/admin" class="nav-link">
                        <span class="nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/personas" class="nav-link active">
                        <span class="nav-icon">üé≠</span>
                        <span>Personas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/content" class="nav-link">
                        <span class="nav-icon">üé®</span>
                        <span>Content</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <nav class="nav-section">
            <div class="nav-section-title">Resources</div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/ai-models-setup" class="nav-link">
                        <span class="nav-icon">ü§ñ</span>
                        <span>Models</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/rss" class="nav-link">
                        <span class="nav-icon">üì°</span>
                        <span>RSS Feeds</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <nav class="nav-section">
            <div class="nav-section-title">Insights</div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/admin/analytics" class="nav-link">
                        <span class="nav-icon">üìà</span>
                        <span>Analytics</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/diagnostics" class="nav-link">
                        <span class="nav-icon">ü§ñ</span>
                        <span>Diagnostics</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/gallery" class="nav-link">
                        <span class="nav-icon">üåê</span>
                        <span>Public View</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <nav class="nav-section" style="margin-top: auto;">
            <div class="nav-section-title">System</div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/admin/system-monitoring" class="nav-link">
                        <span class="nav-icon">üå°Ô∏è</span>
                        <span>System Monitor</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/settings" class="nav-link">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span>Settings</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/docs" class="nav-link">
                        <span class="nav-icon">üìö</span>
                        <span>API Docs</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="topbar">
            <div class="topbar-left">
                <a href="/admin/personas" class="back-btn">
                    ‚Üê Back to Personas
                </a>
                <h1 class="page-title" id="page-title">Create Persona</h1>
            </div>
            
            <div class="topbar-right">
                <span id="status-badge"></span>
            </div>
        </div>
        
        <div class="content-area">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Loading persona data...</p>
            </div>
            
            <div class="form-container" id="form-container" style="display: none;">
                <div id="alert-container"></div>
                
                <!-- AI Auto-Fill Section -->
                <div class="section" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(16, 185, 129, 0.1)); border-color: var(--primary);">
                    <div class="section-header">
                        <h2 class="section-title">
                            <span>‚ú®</span>
                            AI Auto-Fill
                        </h2>
                    </div>
                    <p class="section-description">Use AI to automatically generate all persona fields. You can then review and edit the results.</p>
                    
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end;">
                        <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
                            <label class="form-label">Persona Type (Optional)</label>
                            <input type="text" class="form-input" id="ai-persona-type" placeholder="e.g., fitness, tech, lifestyle, gaming...">
                        </div>
                        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                            <label class="form-label">Content Rating</label>
                            <select class="form-input" id="ai-content-rating">
                                <option value="sfw">SFW (Safe)</option>
                                <option value="moderate">Moderate</option>
                                <option value="nsfw">NSFW (Adult)</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-primary" id="ai-autofill-btn" onclick="aiAutoFillFields()" style="height: fit-content; display: flex; align-items: center; gap: 8px;">
                            <span id="ai-autofill-icon">‚ú®</span>
                            <span id="ai-autofill-text">AI Auto-Fill All Fields</span>
                        </button>
                    </div>
                    <p style="margin-top: 12px; font-size: 0.8rem; color: var(--text-secondary);">
                        üí° Requires Ollama running locally with dolphin-mixtral or similar model. 
                        The AI will generate name, appearance, personality, content themes, physical details, and soul fields.
                    </p>
                </div>
                
                <form id="persona-form">
                    <!-- Basic Information -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üìù</span>
                                Basic Information
                            </h2>
                        </div>
                        <p class="section-description">Core details that define your persona's identity.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Name <span class="required">*</span>
                            </label>
                            <span class="form-help">The display name for your persona (2-100 characters)</span>
                            <input type="text" class="form-input" id="name" name="name" required minlength="2" maxlength="100" placeholder="e.g., Tech Innovator Sarah">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Personality <span class="required">*</span>
                            </label>
                            <span class="form-help">Personality traits and characteristics (10-2000 characters)</span>
                            <textarea class="form-input" id="personality" name="personality" required minlength="10" maxlength="2000" placeholder="Innovative, analytical, forward-thinking tech leader. Passionate about AI and emerging technologies. Clear communicator who makes complex topics accessible."></textarea>
                        </div>
                    </div>
                    
                    <!-- Physical Appearance Details -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üë§</span>
                                Physical Appearance
                            </h2>
                        </div>
                        <p class="section-description">Define the physical characteristics of your persona for consistent image generation.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                General Appearance <span class="required">*</span>
                            </label>
                            <span class="form-help">Overall physical appearance description for image creation (10-2000 characters)</span>
                            <textarea class="form-input" id="appearance" name="appearance" required minlength="10" maxlength="2000" placeholder="Professional woman in her 30s with short dark hair, wearing modern business attire. Confident posture and intelligent eyes behind stylish glasses."></textarea>
                        </div>
                        
                        <!-- Two column grid for appearance fields -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Sex</label>
                                <select class="form-input" id="sex" name="sex">
                                    <option value="">Select...</option>
                                    <option value="female">Female</option>
                                    <option value="male">Male</option>
                                    <option value="non-binary">Non-Binary</option>
                                    <option value="trans_female">Trans Female</option>
                                    <option value="trans_male">Trans Male</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Age Appearance</label>
                                <select class="form-input" id="age_appearance" name="age_appearance">
                                    <option value="">Select...</option>
                                    <option value="late_teens">Late Teens (18-19)</option>
                                    <option value="early_20s">Early 20s</option>
                                    <option value="mid_20s">Mid 20s</option>
                                    <option value="late_20s">Late 20s</option>
                                    <option value="early_30s">Early 30s</option>
                                    <option value="mid_30s">Mid 30s</option>
                                    <option value="late_30s">Late 30s</option>
                                    <option value="40s">40s</option>
                                    <option value="50s">50s</option>
                                    <option value="mature">Mature (60+)</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Ethnicity</label>
                                <select class="form-input" id="ethnicity" name="ethnicity">
                                    <option value="">Select...</option>
                                    <option value="caucasian">Caucasian/White</option>
                                    <option value="asian">Asian</option>
                                    <option value="east_asian">East Asian</option>
                                    <option value="south_asian">South Asian</option>
                                    <option value="latina">Latina/Hispanic</option>
                                    <option value="african_american">African American/Black</option>
                                    <option value="middle_eastern">Middle Eastern</option>
                                    <option value="mixed">Mixed/Multiracial</option>
                                    <option value="pacific_islander">Pacific Islander</option>
                                    <option value="native_american">Native American</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Skin Tone</label>
                                <select class="form-input" id="skin_tone" name="skin_tone">
                                    <option value="">Select...</option>
                                    <option value="very_fair">Very Fair/Porcelain</option>
                                    <option value="fair">Fair</option>
                                    <option value="light">Light</option>
                                    <option value="medium">Medium</option>
                                    <option value="olive">Olive</option>
                                    <option value="tan">Tan</option>
                                    <option value="brown">Brown</option>
                                    <option value="dark_brown">Dark Brown</option>
                                    <option value="deep">Deep/Dark</option>
                                </select>
                            </div>
                        </div>
                        
                        <h4 style="margin: 24px 0 16px; color: var(--text-primary); font-size: 1rem;">üíá Hair</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Hair Color</label>
                                <select class="form-input" id="hair_color" name="hair_color">
                                    <option value="">Select...</option>
                                    <option value="blonde">Blonde</option>
                                    <option value="dirty_blonde">Dirty Blonde</option>
                                    <option value="brunette">Brunette</option>
                                    <option value="light_brown">Light Brown</option>
                                    <option value="dark_brown">Dark Brown</option>
                                    <option value="black">Black</option>
                                    <option value="red">Red/Ginger</option>
                                    <option value="auburn">Auburn</option>
                                    <option value="gray">Gray/Silver</option>
                                    <option value="white">White/Platinum</option>
                                    <option value="pink">Pink</option>
                                    <option value="blue">Blue</option>
                                    <option value="purple">Purple</option>
                                    <option value="green">Green</option>
                                    <option value="rainbow">Rainbow/Multi-colored</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Hair Style</label>
                                <input type="text" class="form-input" id="hair_style" name="hair_style" placeholder="e.g., long and wavy, short bob, ponytail">
                            </div>
                        </div>
                        
                        <h4 style="margin: 24px 0 16px; color: var(--text-primary); font-size: 1rem;">üëÅÔ∏è Eyes</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Eye Color</label>
                                <select class="form-input" id="eye_color" name="eye_color">
                                    <option value="">Select...</option>
                                    <option value="blue">Blue</option>
                                    <option value="light_blue">Light Blue</option>
                                    <option value="green">Green</option>
                                    <option value="hazel">Hazel</option>
                                    <option value="brown">Brown</option>
                                    <option value="dark_brown">Dark Brown</option>
                                    <option value="amber">Amber</option>
                                    <option value="gray">Gray</option>
                                    <option value="heterochromia">Heterochromia</option>
                                </select>
                            </div>
                        </div>
                        
                        <h4 style="margin: 24px 0 16px; color: var(--text-primary); font-size: 1rem;">üìè Body</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Height</label>
                                <input type="text" class="form-input" id="height" name="height" placeholder='e.g., 5&apos;6", 170cm, tall, petite'>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Weight</label>
                                <input type="text" class="form-input" id="weight" name="weight" placeholder="e.g., 130lbs, 60kg, athletic">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Build Type</label>
                                <select class="form-input" id="build_type" name="build_type">
                                    <option value="">Select...</option>
                                    <option value="petite">Petite</option>
                                    <option value="slim">Slim</option>
                                    <option value="lean">Lean</option>
                                    <option value="average">Average</option>
                                    <option value="athletic">Athletic</option>
                                    <option value="toned">Toned</option>
                                    <option value="curvy">Curvy</option>
                                    <option value="hourglass">Hourglass</option>
                                    <option value="muscular">Muscular</option>
                                    <option value="plus_size">Plus Size</option>
                                    <option value="thick">Thick</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Muscle Tone</label>
                                <select class="form-input" id="muscle_tone" name="muscle_tone">
                                    <option value="">Select...</option>
                                    <option value="soft">Soft</option>
                                    <option value="average">Average</option>
                                    <option value="toned">Toned</option>
                                    <option value="athletic">Athletic</option>
                                    <option value="fit">Fit</option>
                                    <option value="muscular">Muscular</option>
                                    <option value="very_muscular">Very Muscular</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Measurements</label>
                                <input type="text" class="form-input" id="measurements" name="measurements" placeholder="e.g., 34-24-36">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Cup Size</label>
                                <select class="form-input" id="cup_size" name="cup_size">
                                    <option value="">Select...</option>
                                    <option value="AA">AA</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                    <option value="DD">DD/E</option>
                                    <option value="DDD">DDD/F</option>
                                    <option value="G">G</option>
                                    <option value="H">H+</option>
                                </select>
                            </div>
                        </div>
                        
                        <h4 style="margin: 24px 0 16px; color: var(--text-primary); font-size: 1rem;">‚ú® Distinctive Features</h4>
                        <div class="form-group">
                            <label class="form-label">Distinctive Features</label>
                            <span class="form-help">Unique physical features like moles, dimples, freckles, etc.</span>
                            <textarea class="form-input" id="distinctive_features" name="distinctive_features" style="min-height: 80px;" placeholder="e.g., small mole on left cheek, dimples when smiling, light freckles across nose"></textarea>
                        </div>
                        
                        <h4 style="margin: 24px 0 16px; color: var(--text-primary); font-size: 1rem;">üé® Body Modifications</h4>
                        <div class="form-group">
                            <label class="form-label">Body Modifications</label>
                            <span class="form-help">Tattoos, piercings, and other modifications. Press Enter to add.</span>
                            <div class="tag-input-container" id="body-modifications-container">
                                <input type="text" class="tag-input" id="body-modification-input" placeholder="e.g., nose piercing, sleeve tattoo...">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sexuality & Preferences (NSFW) -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üíã</span>
                                Sexuality & Preferences
                            </h2>
                        </div>
                        <p class="section-description">Define sexuality and preferences for NSFW content generation. These fields help create more authentic and consistent adult content.</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Sexual Orientation</label>
                                <select class="form-input" id="sexual_orientation" name="sexual_orientation">
                                    <option value="">Select...</option>
                                    <option value="straight">Straight/Heterosexual</option>
                                    <option value="bisexual">Bisexual</option>
                                    <option value="bicurious">Bicurious</option>
                                    <option value="lesbian">Lesbian</option>
                                    <option value="gay">Gay</option>
                                    <option value="pansexual">Pansexual</option>
                                    <option value="asexual">Asexual</option>
                                    <option value="demisexual">Demisexual</option>
                                    <option value="fluid">Sexually Fluid</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 16px;">
                            <label class="form-label">Turn Ons</label>
                            <span class="form-help">Things that excite this persona (for NSFW content). Press Enter to add.</span>
                            <div class="tag-input-container" id="turn-ons-container">
                                <input type="text" class="tag-input" id="turn-on-input" placeholder="e.g., confidence, humor, intelligence...">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Turn Offs</label>
                            <span class="form-help">Boundaries and things to avoid (for content filtering). Press Enter to add.</span>
                            <div class="tag-input-container" id="turn-offs-container">
                                <input type="text" class="tag-input" id="turn-off-input" placeholder="e.g., rudeness, arrogance...">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Configuration -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üé®</span>
                                Content Configuration
                            </h2>
                        </div>
                        <p class="section-description">Define content themes and style preferences for your persona.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Content Themes
                            </label>
                            <span class="form-help">Topics this persona specializes in (max 10). Press Enter to add.</span>
                            <div class="tag-input-container" id="themes-container">
                                <input type="text" class="tag-input" id="theme-input" placeholder="Type a theme and press Enter...">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Style Preferences
                            </label>
                            <span class="form-help">Visual style and aesthetic preferences (key-value pairs)</span>
                            <div class="key-value-container" id="style-container">
                                <!-- Will be populated dynamically -->
                            </div>
                            <button type="button" class="add-btn" onclick="addStylePreference()">
                                + Add Style Preference
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content Rating & Platform Settings -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üîí</span>
                                Content Rating & Platform Settings
                            </h2>
                        </div>
                        <p class="section-description">Control content ratings and platform-specific restrictions.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Default Content Rating <span class="required">*</span>
                            </label>
                            <span class="form-help">The default content rating for created content</span>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="default_content_rating" value="sfw" checked>
                                    <span>SFW (Safe for Work)</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="default_content_rating" value="moderate">
                                    <span>Moderate</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="default_content_rating" value="nsfw">
                                    <span>NSFW (Not Safe for Work)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Allowed Content Ratings <span class="required">*</span>
                            </label>
                            <span class="form-help">Content ratings this persona is allowed to create</span>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="allowed_ratings" value="sfw" checked>
                                    <span>SFW (Safe for Work)</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="allowed_ratings" value="moderate">
                                    <span>Moderate</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="allowed_ratings" value="nsfw">
                                    <span>NSFW (Not Safe for Work)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Platform Restrictions
                            </label>
                            <span class="form-help">Platform-specific content restrictions (e.g., instagram: sfw_only)</span>
                            <div class="key-value-container" id="platform-container">
                                <!-- Will be populated dynamically -->
                            </div>
                            <button type="button" class="add-btn" onclick="addPlatformRestriction()">
                                + Add Platform Restriction
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content Generation Preferences -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>‚öôÔ∏è</span>
                                Content Generation Preferences
                            </h2>
                        </div>
                        <p class="section-description">Configure default settings for content generation including resolution, quality, and model preferences.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Default Image Resolution
                            </label>
                            <span class="form-help">Default resolution for image generation</span>
                            <select class="form-input" id="default_image_resolution" name="default_image_resolution">
                                <option value="512x512">512x512 (Square - Draft)</option>
                                <option value="1024x1024" selected>1024x1024 (Square - HD)</option>
                                <option value="2048x2048">2048x2048 (Square - Ultra HD)</option>
                                <option value="720x1280">720x1280 (Portrait 720p)</option>
                                <option value="1080x1920">1080x1920 (Portrait 1080p)</option>
                                <option value="1280x720">1280x720 (Landscape 720p)</option>
                                <option value="1920x1080">1920x1080 (Landscape 1080p)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Default Video Resolution
                            </label>
                            <span class="form-help">Default resolution for video generation</span>
                            <select class="form-input" id="default_video_resolution" name="default_video_resolution">
                                <option value="1280x720">1280x720 (720p HD)</option>
                                <option value="1920x1080" selected>1920x1080 (1080p Full HD)</option>
                                <option value="2560x1440">2560x1440 (1440p 2K)</option>
                                <option value="3840x2160">3840x2160 (2160p 4K)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Generation Quality
                            </label>
                            <span class="form-help">Default quality level for content generation</span>
                            <select class="form-input" id="generation_quality" name="generation_quality">
                                <option value="draft">Draft (Fast, lower quality)</option>
                                <option value="standard" selected>Standard (Balanced)</option>
                                <option value="hd">HD (High detail)</option>
                                <option value="premium">Premium (Best quality, slower)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Post Style
                            </label>
                            <span class="form-help">Default style for content posts</span>
                            <select class="form-input" id="post_style" name="post_style">
                                <option value="casual" selected>Casual</option>
                                <option value="professional">Professional</option>
                                <option value="artistic">Artistic</option>
                                <option value="provocative">Provocative</option>
                                <option value="playful">Playful</option>
                                <option value="elegant">Elegant</option>
                                <option value="edgy">Edgy</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Video Types
                            </label>
                            <span class="form-help">Preferred types of video content</span>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="video_types" value="short_clip">
                                    <span>Short Clip (15-30s)</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="video_types" value="story">
                                    <span>Story (Instagram/Snapchat style)</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="video_types" value="reel">
                                    <span>Reel (TikTok/Instagram Reel)</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="video_types" value="long_form">
                                    <span>Long Form (YouTube/extended)</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="video_types" value="tutorial">
                                    <span>Tutorial/How-to</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                NSFW Model Preference
                            </label>
                            <span class="form-help">Preferred NSFW model (only used when content rating is NSFW)</span>
                            <select class="form-input" id="nsfw_model_preference" name="nsfw_model_preference">
                                <option value="">None (Use default)</option>
                                <!-- Will be populated dynamically from installed models -->
                            </select>
                        </div>
                    </div>
                    
                    <!-- AI Model Preferences Per Generation Type -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>ü§ñ</span>
                                AI Model Preferences
                            </h2>
                        </div>
                        <p class="section-description">Select default AI models for each content generation type from your installed models. This allows fine-grained testing of different models per persona.</p>
                        
                        <div id="models-loading-indicator" style="padding: 16px; text-align: center; color: var(--text-secondary);">
                            <span>üîÑ Loading installed models...</span>
                        </div>
                        
                        <div id="models-grid" style="display: none; display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">
                                    üìù Text/Chat Model
                                </label>
                                <span class="form-help">Model for text generation, chat responses, and captions</span>
                                <select class="form-input" id="text_model_preference" name="text_model_preference">
                                    <option value="">Use System Default</option>
                                    <!-- Populated dynamically from installed models -->
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">
                                    üé® Image Generation Model
                                </label>
                                <span class="form-help">Model for generating images and visual content</span>
                                <select class="form-input" id="image_model_preference" name="image_model_preference">
                                    <option value="">Use System Default</option>
                                    <!-- Populated dynamically from installed models -->
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">
                                    üé¨ Video Generation Model
                                </label>
                                <span class="form-help">Model for generating video content</span>
                                <select class="form-input" id="video_model_preference" name="video_model_preference">
                                    <option value="">Use System Default</option>
                                    <!-- Populated dynamically from installed models -->
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">
                                    üîä Voice/TTS Model
                                </label>
                                <span class="form-help">Model for voice synthesis and text-to-speech</span>
                                <select class="form-input" id="voice_model_preference" name="voice_model_preference">
                                    <option value="">Use System Default</option>
                                    <!-- Populated dynamically from installed models -->
                                </select>
                            </div>
                        </div>
                        
                        <div id="models-error" style="display: none; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; color: #ef4444; margin-top: 16px;">
                            <strong>‚ö†Ô∏è Could not load installed models.</strong> Using manual input instead.
                        </div>
                        
                        <div style="margin-top: 16px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 0.85rem;">
                            <strong>üí° Model Selection Tips:</strong>
                            <ul style="margin: 8px 0 0 20px; color: var(--text-secondary);">
                                <li><strong>Text Models:</strong> Dolphin variants are uncensored for NSFW personas. Use Qwen for coding tasks.</li>
                                <li><strong>Image Models:</strong> FLUX.1 is best for realism, Pony Diffusion for anime style.</li>
                                <li><strong>Video Models:</strong> AnimateDiff works with existing image models, SVD for longer clips.</li>
                                <li><strong>Voice Models:</strong> XTTS-v2 supports voice cloning, ElevenLabs for best quality.</li>
                            </ul>
                            <p style="margin-top: 8px; font-size: 0.8rem; color: var(--text-secondary);">
                                <a href="/ai-models-setup" style="color: var(--accent-color);">‚Üí Manage installed models</a>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Trigger-Based Model Orchestration -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üéØ</span>
                                Trigger-Based Model Orchestration
                            </h2>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" class="btn btn-secondary" onclick="exportTriggerTemplate()" style="font-size: 0.85rem; padding: 8px 16px;" title="Export triggers and model preferences as a template">
                                    üì§ Export
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="importTriggerTemplate()" style="font-size: 0.85rem; padding: 8px 16px;" title="Import triggers from a template file">
                                    üì• Import
                                </button>
                                <button type="button" class="btn btn-primary" onclick="addContentTrigger()" style="font-size: 0.85rem; padding: 8px 16px;">
                                    + Add Trigger
                                </button>
                            </div>
                        </div>
                        <p class="section-description">
                            Configure trigger words that route to specific models and LoRAs. When a trigger phrase is detected in chat or content requests, 
                            the system automatically selects the optimal model, applies LoRA weights, and injects positive/negative prompts.
                            This enables fine-grained model selection for different poses, views, styles, and content types.
                        </p>
                        
                        <div style="margin-bottom: 16px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 0.85rem;">
                            <strong>üí° Trigger Categories:</strong>
                            <ul style="margin: 8px 0 0 20px; color: var(--text-secondary); display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px;">
                                <li><strong>Pose:</strong> selfie, full body</li>
                                <li><strong>View:</strong> front, side, rear</li>
                                <li><strong>Style:</strong> bikini, lingerie</li>
                                <li><strong>Platform:</strong> instagram, tiktok</li>
                                <li><strong>Anatomy:</strong> face detail, hands</li>
                                <li><strong>Lighting:</strong> natural, studio</li>
                                <li><strong>Mood:</strong> happy, seductive</li>
                                <li><strong>Location:</strong> beach, bedroom</li>
                                <li><strong>Action:</strong> sitting, walking</li>
                            </ul>
                        </div>
                        
                        <div id="content-triggers-container">
                            <!-- Triggers will be rendered here -->
                            <div id="triggers-empty-state" class="empty-state" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                                <span style="font-size: 2rem;">üéØ</span>
                                <h3 style="margin-top: 12px; color: var(--text-primary);">No Triggers Configured</h3>
                                <p style="margin-top: 8px;">Add triggers to route specific keywords to different models and LoRAs.</p>
                                <button type="button" class="btn btn-secondary" onclick="addContentTrigger()" style="margin-top: 16px;">
                                    + Add Your First Trigger
                                </button>
                            </div>
                        </div>
                        
                        <div id="triggers-list" style="display: none;">
                            <!-- Trigger cards will be dynamically added here -->
                        </div>
                        
                        <!-- Default Prompts -->
                        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 16px; color: var(--text-primary);">üìù Default Prompts (Applied to All Generations)</h4>
                            
                            <div class="form-group">
                                <label class="form-label">Default Positive Prompt</label>
                                <span class="form-help">Additional positive prompt elements added to all image generations</span>
                                <textarea class="form-input" id="default_positive_prompt" name="default_positive_prompt" style="min-height: 80px;" placeholder="high quality, detailed, professional photography, sharp focus"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Default Negative Prompt</label>
                                <span class="form-help">Negative prompt elements to exclude from all image generations</span>
                                <textarea class="form-input" id="default_negative_prompt" name="default_negative_prompt" style="min-height: 80px;" placeholder="ugly, deformed, bad anatomy, blurry, low quality, watermark, text"></textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="checkbox-label" style="background: var(--dark-card); padding: 12px; border-radius: 8px;">
                                        <input type="checkbox" id="enable_auto_lora_selection" name="enable_auto_lora_selection" checked>
                                        <span>Enable Auto LoRA Selection</span>
                                    </label>
                                    <span class="form-help" style="margin-top: 4px;">Automatically select LoRAs based on detected attributes (hair, style, etc.)</span>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="checkbox-label" style="background: var(--dark-card); padding: 12px; border-radius: 8px;">
                                        <input type="checkbox" id="enable_multi_model_routing" name="enable_multi_model_routing" checked>
                                        <span>Enable Multi-Model Routing</span>
                                    </label>
                                    <span class="form-help" style="margin-top: 4px;">Route to different models based on view/pose requirements</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Appearance & Visual Consistency -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üñºÔ∏è</span>
                                Base Images & Visual Consistency
                            </h2>
                        </div>
                        <p class="section-description">Manage the 14 base reference images that ensure consistent visual generation and prepare for LoRA training.</p>
                        
                        <!-- Current Base Images Preview (14-image grid in phases) -->
                        <div class="form-group" id="current-base-images-section">
                            <label class="form-label">
                                Current Base Images (14-Image LoRA Training Set)
                            </label>
                            <span class="form-help">The complete base image set for physical appearance locking and LoRA training readiness.</span>
                            
                            <!-- Phase 1: Structural Set -->
                            <div style="margin-top: 16px;">
                                <h4 style="color: var(--primary); margin-bottom: 12px;">üìê Phase 1: Structural Set (Identity & Body)</h4>
                                <div id="base-images-structural" class="base-images-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                                    <div class="base-image-slot" id="base-image-front_headshot">
                                        <div class="image-placeholder" style="background: var(--dark-card); border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <span style="font-size: 1.5rem;">üì∏</span>
                                            <span style="color: var(--text-secondary); margin-top: 6px; font-size: 0.85rem;">Front Headshot</span>
                                            <span style="font-size: 0.7rem; color: var(--text-secondary);">No image</span>
                                        </div>
                                    </div>
                                    <div class="base-image-slot" id="base-image-side_headshot">
                                        <div class="image-placeholder" style="background: var(--dark-card); border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <span style="font-size: 1.5rem;">üì∏</span>
                                            <span style="color: var(--text-secondary); margin-top: 6px; font-size: 0.85rem;">Side Headshot</span>
                                            <span style="font-size: 0.7rem; color: var(--text-secondary);">No image</span>
                                        </div>
                                    </div>
                                    <div class="base-image-slot" id="base-image-right_hand">
                                        <div class="image-placeholder" style="background: var(--dark-card); border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <span style="font-size: 1.5rem;">ü§ö</span>
                                            <span style="color: var(--text-secondary); margin-top: 6px; font-size: 0.85rem;">Right Hand</span>
                                            <span style="font-size: 0.7rem; color: var(--text-secondary);">No image</span>
                                        </div>
                                    </div>
                                    <div class="base-image-slot" id="base-image-left_hand">
                                        <div class="image-placeholder" style="background: var(--dark-card); border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <span style="font-size: 1.5rem;">‚úã</span>
                                            <span style="color: var(--text-secondary); margin-top: 6px; font-size: 0.85rem;">Left Hand</span>
                                            <span style="font-size: 0.7rem; color: var(--text-secondary);">No image</span>
                                        </div>
                                    </div>
                                    <div class="base-image-slot" id="base-image-bust">
                                        <div class="image-placeholder" style="background: var(--dark-card); border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <span style="font-size: 1.5rem;">üë§</span>
                                            <span style="color: var(--text-secondary); margin-top: 6px; font-size: 0.85rem;">Bust View</span>
                                            <span style="font-size: 0.7rem; color: var(--text-secondary);">No image</span>
                                        </div>
                                    </div>
                                    <div class="base-image-slot" id="base-image-full_frontal">
                                        <div class="image-placeholder" style="background: var(--dark-card); border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <span style="font-size: 1.5rem;">üßç</span>
                                            <span style="color: var(--text-secondary); margin-top: 6px; font-size: 0.85rem;">Full Frontal</span>
                                            <span style="font-size: 0.7rem; color: var(--text-secondary);">No image</span>
                                        </div>
                                    </div>
                                    <div class="base-image-slot" id="base-image-side_profile">
                                        <div class="image-placeholder" style="background: var(--dark-card); border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <span style="font-size: 1.5rem;">üßç</span>
                                            <span style="color: var(--text-secondary); margin-top: 6px; font-size: 0.85rem;">Side Profile</span>
                                            <span style="font-size: 0.7rem; color: var(--text-secondary);">No image</span>
                                        </div>
                                    </div>
                                    <div class="base-image-slot" id="base-image-rear_view">
                                        <div class="image-placeholder" style="background: var(--dark-card); border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <span style="font-size: 1.5rem;">üßç</span>
                                            <span style="color: var(--text-secondary); margin-top: 6px; font-size: 0.85rem;">Rear View</span>
                                            <span style="font-size: 0.7rem; color: var(--text-secondary);">No image</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Phase 2: Action Set -->
                            <div style="margin-top: 20px;">
                                <h4 style="color: var(--accent); margin-bottom: 12px;">üèÉ Phase 2: Action Set (Dynamic Poses for LoRA)</h4>
                                <div id="base-images-action" class="base-images-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                    <div class="base-image-slot" id="base-image-compression_pose">
                                        <div class="image-placeholder" style="background: var(--dark-card); border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <span style="font-size: 1.5rem;">ü™ë</span>
                                            <span style="color: var(--text-secondary); margin-top: 6px; font-size: 0.85rem;">Compression</span>
                                            <span style="font-size: 0.7rem; color: var(--text-secondary);">Sitting/Crouching</span>
                                        </div>
                                    </div>
                                    <div class="base-image-slot" id="base-image-extension_pose">
                                        <div class="image-placeholder" style="background: var(--dark-card); border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <span style="font-size: 1.5rem;">üôÜ</span>
                                            <span style="color: var(--text-secondary); margin-top: 6px; font-size: 0.85rem;">Extension</span>
                                            <span style="font-size: 0.7rem; color: var(--text-secondary);">Reaching/Running</span>
                                        </div>
                                    </div>
                                    <div class="base-image-slot" id="base-image-twist_pose">
                                        <div class="image-placeholder" style="background: var(--dark-card); border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <span style="font-size: 1.5rem;">üîÑ</span>
                                            <span style="color: var(--text-secondary); margin-top: 6px; font-size: 0.85rem;">Twist</span>
                                            <span style="font-size: 0.7rem; color: var(--text-secondary);">Looking Back</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Phase 3: Background Set -->
                            <div style="margin-top: 20px;">
                                <h4 style="color: #f59e0b; margin-bottom: 12px;">üåÜ Phase 3: Background Variation (Regularization)</h4>
                                <div id="base-images-background" class="base-images-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                    <div class="base-image-slot" id="base-image-complex_bg_1">
                                        <div class="image-placeholder" style="background: var(--dark-card); border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <span style="font-size: 1.5rem;">üèôÔ∏è</span>
                                            <span style="color: var(--text-secondary); margin-top: 6px; font-size: 0.85rem;">Urban</span>
                                            <span style="font-size: 0.7rem; color: var(--text-secondary);">City/Street</span>
                                        </div>
                                    </div>
                                    <div class="base-image-slot" id="base-image-complex_bg_2">
                                        <div class="image-placeholder" style="background: var(--dark-card); border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <span style="font-size: 1.5rem;">üå≤</span>
                                            <span style="color: var(--text-secondary); margin-top: 6px; font-size: 0.85rem;">Nature</span>
                                            <span style="font-size: 0.7rem; color: var(--text-secondary);">Forest/Park</span>
                                        </div>
                                    </div>
                                    <div class="base-image-slot" id="base-image-complex_bg_3">
                                        <div class="image-placeholder" style="background: var(--dark-card); border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <span style="font-size: 1.5rem;">üè†</span>
                                            <span style="color: var(--text-secondary); margin-top: 6px; font-size: 0.85rem;">Interior</span>
                                            <span style="font-size: 0.7rem; color: var(--text-secondary);">Home/Room</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Base Appearance Description
                            </label>
                            <span class="form-help">Detailed baseline appearance for visual consistency (optional, max 5000 characters)</span>
                            <textarea class="form-input" id="base_appearance_description" name="base_appearance_description" maxlength="5000" placeholder="Detailed physical features, facial structure, body type, distinctive characteristics..."></textarea>
                        </div>
                        
                        <!-- Sample Image Creation (Create Mode Only) -->
                        <div class="form-group" id="sample-images-section" style="display: none;">
                            <label class="form-label">
                                Generate Base Images for LoRA Training
                            </label>
                            <span class="form-help">Generate a complete set of base images using sequential ControlNet chaining for maximum consistency.</span>
                            
                            <div class="generate-images-section" id="generate-prompt">
                                <h3>üé® Generate Base Images (ControlNet Sequential Chain)</h3>
                                <p>Uses advanced ControlNet chaining: each image builds on the previous for physical consistency across all views and poses.</p>
                                
                                <div style="margin: 12px 0; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 0.85rem;">
                                    <strong>3-Phase Generation for LoRA Training:</strong>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px;">
                                        <div style="padding: 8px; background: rgba(102, 126, 234, 0.2); border-radius: 6px;">
                                            <strong style="color: var(--primary);">üìê Phase 1: Structural</strong>
                                            <ul style="margin: 6px 0 0 16px; color: var(--text-secondary); font-size: 0.8rem;">
                                                <li>Front/Side Headshots</li>
                                                <li>Left/Right Hands</li>
                                                <li>Bust, Full Body, Profile, Rear</li>
                                            </ul>
                                        </div>
                                        <div style="padding: 8px; background: rgba(16, 185, 129, 0.2); border-radius: 6px;">
                                            <strong style="color: var(--accent);">üèÉ Phase 2: Action</strong>
                                            <ul style="margin: 6px 0 0 16px; color: var(--text-secondary); font-size: 0.8rem;">
                                                <li>Compression (fabric folds)</li>
                                                <li>Extension (arm/shoulder)</li>
                                                <li>Twist (neck rotation)</li>
                                            </ul>
                                        </div>
                                        <div style="padding: 8px; background: rgba(245, 158, 11, 0.2); border-radius: 6px;">
                                            <strong style="color: #f59e0b;">üåÜ Phase 3: Background</strong>
                                            <ul style="margin: 6px 0 0 16px; color: var(--text-secondary); font-size: 0.8rem;">
                                                <li>Urban environment</li>
                                                <li>Nature environment</li>
                                                <li>Interior environment</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <p style="margin-top: 10px; font-style: italic; color: var(--accent);">üí° NSFW-capable models provide better anatomy accuracy (output follows content rating)</p>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 16px 0;">
                                    <div>
                                        <label class="form-label" style="margin-bottom: 6px;">Generation Model</label>
                                        <select class="form-input" id="base-gen-model-select" style="margin: 0;">
                                            <option value="" selected>ü§ñ Use System Default</option>
                                            <!-- Will be populated dynamically from installed models -->
                                        </select>
                                        <span class="form-help" style="font-size: 0.75rem;">Select specific model for base image generation</span>
                                    </div>
                                    <div>
                                        <label class="form-label" style="margin-bottom: 6px;">Phases to Generate</label>
                                        <select class="form-input" id="phases-select" style="margin: 0;">
                                            <option value="structural" selected>üìê Structural Only (8 images)</option>
                                            <option value="structural,action">üìêüèÉ Structural + Action (11 images)</option>
                                            <option value="all">üéØ All Phases (14 images - Full LoRA Set)</option>
                                            <option value="action">üèÉ Action Only (3 images)</option>
                                            <option value="background">üåÜ Background Only (3 images)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 16px 0;">
                                    <div>
                                        <label class="form-label" style="margin-bottom: 6px;">Image Style</label>
                                        <select class="form-input" id="style-select" style="margin: 0;">
                                            <option value="photorealistic" selected>üì∑ Photorealistic (Lifelike)</option>
                                            <option value="anime">üéå Anime</option>
                                            <option value="cartoon">üé® Cartoon</option>
                                            <option value="artistic">üñºÔ∏è Artistic/Painting</option>
                                            <option value="3d_render">üéÆ 3D Render</option>
                                            <option value="fantasy">‚ú® Fantasy Art</option>
                                            <option value="cinematic">üé¨ Cinematic</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="form-label" style="margin-bottom: 6px;">Resolution</label>
                                        <select class="form-input" id="resolution-select" style="margin: 0;">
                                            <option value="512x512">512x512 (Square - Draft)</option>
                                            <option value="1024x1024" selected>1024x1024 (Square - HD)</option>
                                            <option value="720x1280">720x1280 (Portrait 720p)</option>
                                            <option value="1080x1920">1080x1920 (Portrait 1080p)</option>
                                            <option value="1280x720">1280x720 (Landscape 720p)</option>
                                            <option value="1920x1080">1920x1080 (Landscape 1080p)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="form-label" style="margin-bottom: 6px;">Quality</label>
                                        <select class="form-input" id="quality-select" style="margin: 0;">
                                            <option value="draft">Draft (Fast)</option>
                                            <option value="standard" selected>Standard (Balanced)</option>
                                            <option value="high">High (Detailed)</option>
                                            <option value="premium">Premium (Best Quality)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn-generate" id="generate-images-btn" onclick="generateSampleImages()">
                                    <span>‚ú®</span>
                                    <span>Generate Base Images</span>
                                </button>
                                
                                <div class="generation-progress" id="generation-progress">
                                    <div class="progress-text" id="progress-text">Creating images... 0/14</div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" id="progress-bar"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="image-gallery" id="image-gallery" style="display: none;">
                                <!-- Base images will be inserted here -->
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Appearance Locked
                            </label>
                            <span class="form-help">When enabled, locks appearance and enables visual consistency features</span>
                            <label class="checkbox-label">
                                <input type="checkbox" id="appearance_locked" name="appearance_locked">
                                <span>Lock appearance for consistency</span>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Base Image Status
                            </label>
                            <span class="form-help">Current status of the base reference image</span>
                            <select class="form-input" id="base_image_status" name="base_image_status">
                                <option value="pending_upload">Pending Upload</option>
                                <option value="draft">Draft</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Base Image Path
                            </label>
                            <span class="form-help">Path to reference image (will be set via image upload/generation endpoints)</span>
                            <input type="text" class="form-input" id="base_image_path" name="base_image_path" readonly placeholder="/models/base_images/persona_ref.jpg">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Preferred Image Style
                            </label>
                            <span class="form-help">Default image generation style for this persona</span>
                            <select class="form-input" id="image_style" name="image_style">
                                <option value="photorealistic" selected>üì∑ Photorealistic (Lifelike)</option>
                                <option value="anime">üéå Anime</option>
                                <option value="cartoon">üé® Cartoon</option>
                                <option value="artistic">üñºÔ∏è Artistic/Painting</option>
                                <option value="3d_render">üéÆ 3D Render</option>
                                <option value="fantasy">‚ú® Fantasy Art</option>
                                <option value="cinematic">üé¨ Cinematic</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Persona Negative Prompt
                            </label>
                            <span class="form-help">Persona-specific negative prompt for image generation. Overrides style defaults when set. Example: anime personas shouldn't have "anime" in their negative prompt.</span>
                            <textarea class="form-input" id="persona_negative_prompt" name="persona_negative_prompt" style="min-height: 80px;" placeholder="ugly, blurry, low quality, distorted, deformed, bad anatomy"></textarea>
                        </div>
                    </div>
                    
                    <!-- RSS Feed Assignment -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üì°</span>
                                RSS Feed Content Sources
                            </h2>
                        </div>
                        <p class="section-description">Assign RSS feeds to this persona for content generation inspiration. Specify categories to filter relevant topics.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Assigned RSS Feeds
                            </label>
                            <span class="form-help">RSS feeds that provide content suggestions for this persona</span>
                            <div id="assigned-feeds-container" style="margin-bottom: 12px;">
                                <!-- Will be populated dynamically -->
                            </div>
                            <button type="button" class="add-btn" onclick="showAssignFeedModal()">
                                + Assign RSS Feed
                            </button>
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>‚ö°</span>
                                Status
                            </h2>
                        </div>
                        <p class="section-description">Control whether this persona is active and available for content generation.</p>
                        
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="is_active" name="is_active" checked>
                                <span>Persona is active and available for content generation</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- ==================== PERSONA SOUL FIELDS ==================== -->
                    
                    <!-- Soul Creation -->
                    <div class="section" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(16, 185, 129, 0.1)); border-color: var(--primary);">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üß¨</span>
                                Soul Creation
                            </h2>
                        </div>
                        <p class="section-description">
                            Use Ollama with dolphin-mixtral to create all soul fields based on the persona's name, appearance, personality, and content rating.
                            The created fields will match the tone of your selected content rating.
                        </p>
                        
                        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                            <button type="button" class="btn btn-primary" id="randomize-soul-btn" onclick="randomizeSoulFields()" style="display: inline-flex; align-items: center; gap: 8px;">
                                <span>üé≤</span>
                                <span id="randomize-soul-text">Randomize Soul Fields</span>
                            </button>
                            
                            <span style="color: var(--text-secondary); font-size: 0.85rem;" id="randomize-status">
                                Uses selected content rating to guide creation style
                            </span>
                        </div>
                        
                        <div id="randomize-progress" style="display: none; margin-top: 16px;">
                            <div class="progress-text" style="color: var(--text-secondary); margin-bottom: 8px;">Creating soul fields...</div>
                            <div class="progress-bar-container" style="height: 6px; background: var(--dark-card); border-radius: 3px; overflow: hidden;">
                                <div class="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width 0.3s;" id="randomize-progress-bar"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Origin & Demographics -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üåç</span>
                                Origin & Demographics
                            </h2>
                        </div>
                        <p class="section-description">Define your persona's background and roots. These details create authentic cultural context and life experiences.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Hometown
                            </label>
                            <span class="form-help">Where they're from originally (e.g., "South Boston", "Nashville, TN", "Rural Texas")</span>
                            <input type="text" class="form-input" id="hometown" name="hometown" maxlength="200" placeholder="e.g., Nashville, TN">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Current Location
                            </label>
                            <span class="form-help">Where they live now and why (e.g., "Miami, FL for the weather and liberty")</span>
                            <input type="text" class="form-input" id="current_location" name="current_location" maxlength="200" placeholder="e.g., Miami, FL - moved for the weather">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Generation / Age
                            </label>
                            <span class="form-help">Generation context shapes perspective (e.g., "Gen X - cynical and latchkey", "Millennial - 28 years old")</span>
                            <input type="text" class="form-input" id="generation_age" name="generation_age" maxlength="100" placeholder="e.g., Gen Z - 24 years old, chronically online">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Education Level
                            </label>
                            <span class="form-help">Their educational background, formal or otherwise (e.g., "PhD in Physics", "School of Hard Knocks")</span>
                            <input type="text" class="form-input" id="education_level" name="education_level" maxlength="200" placeholder="e.g., State college dropout, self-taught coder">
                        </div>
                    </div>
                    
                    <!-- Psychological Profile -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üß†</span>
                                Psychological Profile
                            </h2>
                        </div>
                        <p class="section-description">The internal "engine" that drives decision-making and worldview. Helps ensure consistent, believable responses.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                MBTI Type
                            </label>
                            <span class="form-help">Myers-Briggs personality type for consistent behavior patterns</span>
                            <select class="form-input" id="mbti_type" name="mbti_type">
                                <option value="">Select MBTI Type...</option>
                                <option value="INTJ - The Architect">INTJ - The Architect</option>
                                <option value="INTP - The Logician">INTP - The Logician</option>
                                <option value="ENTJ - The Commander">ENTJ - The Commander</option>
                                <option value="ENTP - The Debater">ENTP - The Debater</option>
                                <option value="INFJ - The Advocate">INFJ - The Advocate</option>
                                <option value="INFP - The Mediator">INFP - The Mediator</option>
                                <option value="ENFJ - The Protagonist">ENFJ - The Protagonist</option>
                                <option value="ENFP - The Campaigner">ENFP - The Campaigner</option>
                                <option value="ISTJ - The Logistician">ISTJ - The Logistician</option>
                                <option value="ISFJ - The Defender">ISFJ - The Defender</option>
                                <option value="ESTJ - The Executive">ESTJ - The Executive</option>
                                <option value="ESFJ - The Consul">ESFJ - The Consul</option>
                                <option value="ISTP - The Virtuoso">ISTP - The Virtuoso</option>
                                <option value="ISFP - The Adventurer">ISFP - The Adventurer</option>
                                <option value="ESTP - The Entrepreneur">ESTP - The Entrepreneur</option>
                                <option value="ESFP - The Entertainer">ESFP - The Entertainer</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Enneagram Type
                            </label>
                            <span class="form-help">Enneagram type for deeper motivation patterns</span>
                            <select class="form-input" id="enneagram_type" name="enneagram_type">
                                <option value="">Select Enneagram Type...</option>
                                <option value="Type 1 - The Reformer">Type 1 - The Reformer</option>
                                <option value="Type 2 - The Helper">Type 2 - The Helper</option>
                                <option value="Type 3 - The Achiever">Type 3 - The Achiever</option>
                                <option value="Type 4 - The Individualist">Type 4 - The Individualist</option>
                                <option value="Type 5 - The Investigator">Type 5 - The Investigator</option>
                                <option value="Type 6 - The Loyalist">Type 6 - The Loyalist</option>
                                <option value="Type 7 - The Enthusiast">Type 7 - The Enthusiast</option>
                                <option value="Type 8 - The Challenger">Type 8 - The Challenger</option>
                                <option value="Type 9 - The Peacemaker">Type 9 - The Peacemaker</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Political Alignment
                            </label>
                            <span class="form-help">Political/social worldview for authentic opinions (e.g., "Libertarian-leaning", "Apolitical Nihilist")</span>
                            <input type="text" class="form-input" id="political_alignment" name="political_alignment" maxlength="100" placeholder="e.g., Right-leaning / Liberty-focused">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Risk Tolerance
                            </label>
                            <span class="form-help">How they approach risk and uncertainty (e.g., "Safety First", "Hold my beer")</span>
                            <input type="text" class="form-input" id="risk_tolerance" name="risk_tolerance" maxlength="100" placeholder="e.g., Move fast and break things">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Optimism/Cynicism Scale
                            </label>
                            <span class="form-help">1 = Deeply Cynical, 10 = Eternally Optimistic. This affects their general tone.</span>
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <span style="font-size: 0.85rem; color: var(--text-secondary);">Cynical</span>
                                <input type="range" id="optimism_cynicism_scale" name="optimism_cynicism_scale" min="1" max="10" value="5" style="flex: 1;">
                                <span style="font-size: 0.85rem; color: var(--text-secondary);">Optimistic</span>
                                <span id="optimism_value" style="min-width: 30px; text-align: center; font-weight: 600;">5</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Voice & Speech Patterns -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üó£Ô∏è</span>
                                Voice & Speech Patterns
                            </h2>
                        </div>
                        <p class="section-description">How the persona speaks and writes. This is the "interface" that users experience directly.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Linguistic Register
                            </label>
                            <span class="form-help">The overall speech style and vocabulary level</span>
                            <select class="form-input" id="linguistic_register" name="linguistic_register">
                                <option value="blue_collar">üîß Blue Collar - Casual, working-class speech</option>
                                <option value="academic">üìö Academic - Formal, scholarly speech</option>
                                <option value="tech_bro">üíª Tech Bro - Silicon Valley tech speak</option>
                                <option value="street">üèôÔ∏è Street - Urban slang and colloquialisms</option>
                                <option value="corporate">üíº Corporate - Business jargon</option>
                                <option value="southern">ü§† Southern - Southern U.S. dialect</option>
                                <option value="millennial">üì± Millennial - Millennial internet speak</option>
                                <option value="gen_z">‚ö° Gen Z - Chaotic and ironic</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Typing Quirks
                            </label>
                            <span class="form-help">Specific typing habits. Add key-value pairs like: capitalization, emoji_usage, punctuation</span>
                            <div class="key-value-container" id="typing-quirks-container">
                                <!-- Will be populated dynamically -->
                            </div>
                            <button type="button" class="add-btn" onclick="addTypingQuirk()">
                                + Add Typing Quirk
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Signature Phrases
                            </label>
                            <span class="form-help">Phrases they use often (e.g., "Based", "Facts", "Y'all"). Press Enter to add.</span>
                            <div class="tag-input-container" id="signature-phrases-container">
                                <input type="text" class="tag-input" id="signature-phrase-input" placeholder="Type a phrase and press Enter...">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Trigger Topics
                            </label>
                            <span class="form-help">Topics that get them excited or angry (e.g., "Taxes", "Crypto", "Bad drivers"). Press Enter to add.</span>
                            <div class="tag-input-container" id="trigger-topics-container">
                                <input type="text" class="tag-input" id="trigger-topic-input" placeholder="Type a topic and press Enter...">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Backstory & Lore -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üìñ</span>
                                Backstory & Lore
                            </h2>
                        </div>
                        <p class="section-description">The persona's life story and context. This adds depth and makes conversations more authentic.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Day Job
                            </label>
                            <span class="form-help">What they do for work (e.g., "Political Commentator / Streamer", "Small business owner")</span>
                            <input type="text" class="form-input" id="day_job" name="day_job" maxlength="200" placeholder="e.g., Content creator and part-time real estate agent">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                War Story
                            </label>
                            <span class="form-help">A defining life event that shaped who they are (e.g., "Lost a fortune in 2008", "Started posting rants in her car and went viral")</span>
                            <textarea class="form-input" id="war_story" name="war_story" maxlength="2000" placeholder="The story they always bring up..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Vices & Hobbies
                            </label>
                            <span class="form-help">What they do for fun, guilty pleasures (e.g., "Range days", "Video games", "Wine nights"). Press Enter to add.</span>
                            <div class="tag-input-container" id="vices-hobbies-container">
                                <input type="text" class="tag-input" id="vices-hobbies-input" placeholder="Type a vice/hobby and press Enter...">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Anti-Pattern -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üö´</span>
                                Anti-Pattern (What They Are NOT)
                            </h2>
                        </div>
                        <p class="section-description">Define what this persona would NEVER say or do. This prevents robotic-sounding responses and keeps character consistent.</p>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Forbidden Phrases
                            </label>
                            <span class="form-help">Phrases this persona would NEVER say (e.g., "As an AI", "I feel that", "Synergy", "Safe space"). Press Enter to add.</span>
                            <div class="tag-input-container" id="forbidden-phrases-container">
                                <input type="text" class="tag-input" id="forbidden-phrase-input" placeholder="Type a forbidden phrase and press Enter...">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Warmth Level
                            </label>
                            <span class="form-help">How warm and approachable they are in interactions</span>
                            <select class="form-input" id="warmth_level" name="warmth_level">
                                <option value="cold">‚ùÑÔ∏è Cold - Distant, professional</option>
                                <option value="neutral">üòê Neutral - Neither warm nor cold</option>
                                <option value="warm" selected>üôÇ Warm - Friendly, approachable</option>
                                <option value="buddy">ü§ó Buddy - Very friendly, like a best friend</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Patience Level
                            </label>
                            <span class="form-help">How they handle frustration and repetitive questions</span>
                            <select class="form-input" id="patience_level" name="patience_level">
                                <option value="short_fuse">üí¢ Short Fuse - Quick to frustration</option>
                                <option value="normal" selected>üòä Normal - Average patience</option>
                                <option value="patient">üßò Patient - Tolerant and understanding</option>
                                <option value="infinite">‚òØÔ∏è Infinite - Never gets frustrated</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Persona Chat Testing (Edit Mode Only) -->
                    <div class="section" id="chat-testing-section" style="display: none;">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span>üí¨</span>
                                Test Persona Chat
                            </h2>
                        </div>
                        <p class="section-description">
                            Test how your persona responds in conversations. Uses the <strong>dolphin-mixtral</strong> model for unrestricted, 
                            uncensored responses. <strong>Conversation context is maintained</strong> for fluid conversations. 
                            <br><br>
                            <strong>üì∏ Image triggers:</strong> Try phrases like "take a picture", "send me a selfie", or "show me a pic" to generate images!
                        </p>
                        
                        <!-- Quick Test Buttons -->
                        <div style="margin-bottom: 16px; padding: 12px; background: var(--dark-card); border-radius: 8px;">
                            <label class="form-label" style="margin-bottom: 8px;">
                                üöÄ Quick Tests
                            </label>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button type="button" class="btn btn-secondary" onclick="testRssFeedReaction()" style="padding: 8px 12px; font-size: 0.85rem;">
                                    üì∞ RSS Feed Reaction
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="testTopicDiscussion()" style="padding: 8px 12px; font-size: 0.85rem;">
                                    üí≠ Topic Discussion
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="testPersonalityCheck()" style="padding: 8px 12px; font-size: 0.85rem;">
                                    üé≠ Personality Check
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="testImageTrigger()" style="padding: 8px 12px; font-size: 0.85rem;">
                                    üì∏ Request Selfie
                                </button>
                            </div>
                        </div>
                        
                        <!-- RSS Feed Topic Discussion Test Panel -->
                        <div id="rss-test-panel" style="display: none; margin-bottom: 16px; padding: 16px; background: var(--dark-card); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <label class="form-label" style="margin-bottom: 0;">
                                    üì° RSS Feed Topic Discussion Test
                                </label>
                                <button type="button" onclick="closeRssTestPanel()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem;">√ó</button>
                            </div>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px;">
                                Fetch a random topic from assigned RSS feeds and test how your persona reacts to and discusses it.
                            </p>
                            
                            <div id="rss-feed-selector" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 0.85rem; margin-bottom: 6px;">Select RSS Feed</label>
                                <select class="form-input" id="rss-test-feed-select" style="margin-bottom: 8px;">
                                    <option value="">Loading feeds...</option>
                                </select>
                            </div>
                            
                            <div id="rss-topic-preview" style="display: none; margin-bottom: 12px; padding: 12px; background: var(--dark-surface); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">üì∞ Current Topic:</div>
                                <div id="rss-topic-title" style="font-weight: 600; margin-bottom: 4px;"></div>
                                <div id="rss-topic-summary" style="font-size: 0.85rem; color: var(--text-secondary);"></div>
                            </div>
                            
                            <div style="display: flex; gap: 8px;">
                                <button type="button" class="btn btn-secondary" onclick="fetchRandomRssTopic()" style="padding: 8px 12px; font-size: 0.85rem;">
                                    üîÑ Fetch Random Topic
                                </button>
                                <button type="button" class="btn btn-primary" onclick="testRssTopicDiscussion()" id="rss-discuss-btn" style="padding: 8px 12px; font-size: 0.85rem;" disabled>
                                    üí¨ Discuss This Topic
                                </button>
                            </div>
                        </div>
                        
                        <!-- Proactive Topics Section - Auto-generated content -->
                        <div id="proactive-topics-panel" style="margin-bottom: 16px; padding: 16px; background: var(--dark-card); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <label class="form-label" style="margin-bottom: 0;">
                                    üéØ Proactive Topics
                                </label>
                                <button type="button" class="btn btn-secondary" onclick="refreshProactiveTopics()" style="padding: 6px 12px; font-size: 0.8rem;">
                                    üîÑ Refresh
                                </button>
                            </div>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px;">
                                Topics your persona can proactively share opinions on, based on RSS feeds or interests.
                                Instead of waiting for users to chat, let your persona engage with current topics!
                            </p>
                            
                            <div id="proactive-topics-container">
                                <div class="loading-state" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                    <div>üì≠ No proactive topics loaded</div>
                                    <div style="font-size: 0.8rem; margin-top: 4px;">Click refresh to load topics from RSS feeds or persona interests</div>
                                </div>
                            </div>
                            
                            <!-- Generated Opinion Preview -->
                            <div id="proactive-opinion-preview" style="display: none; margin-top: 16px; padding: 16px; background: var(--dark-surface); border-radius: 8px; border-left: 4px solid var(--primary);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="font-size: 0.85rem; font-weight: 600; color: var(--primary);">
                                        üí≠ Generated Opinion
                                    </div>
                                    <button type="button" onclick="closeProactiveOpinion()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">√ó</button>
                                </div>
                                <div id="proactive-opinion-topic" style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;"></div>
                                <div id="proactive-opinion-text" style="font-size: 0.95rem; line-height: 1.5;"></div>
                                <div id="proactive-opinion-sentiment" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 8px;"></div>
                                <div style="margin-top: 12px; display: flex; gap: 8px;">
                                    <button type="button" class="btn btn-secondary" onclick="copyProactiveOpinion()" style="padding: 6px 12px; font-size: 0.8rem;">
                                        üìã Copy
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="discussProactiveOpinion()" style="padding: 6px 12px; font-size: 0.8rem;">
                                        üí¨ Discuss in Chat
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chat-status" id="chat-status">
                            <span class="dot"></span>
                            <span id="chat-status-text">Ready to chat</span>
                        </div>
                        
                        <div class="chat-container">
                            <div class="chat-messages" id="chat-messages">
                                <div class="chat-empty-state" id="chat-empty">
                                    <div class="icon">üí¨</div>
                                    <div>Start a conversation with your persona</div>
                                    <div style="font-size: 0.8rem; margin-top: 8px;">
                                        Type a message below to see how they respond
                                    </div>
                                    <div style="font-size: 0.75rem; margin-top: 4px; color: var(--accent);">
                                        üí° Try "send me a selfie" to trigger image generation!
                                    </div>
                                </div>
                            </div>
                            
                            <div class="chat-input-area">
                                <textarea 
                                    class="chat-input" 
                                    id="chat-input" 
                                    placeholder="Type a message to test your persona..."
                                    rows="1"
                                    onkeydown="handleChatKeydown(event)"
                                ></textarea>
                                <button type="button" class="chat-send-btn" id="chat-send-btn" onclick="sendChatMessage()">
                                    Send
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-secondary" onclick="clearChatHistory()" style="padding: 8px 16px; font-size: 0.85rem;">
                                üóëÔ∏è Clear Chat
                            </button>
                            <span style="color: var(--text-secondary); font-size: 0.8rem; align-self: center;" id="chat-model-info">
                                dolphin-mixtral | Context: last 10 messages | üì∏ Image triggers enabled
                            </span>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="form-actions">
                        <a href="/admin/personas" class="btn btn-secondary">Cancel</a>
                        <button type="button" class="btn btn-danger" id="delete-btn" style="display: none;" onclick="deletePersona()">
                            Delete Persona
                        </button>
                        <button type="submit" class="btn btn-primary" id="submit-btn">
                            <span id="submit-text">Create Persona</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>
    
    <script>
        // Global state
        let editorMode = 'create'; // 'create' or 'edit'
        let personaId = null;
        let themes = [];
        let stylePreferences = {};
        let platformRestrictions = {};
        let sampleImages = []; // Created sample images
        let selectedImageData = null; // Selected image for base
        let assignedFeeds = []; // Assigned RSS feeds for persona
        let availableFeeds = []; // Available RSS feeds to assign
        
        // Persona Soul Fields state
        let typingQuirks = {};
        let signaturePhrases = [];
        let triggerTopics = [];
        let vicesHobbies = [];
        let forbiddenPhrases = [];
        
        // Physical appearance arrays
        let bodyModifications = [];
        let turnOns = [];
        let turnOffs = [];
        
        // ==================== TRIGGER-BASED MODEL ORCHESTRATION STATE ====================
        let contentTriggers = {};
        let triggerCounter = 0;
        
        // Trigger category options
        const TRIGGER_CATEGORIES = [
            { value: 'pose', label: 'üé≠ Pose', description: 'selfie, full body, portrait' },
            { value: 'view', label: 'üëÄ View', description: 'front, side, rear, bust' },
            { value: 'style', label: 'üëó Style', description: 'bikini, lingerie, casual' },
            { value: 'platform', label: 'üì± Platform', description: 'instagram, tiktok, onlyfans' },
            { value: 'anatomy', label: 'üé® Anatomy', description: 'face detail, hands, body' },
            { value: 'lighting', label: 'üí° Lighting', description: 'natural, studio, warm' },
            { value: 'mood', label: 'üòä Mood', description: 'happy, seductive, serious' },
            { value: 'location', label: 'üìç Location', description: 'beach, bedroom, gym' },
            { value: 'clothing', label: 'üëô Clothing', description: 'specific clothing types' },
            { value: 'action', label: 'üèÉ Action', description: 'sitting, walking, posing' },
            { value: 'nsfw', label: 'üîû NSFW', description: 'adult content triggers' },
            { value: 'sfw', label: '‚úÖ SFW', description: 'safe content triggers' },
            { value: 'custom', label: '‚öôÔ∏è Custom', description: 'user-defined triggers' },
        ];
        
        // View type options (for per-view model switching)
        const VIEW_TYPES = [
            { value: '', label: 'Not specified' },
            { value: 'front_headshot', label: 'Front Headshot' },
            { value: 'side_headshot', label: 'Side Headshot' },
            { value: 'bust', label: 'Bust View' },
            { value: 'full_frontal', label: 'Full Frontal' },
            { value: 'side_profile', label: 'Side Profile' },
            { value: 'rear_view', label: 'Rear View' },
            { value: 'compression_pose', label: 'Compression Pose' },
            { value: 'extension_pose', label: 'Extension Pose' },
            { value: 'twist_pose', label: 'Twist Pose' },
        ];
        
        // Load branding configuration
        async function loadBranding() {
            try {
                const response = await fetch('/api/v1/branding');
                const branding = await response.json();
                
                document.getElementById('brand-name').textContent = branding.site_name || 'Platform';
                document.getElementById('brand-icon').textContent = branding.icon || 'üêä';
                document.getElementById('tenant-name').textContent = branding.instance_name || 'My Instance';
            } catch (e) {
                console.log('Using default branding');
            }
        }
        
        function switchTenant() {
            alert('Tenant switching coming soon!');
        }
        
        // Parse URL parameters
        function parseUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const action = params.get('action');
            const id = params.get('id');
            
            if (action === 'edit' && id) {
                editorMode = 'edit';
                personaId = id;
                document.getElementById('page-title').textContent = 'Edit Persona';
                document.getElementById('submit-text').textContent = 'Update Persona';
                document.getElementById('delete-btn').style.display = 'inline-block';
                // Show sample images section in edit mode too (for updating base images)
                document.getElementById('sample-images-section').style.display = 'block';
            } else {
                editorMode = 'create';
                document.getElementById('page-title').textContent = 'Create Persona';
                document.getElementById('submit-text').textContent = 'Create Persona';
                // Show sample images section in create mode
                document.getElementById('sample-images-section').style.display = 'block';
            }
        }
        
        // Show alert
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }
        
        // AI Auto-Fill all persona fields using LLM
        async function aiAutoFillFields() {
            const btn = document.getElementById('ai-autofill-btn');
            const icon = document.getElementById('ai-autofill-icon');
            const text = document.getElementById('ai-autofill-text');
            
            // Get options
            const personaType = document.getElementById('ai-persona-type').value.trim();
            const contentRating = document.getElementById('ai-content-rating').value;
            const existingName = document.getElementById('name').value.trim();
            
            // Show loading state
            btn.disabled = true;
            icon.textContent = '‚è≥';
            text.textContent = 'Generating with AI...';
            
            try {
                const requestBody = {
                    content_rating: contentRating
                };
                
                // Include existing name if provided
                if (existingName) {
                    requestBody.name = existingName;
                }
                
                // Include persona type if provided
                if (personaType) {
                    requestBody.persona_type = personaType;
                }
                
                const response = await fetch('/api/v1/personas/generate-all-fields', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to generate persona fields');
                }
                
                const data = await response.json();
                
                // Populate all the form fields with generated data
                populateFormWithAIData(data);
                
                showAlert(`‚ú® AI generated persona "${data.name}" successfully! Review and edit the fields as needed.`, 'success');
                
            } catch (error) {
                console.error('AI auto-fill failed:', error);
                showAlert(`‚ùå AI generation failed: ${error.message}`, 'error');
            } finally {
                // Reset button state
                btn.disabled = false;
                icon.textContent = '‚ú®';
                text.textContent = 'AI Auto-Fill All Fields';
            }
        }
        
        // Populate all form fields with AI-generated data
        function populateFormWithAIData(data) {
            // Basic Information
            if (data.name) document.getElementById('name').value = data.name;
            if (data.personality) document.getElementById('personality').value = data.personality;
            if (data.appearance) document.getElementById('appearance').value = data.appearance;
            
            // Content Themes
            if (data.content_themes && Array.isArray(data.content_themes)) {
                themes = data.content_themes;
                renderThemes();
            }
            
            // Physical Appearance Details
            if (data.sex) {
                const sexSelect = document.getElementById('sex');
                if (sexSelect) sexSelect.value = data.sex;
            }
            if (data.age_appearance) {
                const ageSelect = document.getElementById('age_appearance');
                if (ageSelect) ageSelect.value = data.age_appearance;
            }
            if (data.ethnicity) {
                const ethSelect = document.getElementById('ethnicity');
                if (ethSelect) ethSelect.value = data.ethnicity;
            }
            if (data.skin_tone) {
                const skinSelect = document.getElementById('skin_tone');
                if (skinSelect) skinSelect.value = data.skin_tone;
            }
            if (data.hair_color) {
                const hairColorSelect = document.getElementById('hair_color');
                if (hairColorSelect) hairColorSelect.value = data.hair_color;
            }
            if (data.hair_style) {
                const hairStyleInput = document.getElementById('hair_style');
                if (hairStyleInput) hairStyleInput.value = data.hair_style;
            }
            if (data.eye_color) {
                const eyeSelect = document.getElementById('eye_color');
                if (eyeSelect) eyeSelect.value = data.eye_color;
            }
            if (data.height) {
                const heightInput = document.getElementById('height');
                if (heightInput) heightInput.value = data.height;
            }
            if (data.weight) {
                const weightInput = document.getElementById('weight');
                if (weightInput) weightInput.value = data.weight;
            }
            if (data.build_type) {
                const buildSelect = document.getElementById('build_type');
                if (buildSelect) buildSelect.value = data.build_type;
            }
            if (data.distinctive_features) {
                const featuresInput = document.getElementById('distinctive_features');
                if (featuresInput) featuresInput.value = data.distinctive_features;
            }
            
            // Soul Fields - Origin & Demographics
            if (data.hometown) {
                const hometownInput = document.getElementById('hometown');
                if (hometownInput) hometownInput.value = data.hometown;
            }
            if (data.current_location) {
                const locationInput = document.getElementById('current_location');
                if (locationInput) locationInput.value = data.current_location;
            }
            if (data.generation_age) {
                const genAgeInput = document.getElementById('generation_age');
                if (genAgeInput) genAgeInput.value = data.generation_age;
            }
            if (data.education_level) {
                const eduInput = document.getElementById('education_level');
                if (eduInput) eduInput.value = data.education_level;
            }
            
            // Soul Fields - Psychological Profile
            if (data.mbti_type && typeof data.mbti_type === 'string') {
                const mbtiSelect = document.getElementById('mbti_type');
                if (mbtiSelect) {
                    // Try to match the MBTI type from the dropdown
                    // Handle formats like "INTJ - The Architect" or just "INTJ"
                    const mbtiValue = data.mbti_type.includes(' ') 
                        ? data.mbti_type.split(' ')[0] 
                        : data.mbti_type;
                    mbtiSelect.value = mbtiValue;
                }
            }
            if (data.enneagram_type && typeof data.enneagram_type === 'string') {
                const enneaSelect = document.getElementById('enneagram_type');
                if (enneaSelect) {
                    // Try to extract the type number (e.g., "Type 7" -> "7")
                    const match = data.enneagram_type.match(/Type\s*(\d)/i);
                    if (match) {
                        enneaSelect.value = match[1];
                    }
                }
            }
            if (data.political_alignment) {
                const polInput = document.getElementById('political_alignment');
                if (polInput) polInput.value = data.political_alignment;
            }
            if (data.risk_tolerance) {
                const riskInput = document.getElementById('risk_tolerance');
                if (riskInput) riskInput.value = data.risk_tolerance;
            }
            if (data.optimism_cynicism_scale !== undefined && data.optimism_cynicism_scale !== null) {
                const optimismSlider = document.getElementById('optimism_cynicism_scale');
                const optimismValue = document.getElementById('optimism_value');
                if (optimismSlider) {
                    optimismSlider.value = data.optimism_cynicism_scale;
                    if (optimismValue) optimismValue.textContent = data.optimism_cynicism_scale;
                }
            }
            
            // Soul Fields - Voice & Speech Patterns
            if (data.linguistic_register) {
                const regSelect = document.getElementById('linguistic_register');
                if (regSelect) regSelect.value = data.linguistic_register;
            }
            if (data.signature_phrases && Array.isArray(data.signature_phrases)) {
                signaturePhrases = data.signature_phrases;
                renderSignaturePhrases();
            }
            if (data.trigger_topics && Array.isArray(data.trigger_topics)) {
                triggerTopics = data.trigger_topics;
                renderTriggerTopics();
            }
            
            // Soul Fields - Backstory & Lore
            if (data.day_job) {
                const jobInput = document.getElementById('day_job');
                if (jobInput) jobInput.value = data.day_job;
            }
            if (data.war_story) {
                const storyInput = document.getElementById('war_story');
                if (storyInput) storyInput.value = data.war_story;
            }
            if (data.vices_hobbies && Array.isArray(data.vices_hobbies)) {
                vicesHobbies = data.vices_hobbies;
                renderVicesHobbies();
            }
            
            // Soul Fields - Anti-Pattern
            if (data.forbidden_phrases && Array.isArray(data.forbidden_phrases)) {
                forbiddenPhrases = data.forbidden_phrases;
                renderForbiddenPhrases();
            }
            if (data.warmth_level) {
                const warmthSelect = document.getElementById('warmth_level');
                if (warmthSelect) warmthSelect.value = data.warmth_level;
            }
            if (data.patience_level) {
                const patienceSelect = document.getElementById('patience_level');
                if (patienceSelect) patienceSelect.value = data.patience_level;
            }
            
            // Content Settings
            if (data.default_content_rating) {
                // Set the default content rating radio
                const ratingRadio = document.querySelector(`input[name="default_content_rating"][value="${data.default_content_rating}"]`);
                if (ratingRadio) ratingRadio.checked = true;
                
                // Also check it in allowed ratings
                const allowedCheckbox = document.querySelector(`input[name="allowed_ratings"][value="${data.default_content_rating}"]`);
                if (allowedCheckbox) allowedCheckbox.checked = true;
            }
            if (data.post_style) {
                const postStyleSelect = document.getElementById('post_style');
                if (postStyleSelect) postStyleSelect.value = data.post_style;
            }
            if (data.image_style) {
                const imageStyleSelect = document.getElementById('image_style');
                if (imageStyleSelect) imageStyleSelect.value = data.image_style;
            }
            
            // Also copy appearance to base_appearance_description if empty
            if (data.appearance) {
                const baseAppearanceInput = document.getElementById('base_appearance_description');
                if (baseAppearanceInput && !baseAppearanceInput.value) {
                    baseAppearanceInput.value = data.appearance;
                }
            }
            
            console.log('Form populated with AI-generated data:', data);
        }
        
        // Load persona data for editing
        async function loadPersonaData() {
            if (editorMode !== 'edit' || !personaId) {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('form-container').style.display = 'block';
                return;
            }
            
            document.getElementById('loading').classList.add('show');
            
            try {
                const response = await fetch(`/api/v1/personas/${personaId}`);
                if (!response.ok) {
                    throw new Error('Failed to load persona');
                }
                
                const persona = await response.json();
                
                // Populate basic fields
                document.getElementById('name').value = persona.name || '';
                document.getElementById('appearance').value = persona.appearance || '';
                document.getElementById('personality').value = persona.personality || '';
                
                // Populate themes
                themes = persona.content_themes || [];
                renderThemes();
                
                // Populate style preferences
                stylePreferences = persona.style_preferences || {};
                renderStylePreferences();
                
                // Populate content rating
                const defaultRating = persona.default_content_rating || 'sfw';
                document.querySelector(`input[name="default_content_rating"][value="${defaultRating}"]`).checked = true;
                
                // Populate allowed ratings
                const allowedRatings = persona.allowed_content_ratings || ['sfw'];
                document.querySelectorAll('input[name="allowed_ratings"]').forEach(checkbox => {
                    checkbox.checked = allowedRatings.includes(checkbox.value);
                });
                
                // Populate platform restrictions
                platformRestrictions = persona.platform_restrictions || {};
                renderPlatformRestrictions();
                
                // Populate appearance fields
                document.getElementById('base_appearance_description').value = persona.base_appearance_description || '';
                document.getElementById('appearance_locked').checked = persona.appearance_locked || false;
                document.getElementById('base_image_status').value = persona.base_image_status || 'pending_upload';
                document.getElementById('base_image_path').value = persona.base_image_path || '';
                document.getElementById('image_style').value = persona.image_style || 'photorealistic';
                document.getElementById('persona_negative_prompt').value = persona.default_negative_prompt || '';
                
                // Populate content generation preferences
                document.getElementById('default_image_resolution').value = persona.default_image_resolution || '1024x1024';
                document.getElementById('default_video_resolution').value = persona.default_video_resolution || '1920x1080';
                document.getElementById('post_style').value = persona.post_style || 'casual';
                document.getElementById('generation_quality').value = persona.generation_quality || 'standard';
                document.getElementById('nsfw_model_preference').value = persona.nsfw_model_preference || '';
                
                // Populate AI model preferences
                document.getElementById('text_model_preference').value = persona.text_model_preference || '';
                document.getElementById('image_model_preference').value = persona.image_model_preference || '';
                document.getElementById('video_model_preference').value = persona.video_model_preference || '';
                document.getElementById('voice_model_preference').value = persona.voice_model_preference || '';
                
                // Sync base generation model selector with persona's image model preference
                // This ensures the "Generate Base Images" section uses the persona's preferred model by default
                const baseGenModelSelect = document.getElementById('base-gen-model-select');
                if (baseGenModelSelect && persona.image_model_preference) {
                    baseGenModelSelect.value = persona.image_model_preference;
                    // If the model isn't in the dropdown yet (models load async), store for later
                    baseGenModelSelect.dataset.preferredModel = persona.image_model_preference;
                }
                
                // Populate video types
                const videoTypes = persona.video_types || [];
                document.querySelectorAll('input[name="video_types"]').forEach(checkbox => {
                    checkbox.checked = videoTypes.includes(checkbox.value);
                });
                
                // Populate detailed physical appearance fields
                document.getElementById('sex').value = persona.sex || '';
                document.getElementById('age_appearance').value = persona.age_appearance || '';
                document.getElementById('ethnicity').value = persona.ethnicity || '';
                document.getElementById('skin_tone').value = persona.skin_tone || '';
                document.getElementById('hair_color').value = persona.hair_color || '';
                document.getElementById('hair_style').value = persona.hair_style || '';
                document.getElementById('eye_color').value = persona.eye_color || '';
                document.getElementById('height').value = persona.height || '';
                document.getElementById('weight').value = persona.weight || '';
                document.getElementById('build_type').value = persona.build_type || '';
                document.getElementById('muscle_tone').value = persona.muscle_tone || '';
                document.getElementById('measurements').value = persona.measurements || '';
                document.getElementById('cup_size').value = persona.cup_size || '';
                document.getElementById('distinctive_features').value = persona.distinctive_features || '';
                document.getElementById('sexual_orientation').value = persona.sexual_orientation || '';
                
                // Populate body modifications
                bodyModifications = persona.body_modifications || [];
                renderBodyModifications();
                
                // Populate turn ons/offs
                turnOns = persona.turn_ons || [];
                renderTurnOns();
                turnOffs = persona.turn_offs || [];
                renderTurnOffs();
                
                // Populate status
                document.getElementById('is_active').checked = persona.is_active !== false;
                
                // ==================== POPULATE PERSONA SOUL FIELDS ====================
                
                // Origin & Demographics
                document.getElementById('hometown').value = persona.hometown || '';
                document.getElementById('current_location').value = persona.current_location || '';
                document.getElementById('generation_age').value = persona.generation_age || '';
                document.getElementById('education_level').value = persona.education_level || '';
                
                // Psychological Profile
                document.getElementById('mbti_type').value = persona.mbti_type || '';
                document.getElementById('enneagram_type').value = persona.enneagram_type || '';
                document.getElementById('political_alignment').value = persona.political_alignment || '';
                document.getElementById('risk_tolerance').value = persona.risk_tolerance || '';
                const optimismScale = persona.optimism_cynicism_scale || 5;
                document.getElementById('optimism_cynicism_scale').value = optimismScale;
                document.getElementById('optimism_value').textContent = optimismScale;
                
                // Voice & Speech Patterns
                document.getElementById('linguistic_register').value = persona.linguistic_register || 'blue_collar';
                typingQuirks = persona.typing_quirks || {};
                renderTypingQuirks();
                signaturePhrases = persona.signature_phrases || [];
                renderSignaturePhrases();
                triggerTopics = persona.trigger_topics || [];
                renderTriggerTopics();
                
                // Backstory & Lore
                document.getElementById('day_job').value = persona.day_job || '';
                document.getElementById('war_story').value = persona.war_story || '';
                vicesHobbies = persona.vices_hobbies || [];
                renderVicesHobbies();
                
                // Anti-Pattern
                forbiddenPhrases = persona.forbidden_phrases || [];
                renderForbiddenPhrases();
                document.getElementById('warmth_level').value = persona.warmth_level || 'warm';
                document.getElementById('patience_level').value = persona.patience_level || 'normal';
                
                // ==================== TRIGGER-BASED MODEL ORCHESTRATION ====================
                contentTriggers = persona.content_triggers || {};
                // Set trigger counter based on existing triggers to avoid ID collisions
                const existingIds = Object.keys(contentTriggers).filter(id => id.startsWith('trigger_'));
                if (existingIds.length > 0) {
                    const maxNum = Math.max(...existingIds.map(id => parseInt(id.split('_')[1]) || 0));
                    triggerCounter = maxNum;
                }
                renderContentTriggers();
                
                // Populate default prompts from content_triggers config (if they exist as special keys)
                if (persona.content_triggers && persona.content_triggers._config) {
                    const config = persona.content_triggers._config;
                    document.getElementById('default_positive_prompt').value = config.default_positive_prompt || '';
                    document.getElementById('default_negative_prompt').value = config.default_negative_prompt || '';
                    document.getElementById('enable_auto_lora_selection').checked = config.enable_auto_lora_selection !== false;
                    document.getElementById('enable_multi_model_routing').checked = config.enable_multi_model_routing !== false;
                }
                
                // Show status badge
                const badge = document.getElementById('status-badge');
                if (persona.generation_count > 0) {
                    badge.innerHTML = `<span class="badge badge-info">${persona.generation_count} generations</span>`;
                }
                
                // Load assigned RSS feeds
                await loadAssignedFeeds();
                
                // Load and display base image if it exists
                await loadExistingBaseImage();
                
                document.getElementById('loading').classList.remove('show');
                document.getElementById('form-container').style.display = 'block';
            } catch (error) {
                console.error('Failed to load persona:', error);
                showAlert('Failed to load persona data. Please try again.', 'error');
                setTimeout(() => {
                    window.location.href = '/admin/personas';
                }, 2000);
            }
        }
        
        // Theme management
        function renderThemes() {
            const container = document.getElementById('themes-container');
            const input = document.getElementById('theme-input');
            
            // Clear existing tags (except input)
            container.querySelectorAll('.tag').forEach(tag => tag.remove());
            
            // Add tags
            themes.forEach((theme, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${theme}
                    <span class="tag-remove" onclick="removeTheme(${index})">√ó</span>
                `;
                container.insertBefore(tag, input);
            });
        }
        
        function addTheme(theme) {
            theme = theme.trim();
            if (theme && !themes.includes(theme) && themes.length < 10) {
                themes.push(theme);
                renderThemes();
            }
        }
        
        function removeTheme(index) {
            themes.splice(index, 1);
            renderThemes();
        }
        
        // Style preferences management
        function renderStylePreferences() {
            const container = document.getElementById('style-container');
            container.innerHTML = '';
            
            Object.entries(stylePreferences).forEach(([key, value]) => {
                const row = document.createElement('div');
                row.className = 'key-value-row';
                row.innerHTML = `
                    <input type="text" class="form-input" value="${key}" placeholder="Key (e.g., aesthetic)" onchange="updateStyleKey(this, '${key}')">
                    <input type="text" class="form-input" value="${value}" placeholder="Value (e.g., professional)" onchange="updateStyleValue('${key}', this.value)">
                    <button type="button" class="remove-btn" onclick="removeStylePreference('${key}')">√ó</button>
                `;
                container.appendChild(row);
            });
        }
        
        function addStylePreference() {
            const newKey = `style_${Object.keys(stylePreferences).length + 1}`;
            stylePreferences[newKey] = '';
            renderStylePreferences();
        }
        
        function updateStyleKey(input, oldKey) {
            const newKey = input.value.trim();
            if (newKey && newKey !== oldKey && !stylePreferences.hasOwnProperty(newKey)) {
                stylePreferences[newKey] = stylePreferences[oldKey];
                delete stylePreferences[oldKey];
                renderStylePreferences();
            }
        }
        
        function updateStyleValue(key, value) {
            stylePreferences[key] = value.trim();
        }
        
        function removeStylePreference(key) {
            delete stylePreferences[key];
            renderStylePreferences();
        }
        
        // Platform restrictions management
        function renderPlatformRestrictions() {
            const container = document.getElementById('platform-container');
            container.innerHTML = '';
            
            Object.entries(platformRestrictions).forEach(([platform, restriction]) => {
                const row = document.createElement('div');
                row.className = 'key-value-row';
                row.innerHTML = `
                    <input type="text" class="form-input" value="${platform}" placeholder="Platform (e.g., instagram)" onchange="updatePlatformKey(this, '${platform}')">
                    <select class="form-input" onchange="updatePlatformValue('${platform}', this.value)">
                        <option value="sfw_only" ${restriction === 'sfw_only' ? 'selected' : ''}>SFW Only</option>
                        <option value="moderate_allowed" ${restriction === 'moderate_allowed' ? 'selected' : ''}>Moderate Allowed</option>
                        <option value="both" ${restriction === 'both' ? 'selected' : ''}>Both (SFW & NSFW)</option>
                        <option value="all" ${restriction === 'all' ? 'selected' : ''}>All</option>
                    </select>
                    <button type="button" class="remove-btn" onclick="removePlatformRestriction('${platform}')">√ó</button>
                `;
                container.appendChild(row);
            });
        }
        
        function addPlatformRestriction() {
            const newPlatform = `platform_${Object.keys(platformRestrictions).length + 1}`;
            platformRestrictions[newPlatform] = 'sfw_only';
            renderPlatformRestrictions();
        }
        
        function updatePlatformKey(input, oldKey) {
            const newKey = input.value.trim();
            if (newKey && newKey !== oldKey && !platformRestrictions.hasOwnProperty(newKey)) {
                platformRestrictions[newKey] = platformRestrictions[oldKey];
                delete platformRestrictions[oldKey];
                renderPlatformRestrictions();
            }
        }
        
        function updatePlatformValue(platform, value) {
            platformRestrictions[platform] = value;
        }
        
        function removePlatformRestriction(platform) {
            delete platformRestrictions[platform];
            renderPlatformRestrictions();
        }
        
        // ==================== TRIGGER-BASED MODEL ORCHESTRATION MANAGEMENT ====================
        
        function renderContentTriggers() {
            const container = document.getElementById('triggers-list');
            const emptyState = document.getElementById('triggers-empty-state');
            
            const triggerKeys = Object.keys(contentTriggers);
            
            if (triggerKeys.length === 0) {
                emptyState.style.display = 'block';
                container.style.display = 'none';
                return;
            }
            
            emptyState.style.display = 'none';
            container.style.display = 'block';
            container.innerHTML = '';
            
            // Sort triggers by priority (highest first)
            triggerKeys.sort((a, b) => {
                const priorityA = contentTriggers[a].priority || 50;
                const priorityB = contentTriggers[b].priority || 50;
                return priorityB - priorityA;
            });
            
            triggerKeys.forEach(triggerId => {
                const trigger = contentTriggers[triggerId];
                const card = createTriggerCard(triggerId, trigger);
                container.appendChild(card);
            });
        }
        
        function createTriggerCard(triggerId, trigger) {
            const card = document.createElement('div');
            card.className = 'trigger-card';
            card.id = `trigger-card-${triggerId}`;
            
            const categoryOptions = TRIGGER_CATEGORIES.map(cat => 
                `<option value="${cat.value}" ${trigger.category === cat.value ? 'selected' : ''}>${cat.label}</option>`
            ).join('');
            
            const viewTypeOptions = VIEW_TYPES.map(vt => 
                `<option value="${vt.value}" ${trigger.view_type === vt.value ? 'selected' : ''}>${vt.label}</option>`
            ).join('');
            
            // Build model options from installed models
            const modelOptions = buildModelOptionsHtml(trigger.model);
            
            // Build LoRA rows HTML with dropdowns
            const lorasHtml = (trigger.loras || []).map((lora, index) => `
                <div class="lora-row" data-lora-index="${index}">
                    <select class="form-input" style="flex: 2;" onchange="updateTriggerLora('${triggerId}', ${index}, 'name', this.value)">
                        <option value="">Select LoRA...</option>
                        ${buildLoraOptionsHtml(lora.name)}
                    </select>
                    <input type="range" min="0" max="2" step="0.05" value="${lora.weight || 0.8}"
                           oninput="updateTriggerLora('${triggerId}', ${index}, 'weight', this.value); this.nextElementSibling.textContent = this.value">
                    <span class="weight-display">${lora.weight || 0.8}</span>
                    <input type="text" class="form-input" value="${lora.trigger_word || ''}" 
                           placeholder="Trigger word (optional)" style="flex: 1;"
                           onchange="updateTriggerLora('${triggerId}', ${index}, 'trigger_word', this.value)">
                    <button type="button" class="remove-btn" onclick="removeTriggerLora('${triggerId}', ${index})">√ó</button>
                </div>
            `).join('');
            
            card.innerHTML = `
                <div class="trigger-card-header">
                    <div class="trigger-card-title">
                        <input type="text" value="${triggerId}" 
                               onchange="renameTrigger('${triggerId}', this.value)"
                               title="Trigger ID (click to edit)">
                        <select class="category-select" onchange="updateTriggerField('${triggerId}', 'category', this.value)">
                            ${categoryOptions}
                        </select>
                        <span class="priority-badge">
                            Priority: <input type="number" min="0" max="100" value="${trigger.priority || 50}" 
                                           style="width: 45px; background: transparent; border: none; color: white; text-align: center;"
                                           onchange="updateTriggerField('${triggerId}', 'priority', parseInt(this.value))">
                        </span>
                    </div>
                    <div class="trigger-card-actions">
                        <label class="trigger-toggle">
                            <input type="checkbox" ${trigger.enabled !== false ? 'checked' : ''} 
                                   onchange="updateTriggerField('${triggerId}', 'enabled', this.checked)">
                            <span class="trigger-toggle-slider"></span>
                        </label>
                        <button type="button" class="remove-btn" onclick="removeTrigger('${triggerId}')" title="Delete trigger">üóëÔ∏è</button>
                    </div>
                </div>
                
                <div class="trigger-card-body">
                    <!-- Trigger Phrases Section -->
                    <div class="trigger-section">
                        <div class="trigger-section-title">üéØ Trigger Phrases</div>
                        <div class="tag-input-container" id="trigger-phrases-${triggerId}">
                            ${(trigger.trigger_phrases || []).map((phrase, idx) => `
                                <span class="tag">
                                    ${escapeHtml(phrase)}
                                    <span class="tag-remove" onclick="removeTriggerPhrase('${triggerId}', ${idx})">√ó</span>
                                </span>
                            `).join('')}
                            <input type="text" class="tag-input" placeholder="Type phrase and press Enter..." 
                                   onkeydown="handleTriggerPhraseInput(event, '${triggerId}')">
                        </div>
                    </div>
                    
                    <!-- Model Selection Section -->
                    <div class="trigger-section">
                        <div class="trigger-section-title">ü§ñ Model & LoRAs</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <div>
                                <label style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; display: block;">Primary Model</label>
                                <select class="form-input" onchange="updateTriggerField('${triggerId}', 'model', this.value)">
                                    <option value="">Use Default</option>
                                    ${modelOptions}
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; display: block;">View Type</label>
                                <select class="form-input" onchange="updateTriggerField('${triggerId}', 'view_type', this.value)">
                                    ${viewTypeOptions}
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-top: 12px;">
                            <label style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px; display: block;">LoRAs to Stack</label>
                            <div id="loras-${triggerId}">
                                ${lorasHtml || '<p style="color: var(--text-secondary); font-size: 0.85rem;">No LoRAs added</p>'}
                            </div>
                            <button type="button" class="add-btn" onclick="addTriggerLora('${triggerId}')" style="margin-top: 8px;">
                                + Add LoRA
                            </button>
                        </div>
                    </div>
                    
                    <!-- Prompts Section -->
                    <div class="trigger-section">
                        <div class="trigger-section-title">üìù Prompts</div>
                        <div style="display: grid; gap: 12px;">
                            <div>
                                <label style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; display: block;">Positive Prompt</label>
                                <textarea class="form-input" style="min-height: 60px;" 
                                          placeholder="Additional positive prompt elements..."
                                          onchange="updateTriggerField('${triggerId}', 'positive_prompt', this.value)">${trigger.positive_prompt || ''}</textarea>
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; display: block;">Negative Prompt</label>
                                <textarea class="form-input" style="min-height: 60px;" 
                                          placeholder="Additional negative prompt elements..."
                                          onchange="updateTriggerField('${triggerId}', 'negative_prompt', this.value)">${trigger.negative_prompt || ''}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Weight Overrides Section (Collapsible) -->
                    <div class="trigger-section">
                        <div class="trigger-section-title collapsible-trigger collapsed" onclick="toggleCollapsible(this)">
                            <span class="collapse-icon">‚ñº</span> ‚öñÔ∏è Weight Overrides (Advanced)
                        </div>
                        <div class="collapsible-content">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px;">
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-secondary);">Guidance Scale</label>
                                    <input type="number" class="form-input" min="1" max="30" step="0.5" 
                                           value="${trigger.weight_overrides?.guidance_scale || ''}"
                                           placeholder="7.5"
                                           onchange="updateWeightOverride('${triggerId}', 'guidance_scale', this.value)">
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-secondary);">Inference Steps</label>
                                    <input type="number" class="form-input" min="1" max="150" 
                                           value="${trigger.weight_overrides?.num_inference_steps || ''}"
                                           placeholder="30"
                                           onchange="updateWeightOverride('${triggerId}', 'num_inference_steps', this.value)">
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-secondary);">Strength (img2img)</label>
                                    <input type="number" class="form-input" min="0" max="1" step="0.05" 
                                           value="${trigger.weight_overrides?.strength || ''}"
                                           placeholder="0.8"
                                           onchange="updateWeightOverride('${triggerId}', 'strength', this.value)">
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-secondary);">CLIP Skip</label>
                                    <input type="number" class="form-input" min="0" max="4" 
                                           value="${trigger.weight_overrides?.clip_skip || ''}"
                                           placeholder="0"
                                           onchange="updateWeightOverride('${triggerId}', 'clip_skip', this.value)">
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-secondary);">Sampler</label>
                                    <input type="text" class="form-input" 
                                           value="${trigger.weight_overrides?.sampler || ''}"
                                           placeholder="euler_a"
                                           onchange="updateWeightOverride('${triggerId}', 'sampler', this.value)">
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-secondary);">Scheduler</label>
                                    <input type="text" class="form-input" 
                                           value="${trigger.weight_overrides?.scheduler || ''}"
                                           placeholder="normal"
                                           onchange="updateWeightOverride('${triggerId}', 'scheduler', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div style="margin-top: 8px;">
                        <input type="text" class="form-input" 
                               value="${trigger.description || ''}"
                               placeholder="Description (optional - for documentation)"
                               onchange="updateTriggerField('${triggerId}', 'description', this.value)">
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function addContentTrigger() {
            triggerCounter++;
            const triggerId = `trigger_${triggerCounter}`;
            
            contentTriggers[triggerId] = {
                trigger_phrases: [],
                model: '',
                loras: [],
                positive_prompt: '',
                negative_prompt: '',
                category: 'custom',
                view_type: '',
                weight_overrides: {},
                priority: 50,
                enabled: true,
                description: ''
            };
            
            renderContentTriggers();
            
            // Scroll to the new trigger
            setTimeout(() => {
                const card = document.getElementById(`trigger-card-${triggerId}`);
                if (card) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }
        
        function removeTrigger(triggerId) {
            if (confirm(`Delete trigger "${triggerId}"? This cannot be undone.`)) {
                delete contentTriggers[triggerId];
                renderContentTriggers();
            }
        }
        
        function renameTrigger(oldId, newId) {
            // Normalize the ID: lowercase with underscores, no leading/trailing whitespace
            const normalizedId = newId.trim().replace(/\s+/g, '_').toLowerCase();
            if (!normalizedId || normalizedId === oldId) return;
            
            if (contentTriggers[normalizedId]) {
                alert(`Trigger ID "${normalizedId}" already exists. Please choose a different name.`);
                renderContentTriggers();
                return;
            }
            
            // Notify user if the ID was transformed
            if (normalizedId !== newId.trim()) {
                console.log(`Trigger ID normalized from "${newId}" to "${normalizedId}"`);
            }
            
            contentTriggers[normalizedId] = contentTriggers[oldId];
            delete contentTriggers[oldId];
            renderContentTriggers();
        }
        
        function updateTriggerField(triggerId, field, value) {
            if (contentTriggers[triggerId]) {
                contentTriggers[triggerId][field] = value;
            }
        }
        
        function updateWeightOverride(triggerId, field, value) {
            if (contentTriggers[triggerId]) {
                if (!contentTriggers[triggerId].weight_overrides) {
                    contentTriggers[triggerId].weight_overrides = {};
                }
                if (value === '' || value === null) {
                    delete contentTriggers[triggerId].weight_overrides[field];
                } else {
                    contentTriggers[triggerId].weight_overrides[field] = parseFloat(value) || value;
                }
            }
        }
        
        function handleTriggerPhraseInput(event, triggerId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const phrase = input.value.trim();
                
                if (phrase && contentTriggers[triggerId]) {
                    if (!contentTriggers[triggerId].trigger_phrases) {
                        contentTriggers[triggerId].trigger_phrases = [];
                    }
                    if (!contentTriggers[triggerId].trigger_phrases.includes(phrase)) {
                        contentTriggers[triggerId].trigger_phrases.push(phrase);
                        input.value = '';
                        renderContentTriggers();
                    }
                }
            }
        }
        
        function removeTriggerPhrase(triggerId, index) {
            if (contentTriggers[triggerId] && contentTriggers[triggerId].trigger_phrases) {
                contentTriggers[triggerId].trigger_phrases.splice(index, 1);
                renderContentTriggers();
            }
        }
        
        function addTriggerLora(triggerId) {
            if (contentTriggers[triggerId]) {
                if (!contentTriggers[triggerId].loras) {
                    contentTriggers[triggerId].loras = [];
                }
                contentTriggers[triggerId].loras.push({
                    name: '',
                    weight: 0.8,
                    trigger_word: ''
                });
                renderContentTriggers();
            }
        }
        
        function removeTriggerLora(triggerId, index) {
            if (contentTriggers[triggerId] && contentTriggers[triggerId].loras) {
                contentTriggers[triggerId].loras.splice(index, 1);
                renderContentTriggers();
            }
        }
        
        function updateTriggerLora(triggerId, index, field, value) {
            if (contentTriggers[triggerId] && contentTriggers[triggerId].loras && contentTriggers[triggerId].loras[index]) {
                if (field === 'weight') {
                    contentTriggers[triggerId].loras[index][field] = parseFloat(value);
                } else {
                    contentTriggers[triggerId].loras[index][field] = value;
                }
            }
        }
        
        function toggleCollapsible(element) {
            element.classList.toggle('collapsed');
            const content = element.nextElementSibling;
            content.classList.toggle('show');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function buildContentTriggersConfig() {
            // Build the content_triggers object including the _config section
            // for default prompts and global settings
            const config = {
                // Include the _config section for global settings
                _config: {
                    default_positive_prompt: document.getElementById('default_positive_prompt')?.value || '',
                    default_negative_prompt: document.getElementById('default_negative_prompt')?.value || '',
                    enable_auto_lora_selection: document.getElementById('enable_auto_lora_selection')?.checked !== false,
                    enable_multi_model_routing: document.getElementById('enable_multi_model_routing')?.checked !== false
                }
            };
            
            // Add all the individual triggers (excluding any internal keys starting with _)
            for (const [triggerId, trigger] of Object.entries(contentTriggers)) {
                if (!triggerId.startsWith('_')) {
                    // Clean up the trigger data before saving
                    config[triggerId] = {
                        trigger_phrases: trigger.trigger_phrases || [],
                        model: trigger.model || null,
                        loras: (trigger.loras || []).filter(lora => lora.name), // Only keep LoRAs with names
                        positive_prompt: trigger.positive_prompt || '',
                        negative_prompt: trigger.negative_prompt || '',
                        category: trigger.category || 'custom',
                        view_type: trigger.view_type || null,
                        weight_overrides: cleanWeightOverrides(trigger.weight_overrides),
                        priority: trigger.priority || 50,
                        enabled: trigger.enabled !== false,
                        description: trigger.description || null
                    };
                }
            }
            
            return config;
        }
        
        function cleanWeightOverrides(overrides) {
            // Remove empty/null values from weight overrides
            if (!overrides) return null;
            
            const cleaned = {};
            for (const [key, value] of Object.entries(overrides)) {
                if (value !== null && value !== undefined && value !== '') {
                    cleaned[key] = value;
                }
            }
            
            return Object.keys(cleaned).length > 0 ? cleaned : null;
        }
        
        // ==================== PERSONA SOUL FIELDS MANAGEMENT ====================
        
        // Typing Quirks management
        function renderTypingQuirks() {
            const container = document.getElementById('typing-quirks-container');
            container.innerHTML = '';
            
            Object.entries(typingQuirks).forEach(([key, value]) => {
                const row = document.createElement('div');
                row.className = 'key-value-row';
                row.innerHTML = `
                    <input type="text" class="form-input" value="${key}" placeholder="Key (e.g., capitalization)" onchange="updateTypingQuirkKey(this, '${key}')">
                    <input type="text" class="form-input" value="${value}" placeholder="Value (e.g., all lowercase)" onchange="updateTypingQuirkValue('${key}', this.value)">
                    <button type="button" class="remove-btn" onclick="removeTypingQuirk('${key}')">√ó</button>
                `;
                container.appendChild(row);
            });
        }
        
        // Counter for unique quirk key generation
        let typingQuirkCounter = 0;
        
        function addTypingQuirk() {
            const suggestedKeys = ['capitalization', 'emoji_usage', 'punctuation', 'abbreviations'];
            const existingKeys = Object.keys(typingQuirks);
            let availableKey = suggestedKeys.find(k => !existingKeys.includes(k));
            if (!availableKey) {
                // Use timestamp-based key for uniqueness
                typingQuirkCounter++;
                availableKey = `quirk_${Date.now()}_${typingQuirkCounter}`;
            }
            typingQuirks[availableKey] = '';
            renderTypingQuirks();
        }
        
        function updateTypingQuirkKey(input, oldKey) {
            const newKey = input.value.trim();
            if (newKey && newKey !== oldKey && !typingQuirks.hasOwnProperty(newKey)) {
                typingQuirks[newKey] = typingQuirks[oldKey];
                delete typingQuirks[oldKey];
                renderTypingQuirks();
            }
        }
        
        function updateTypingQuirkValue(key, value) {
            typingQuirks[key] = value.trim();
        }
        
        function removeTypingQuirk(key) {
            delete typingQuirks[key];
            renderTypingQuirks();
        }
        
        // Signature Phrases management
        function renderSignaturePhrases() {
            const container = document.getElementById('signature-phrases-container');
            const input = document.getElementById('signature-phrase-input');
            
            container.querySelectorAll('.tag').forEach(tag => tag.remove());
            
            signaturePhrases.forEach((phrase, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${phrase}
                    <span class="tag-remove" onclick="removeSignaturePhrase(${index})">√ó</span>
                `;
                container.insertBefore(tag, input);
            });
        }
        
        function addSignaturePhrase(phrase) {
            phrase = phrase.trim();
            if (phrase && !signaturePhrases.includes(phrase)) {
                signaturePhrases.push(phrase);
                renderSignaturePhrases();
            }
        }
        
        function removeSignaturePhrase(index) {
            signaturePhrases.splice(index, 1);
            renderSignaturePhrases();
        }
        
        // Trigger Topics management
        function renderTriggerTopics() {
            const container = document.getElementById('trigger-topics-container');
            const input = document.getElementById('trigger-topic-input');
            
            container.querySelectorAll('.tag').forEach(tag => tag.remove());
            
            triggerTopics.forEach((topic, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${topic}
                    <span class="tag-remove" onclick="removeTriggerTopic(${index})">√ó</span>
                `;
                container.insertBefore(tag, input);
            });
        }
        
        function addTriggerTopic(topic) {
            topic = topic.trim();
            if (topic && !triggerTopics.includes(topic)) {
                triggerTopics.push(topic);
                renderTriggerTopics();
            }
        }
        
        function removeTriggerTopic(index) {
            triggerTopics.splice(index, 1);
            renderTriggerTopics();
        }
        
        // Vices & Hobbies management
        function renderVicesHobbies() {
            const container = document.getElementById('vices-hobbies-container');
            const input = document.getElementById('vices-hobbies-input');
            
            container.querySelectorAll('.tag').forEach(tag => tag.remove());
            
            vicesHobbies.forEach((item, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${item}
                    <span class="tag-remove" onclick="removeViceHobby(${index})">√ó</span>
                `;
                container.insertBefore(tag, input);
            });
        }
        
        function addViceHobby(item) {
            item = item.trim();
            if (item && !vicesHobbies.includes(item)) {
                vicesHobbies.push(item);
                renderVicesHobbies();
            }
        }
        
        function removeViceHobby(index) {
            vicesHobbies.splice(index, 1);
            renderVicesHobbies();
        }
        
        // Forbidden Phrases management
        function renderForbiddenPhrases() {
            const container = document.getElementById('forbidden-phrases-container');
            const input = document.getElementById('forbidden-phrase-input');
            
            container.querySelectorAll('.tag').forEach(tag => tag.remove());
            
            forbiddenPhrases.forEach((phrase, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.style.background = '#ef4444'; // Red color for forbidden
                tag.innerHTML = `
                    ${phrase}
                    <span class="tag-remove" onclick="removeForbiddenPhrase(${index})">√ó</span>
                `;
                container.insertBefore(tag, input);
            });
        }
        
        function addForbiddenPhrase(phrase) {
            phrase = phrase.trim();
            if (phrase && !forbiddenPhrases.includes(phrase)) {
                forbiddenPhrases.push(phrase);
                renderForbiddenPhrases();
            }
        }
        
        function removeForbiddenPhrase(index) {
            forbiddenPhrases.splice(index, 1);
            renderForbiddenPhrases();
        }
        
        // ==================== PHYSICAL APPEARANCE ARRAY FIELDS ====================
        
        // Body Modifications management
        function renderBodyModifications() {
            const container = document.getElementById('body-modifications-container');
            const input = document.getElementById('body-modification-input');
            
            container.querySelectorAll('.tag').forEach(tag => tag.remove());
            
            bodyModifications.forEach((mod, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${mod}
                    <span class="tag-remove" onclick="removeBodyModification(${index})">√ó</span>
                `;
                container.insertBefore(tag, input);
            });
        }
        
        function addBodyModification(mod) {
            mod = mod.trim();
            if (mod && !bodyModifications.includes(mod)) {
                bodyModifications.push(mod);
                renderBodyModifications();
            }
        }
        
        function removeBodyModification(index) {
            bodyModifications.splice(index, 1);
            renderBodyModifications();
        }
        
        // Turn Ons management
        function renderTurnOns() {
            const container = document.getElementById('turn-ons-container');
            const input = document.getElementById('turn-on-input');
            
            container.querySelectorAll('.tag').forEach(tag => tag.remove());
            
            turnOns.forEach((item, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.style.background = '#10b981'; // Green for turn ons
                tag.innerHTML = `
                    ${item}
                    <span class="tag-remove" onclick="removeTurnOn(${index})">√ó</span>
                `;
                container.insertBefore(tag, input);
            });
        }
        
        function addTurnOn(item) {
            item = item.trim();
            if (item && !turnOns.includes(item)) {
                turnOns.push(item);
                renderTurnOns();
            }
        }
        
        function removeTurnOn(index) {
            turnOns.splice(index, 1);
            renderTurnOns();
        }
        
        // Turn Offs management
        function renderTurnOffs() {
            const container = document.getElementById('turn-offs-container');
            const input = document.getElementById('turn-off-input');
            
            container.querySelectorAll('.tag').forEach(tag => tag.remove());
            
            turnOffs.forEach((item, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.style.background = '#ef4444'; // Red for turn offs
                tag.innerHTML = `
                    ${item}
                    <span class="tag-remove" onclick="removeTurnOff(${index})">√ó</span>
                `;
                container.insertBefore(tag, input);
            });
        }
        
        function addTurnOff(item) {
            item = item.trim();
            if (item && !turnOffs.includes(item)) {
                turnOffs.push(item);
                renderTurnOffs();
            }
        }
        
        function removeTurnOff(index) {
            turnOffs.splice(index, 1);
            renderTurnOffs();
        }
        
        // ==================== SOUL CREATION ====================
        
        async function randomizeSoulFields() {
            const name = document.getElementById('name').value.trim();
            const appearance = document.getElementById('appearance').value.trim();
            const personality = document.getElementById('personality').value.trim();
            
            if (!name) {
                showAlert('Please enter a name before creating soul fields.', 'error');
                return;
            }
            
            // Get the selected content rating
            const contentRating = document.querySelector('input[name="default_content_rating"]:checked')?.value || 'sfw';
            
            const btn = document.getElementById('randomize-soul-btn');
            const btnText = document.getElementById('randomize-soul-text');
            const statusText = document.getElementById('randomize-status');
            const progress = document.getElementById('randomize-progress');
            const progressBar = document.getElementById('randomize-progress-bar');
            
            // Disable button and show progress
            btn.disabled = true;
            btnText.textContent = 'Creating...';
            statusText.textContent = `Creating ${contentRating.toUpperCase()} soul fields...`;
            progress.style.display = 'block';
            progressBar.style.width = '20%';
            
            try {
                const response = await fetch('/api/v1/personas/generate-soul-fields', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        appearance: appearance,
                        personality: personality,
                        content_rating: contentRating
                    })
                });
                
                progressBar.style.width = '60%';
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create soul fields');
                }
                
                const soulData = await response.json();
                progressBar.style.width = '80%';
                
                // Populate all the soul fields
                populateSoulFields(soulData);
                
                progressBar.style.width = '100%';
                
                const modelInfo = soulData.model_used ? ` using ${soulData.model_used}` : '';
                statusText.textContent = `‚úÖ Created successfully${modelInfo}!`;
                showAlert(`Soul fields created successfully${modelInfo}! Review and adjust as needed.`, 'success');
                
                // Hide progress after a moment
                setTimeout(() => {
                    progress.style.display = 'none';
                    statusText.textContent = 'Uses selected content rating to guide creation style';
                }, 3000);
                
            } catch (error) {
                console.error('Failed to create soul fields:', error);
                statusText.textContent = `‚ùå ${error.message}`;
                showAlert(error.message || 'Failed to create soul fields. Make sure Ollama is running.', 'error');
                progress.style.display = 'none';
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Randomize Soul Fields';
            }
        }
        
        function populateSoulFields(soulData) {
            // Origin & Demographics
            if (soulData.hometown) document.getElementById('hometown').value = soulData.hometown;
            if (soulData.current_location) document.getElementById('current_location').value = soulData.current_location;
            if (soulData.generation_age) document.getElementById('generation_age').value = soulData.generation_age;
            if (soulData.education_level) document.getElementById('education_level').value = soulData.education_level;
            
            // Psychological Profile
            if (soulData.mbti_type) document.getElementById('mbti_type').value = soulData.mbti_type;
            if (soulData.enneagram_type) document.getElementById('enneagram_type').value = soulData.enneagram_type;
            if (soulData.political_alignment) document.getElementById('political_alignment').value = soulData.political_alignment;
            if (soulData.risk_tolerance) document.getElementById('risk_tolerance').value = soulData.risk_tolerance;
            
            if (soulData.optimism_cynicism_scale !== null && soulData.optimism_cynicism_scale !== undefined) {
                document.getElementById('optimism_cynicism_scale').value = soulData.optimism_cynicism_scale;
                document.getElementById('optimism_value').textContent = soulData.optimism_cynicism_scale;
            }
            
            // Voice & Speech Patterns
            if (soulData.linguistic_register) {
                document.getElementById('linguistic_register').value = soulData.linguistic_register;
            }
            
            if (soulData.typing_quirks && typeof soulData.typing_quirks === 'object') {
                typingQuirks = soulData.typing_quirks;
                renderTypingQuirks();
            }
            
            if (soulData.signature_phrases && Array.isArray(soulData.signature_phrases)) {
                signaturePhrases = soulData.signature_phrases;
                renderSignaturePhrases();
            }
            
            if (soulData.trigger_topics && Array.isArray(soulData.trigger_topics)) {
                triggerTopics = soulData.trigger_topics;
                renderTriggerTopics();
            }
            
            // Backstory & Lore
            if (soulData.day_job) document.getElementById('day_job').value = soulData.day_job;
            if (soulData.war_story) document.getElementById('war_story').value = soulData.war_story;
            
            if (soulData.vices_hobbies && Array.isArray(soulData.vices_hobbies)) {
                vicesHobbies = soulData.vices_hobbies;
                renderVicesHobbies();
            }
            
            // Anti-Pattern
            if (soulData.forbidden_phrases && Array.isArray(soulData.forbidden_phrases)) {
                forbiddenPhrases = soulData.forbidden_phrases;
                renderForbiddenPhrases();
            }
            
            if (soulData.warmth_level) document.getElementById('warmth_level').value = soulData.warmth_level;
            if (soulData.patience_level) document.getElementById('patience_level').value = soulData.patience_level;
        }
        
        // Build comprehensive appearance description from all detailed fields
        function buildDetailedAppearancePrompt() {
            const parts = [];
            
            // Get all the detailed physical appearance fields
            const sex = document.getElementById('sex').value;
            const ageAppearance = document.getElementById('age_appearance').value;
            const ethnicity = document.getElementById('ethnicity').value;
            const skinTone = document.getElementById('skin_tone').value;
            const hairColor = document.getElementById('hair_color').value;
            const hairStyle = document.getElementById('hair_style').value.trim();
            const eyeColor = document.getElementById('eye_color').value;
            const height = document.getElementById('height').value.trim();
            const weight = document.getElementById('weight').value.trim();
            const buildType = document.getElementById('build_type').value;
            const muscleTone = document.getElementById('muscle_tone').value;
            const measurements = document.getElementById('measurements').value.trim();
            const cupSize = document.getElementById('cup_size').value;
            const distinctiveFeatures = document.getElementById('distinctive_features').value.trim();
            const baseAppearance = document.getElementById('appearance').value.trim();
            
            // Build a comprehensive description from fine-grained fields
            // Start with sex and age
            if (sex || ageAppearance) {
                let ageAndSex = [];
                if (ageAppearance) {
                    // Convert age_appearance values to natural language
                    const ageMap = {
                        'late_teens': 'late teens (18-19)',
                        'early_20s': 'early 20s',
                        'mid_20s': 'mid 20s',
                        'late_20s': 'late 20s',
                        'early_30s': 'early 30s',
                        'mid_30s': 'mid 30s',
                        'late_30s': 'late 30s',
                        '40s': '40s',
                        '50s': '50s',
                        'mature': 'mature (60+)'
                    };
                    ageAndSex.push(ageMap[ageAppearance] || ageAppearance);
                }
                if (sex) {
                    // Convert sex values to natural language
                    const sexMap = {
                        'female': 'woman',
                        'male': 'man',
                        'non-binary': 'non-binary person',
                        'trans_female': 'trans woman',
                        'trans_male': 'trans man'
                    };
                    ageAndSex.push(sexMap[sex] || sex);
                }
                if (ageAndSex.length > 0) {
                    parts.push(ageAndSex.join(' year old '));
                }
            }
            
            // Add ethnicity and skin tone
            if (ethnicity || skinTone) {
                let appearance = [];
                if (ethnicity) {
                    const ethnicityMap = {
                        'caucasian': 'Caucasian',
                        'asian': 'Asian',
                        'east_asian': 'East Asian',
                        'south_asian': 'South Asian',
                        'latina': 'Latina',
                        'african_american': 'African American',
                        'middle_eastern': 'Middle Eastern',
                        'mixed': 'mixed race',
                        'pacific_islander': 'Pacific Islander',
                        'native_american': 'Native American'
                    };
                    appearance.push(ethnicityMap[ethnicity] || ethnicity);
                }
                if (skinTone) {
                    const skinToneMap = {
                        'very_fair': 'very fair',
                        'fair': 'fair',
                        'light': 'light',
                        'medium': 'medium',
                        'olive': 'olive',
                        'tan': 'tan',
                        'brown': 'brown',
                        'dark_brown': 'dark brown',
                        'deep': 'deep/dark'
                    };
                    appearance.push((skinToneMap[skinTone] || skinTone) + ' skin');
                }
                if (appearance.length > 0) {
                    // Only add 'skin' suffix if we have skin tone, otherwise just use ethnicity
                    if (skinTone) {
                        parts.push(appearance.join(' with '));
                    } else {
                        parts.push(appearance.join(', '));
                    }
                }
            }
            
            // Add hair description
            if (hairColor || hairStyle) {
                let hair = [];
                if (hairColor) {
                    const hairColorMap = {
                        'blonde': 'blonde',
                        'dirty_blonde': 'dirty blonde',
                        'brunette': 'brunette',
                        'light_brown': 'light brown',
                        'dark_brown': 'dark brown',
                        'black': 'black',
                        'red': 'red/ginger',
                        'auburn': 'auburn',
                        'gray': 'gray/silver',
                        'white': 'white/platinum',
                        'pink': 'pink',
                        'blue': 'blue',
                        'purple': 'purple',
                        'green': 'green',
                        'rainbow': 'rainbow/multi-colored'
                    };
                    hair.push(hairColorMap[hairColor] || hairColor);
                }
                if (hairStyle) {
                    hair.push(hairStyle);
                }
                if (hair.length > 0) {
                    parts.push(hair.join(' ') + ' hair');
                }
            }
            
            // Add eye color
            if (eyeColor) {
                const eyeColorMap = {
                    'blue': 'blue',
                    'light_blue': 'light blue',
                    'green': 'green',
                    'hazel': 'hazel',
                    'brown': 'brown',
                    'dark_brown': 'dark brown',
                    'amber': 'amber',
                    'gray': 'gray',
                    'heterochromia': 'heterochromia'
                };
                parts.push((eyeColorMap[eyeColor] || eyeColor) + ' eyes');
            }
            
            // Add body build
            if (buildType || muscleTone) {
                let build = [];
                if (buildType) {
                    const buildMap = {
                        'petite': 'petite',
                        'slim': 'slim',
                        'lean': 'lean',
                        'average': 'average',
                        'athletic': 'athletic',
                        'toned': 'toned',
                        'curvy': 'curvy',
                        'hourglass': 'hourglass',
                        'muscular': 'muscular',
                        'plus_size': 'plus size',
                        'thick': 'thick'
                    };
                    build.push(buildMap[buildType] || buildType);
                }
                if (muscleTone && muscleTone !== buildType) {
                    const muscleMap = {
                        'soft': 'soft',
                        'average': 'average',
                        'toned': 'toned',
                        'athletic': 'athletic',
                        'fit': 'fit',
                        'muscular': 'muscular',
                        'very_muscular': 'very muscular'
                    };
                    build.push(muscleMap[muscleTone] || muscleTone);
                }
                if (build.length > 0) {
                    parts.push(build.join(' ') + ' build');
                }
            }
            
            // Add height and weight
            if (height || weight) {
                let body = [];
                if (height) body.push(height);
                if (weight) body.push(weight);
                if (body.length > 0) {
                    parts.push(body.join(', '));
                }
            }
            
            // Add measurements and cup size for female personas
            if (sex === 'female' || sex === 'trans_female') {
                if (measurements || cupSize) {
                    let bodyDetails = [];
                    if (cupSize) {
                        bodyDetails.push(cupSize + ' cup');
                    }
                    if (measurements) {
                        bodyDetails.push(measurements + ' measurements');
                    }
                    if (bodyDetails.length > 0) {
                        parts.push(bodyDetails.join(', '));
                    }
                }
            }
            
            // Add distinctive features
            if (distinctiveFeatures) {
                parts.push(distinctiveFeatures);
            }
            
            // Add body modifications from the global array (managed by tag input)
            // The bodyModifications array is populated via the tag input UI
            if (typeof bodyModifications !== 'undefined' && bodyModifications && bodyModifications.length > 0) {
                parts.push(bodyModifications.join(', '));
            }
            
            // If we have detailed fields, build the detailed prompt
            // Otherwise fall back to the base appearance field
            if (parts.length > 0) {
                // Combine with base appearance for any additional context
                let detailedPrompt = parts.join(', ');
                // If there's additional context in the base appearance that's not covered by the detailed fields
                // we can optionally append it
                if (baseAppearance && baseAppearance.length > 10) {
                    // Only append if it adds significant new information
                    // (avoid duplication with the detailed fields)
                    detailedPrompt = detailedPrompt + '. ' + baseAppearance;
                }
                return detailedPrompt;
            }
            
            // Fallback to base appearance if no detailed fields are filled
            return baseAppearance;
        }
        
        // Sample image creation
        async function generateSampleImages() {
            // Build detailed appearance from all fine-grained fields
            const detailedAppearance = buildDetailedAppearancePrompt();
            const baseAppearance = document.getElementById('appearance').value.trim();
            const personality = document.getElementById('personality').value.trim();
            const resolution = document.getElementById('resolution-select').value;
            const quality = document.getElementById('quality-select').value;
            const style = document.getElementById('style-select').value;
            const phases = document.getElementById('phases-select').value;
            const baseGenModel = document.getElementById('base-gen-model-select').value;
            
            // Use detailed appearance if available, otherwise fall back to base
            const appearance = detailedAppearance || baseAppearance;
            
            if (!appearance || appearance.length < 10) {
                showAlert('Please enter an appearance description (at least 10 characters) before creating images.', 'error');
                return;
            }
            
            const generateBtn = document.getElementById('generate-images-btn');
            const progress = document.getElementById('generation-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const gallery = document.getElementById('image-gallery');
            
            // Calculate expected image count based on phases
            const phaseImageCounts = {
                'structural': 8,
                'action': 3,
                'background': 3,
                'structural,action': 11,
                'all': 14
            };
            const expectedImages = phaseImageCounts[phases] || 8;
            
            // Disable button and show progress
            generateBtn.disabled = true;
            generateBtn.textContent = 'Creating...';
            progress.classList.add('show');
            gallery.style.display = 'none';
            sampleImages = [];
            
            try {
                // Call API to create sample images with all parameters
                const styleLabel = document.getElementById('style-select').selectedOptions[0].textContent;
                const phasesLabel = document.getElementById('phases-select').selectedOptions[0].textContent;
                progressText.textContent = `Creating ${expectedImages} ${styleLabel} images (${phasesLabel}) at ${resolution}... This may take several minutes.`;
                progressBar.style.width = '15%';
                
                // Build query params with the detailed appearance
                const params = new URLSearchParams({
                    appearance: appearance,
                    personality: personality || '',
                    resolution: resolution,
                    quality: quality,
                    style: style,
                    phases: phases
                });
                
                // Add model preference if selected from dropdown
                if (baseGenModel) {
                    params.append('nsfw_model', baseGenModel);
                }
                
                // If editing an existing persona, pass the persona_id so the backend
                // can use the persona's saved model preferences (image_model_preference, nsfw_model_preference)
                if (editorMode === 'edit' && personaId) {
                    params.append('persona_id', personaId);
                }
                
                const response = await fetch('/api/v1/personas/generate-sample-images?' + params, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create images');
                }
                
                const result = await response.json();
                sampleImages = result.images || [];
                
                progressBar.style.width = '100%';
                
                // Show training readiness info
                const trainingReady = result.training_ready;
                const phasesGenerated = result.phases_generated || [];
                let statusMsg = `Created ${sampleImages.length} images successfully!`;
                if (trainingReady) {
                    statusMsg += ' ‚úÖ Ready for LoRA training!';
                } else if (result.training_guidance) {
                    statusMsg += ` (${result.training_guidance.recommended_next})`;
                }
                progressText.textContent = statusMsg;
                
                // Display images
                if (sampleImages.length > 0) {
                    displaySampleImages();
                    setTimeout(() => {
                        progress.classList.remove('show');
                    }, 2000);
                    
                    // Show success message with training info
                    if (trainingReady) {
                        showAlert('All 14 base images generated! Your persona is ready for LoRA training.', 'success');
                    } else {
                        showAlert(`Generated ${sampleImages.length} images. Select images to use for appearance locking.`, 'success');
                    }
                } else {
                    showAlert('No images were created. Please try again.', 'error');
                    progress.classList.remove('show');
                }
                
            } catch (error) {
                console.error('Failed to create images:', error);
                showAlert(error.message || 'Failed to create images. Please try again.', 'error');
                progress.classList.remove('show');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span>‚ú®</span><span>Generate Base Images</span>';
            }
        }
        
        function displaySampleImages() {
            const gallery = document.getElementById('image-gallery');
            gallery.innerHTML = '';
            gallery.style.display = 'grid';
            // Adjust grid for different image counts
            gallery.style.gridTemplateColumns = sampleImages.length > 4 ? 'repeat(4, 1fr)' : 'repeat(2, 1fr)';
            
            // Image type labels with emojis (expanded for 14-image system)
            const typeLabels = {
                // Phase 1: Structural
                'front_headshot': 'üì∏ Front Headshot',
                'side_headshot': 'üì∏ Side Headshot',
                'right_hand': 'ü§ö Right Hand',
                'left_hand': '‚úã Left Hand',
                'bust': 'üë§ Bust View',
                'full_frontal': 'üßç Full Frontal',
                'side_profile': 'üßç Side Profile',
                'rear_view': 'üßç Rear View',
                // Phase 2: Action
                'compression_pose': 'ü™ë Compression',
                'extension_pose': 'üôÜ Extension',
                'twist_pose': 'üîÑ Twist',
                // Phase 3: Background
                'complex_bg_1': 'üèôÔ∏è Urban BG',
                'complex_bg_2': 'üå≤ Nature BG',
                'complex_bg_3': 'üè† Interior BG'
            };
            
            // Phase colors for visual distinction
            const phaseColors = {
                'structural': 'var(--primary)',
                'action': 'var(--accent)',
                'background': '#f59e0b'
            };
            
            sampleImages.forEach((image, index) => {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.id = `image-card-${image.id}`;
                card.onclick = () => selectSampleImage(image.id);
                
                // Use the label from API response or fallback to type mapping
                const label = image.label || typeLabels[image.type] || `Image ${index + 1}`;
                const phase = image.phase || 'structural';
                const phaseColor = phaseColors[phase] || 'var(--primary)';
                const isBaseRef = image.type === 'front_headshot' ? '<span style="font-size: 0.65rem; color: var(--accent);">(Base Reference)</span>' : '';
                
                // Show phase badge
                const phaseBadge = `<span style="position: absolute; top: 8px; left: 8px; background: ${phaseColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; text-transform: uppercase;">${phase}</span>`;
                
                card.innerHTML = `
                    ${phaseBadge}
                    <span class="selected-badge">‚úì Selected</span>
                    <img src="${image.data_url}" alt="${label}">
                    <div class="image-card-label">${label} ${isBaseRef}</div>
                `;
                
                gallery.appendChild(card);
            });
            
            // Auto-select all images since they're a complete set
            selectAllBaseImages();
        }
        
        // Store all selected base images (not just one)
        let selectedBaseImages = {};
        
        function selectAllBaseImages() {
            // Select all generated images as a complete set
            selectedBaseImages = {};
            
            sampleImages.forEach(image => {
                // Mark card as selected
                const card = document.getElementById(`image-card-${image.id}`);
                if (card) {
                    card.classList.add('selected');
                }
                
                // Store the image data by type
                selectedBaseImages[image.type || image.id] = image.data_url;
            });
            
            const totalImages = Object.keys(selectedBaseImages).length;
            
            // Update form fields
            document.getElementById('base_image_status').value = 'approved';
            document.getElementById('appearance_locked').checked = true;
            document.getElementById('base_image_path').value = editorMode === 'edit' ? 
                `${totalImages} base images ready - will be updated when you save` : 
                `${totalImages} base images ready - will be set after persona creation`;
            
            // Set selectedImageData to the front headshot for primary reference
            const frontHeadshot = sampleImages.find(img => img.type === 'front_headshot');
            if (frontHeadshot) {
                selectedImageData = frontHeadshot.data_url;
            }
        }
        
        function selectSampleImage(imageId) {
            // Toggle selection for individual images
            const card = document.getElementById(`image-card-${imageId}`);
            const image = sampleImages.find(img => img.id === imageId);
            
            if (!card || !image) return;
            
            const imageType = image.type || image.id;
            
            if (card.classList.contains('selected')) {
                // Deselect
                card.classList.remove('selected');
                delete selectedBaseImages[imageType];
            } else {
                // Select
                card.classList.add('selected');
                selectedBaseImages[imageType] = image.data_url;
            }
            
            // Update status based on how many are selected
            const selectedCount = Object.keys(selectedBaseImages).length;
            const totalGenerated = sampleImages.length;
            
            if (selectedCount >= totalGenerated && selectedCount >= 8) {
                document.getElementById('base_image_status').value = 'approved';
                document.getElementById('appearance_locked').checked = true;
                showAlert(`All ${selectedCount} base images selected! Your persona's appearance will be locked.`, 'success');
            } else if (selectedCount > 0) {
                document.getElementById('base_image_status').value = 'draft';
                showAlert(`${selectedCount}/${totalGenerated} images selected. Select all for complete appearance locking.`, 'info');
            } else {
                document.getElementById('base_image_status').value = 'pending_upload';
                document.getElementById('appearance_locked').checked = false;
            }
            
            // Update base_image_path field
            document.getElementById('base_image_path').value = selectedCount > 0 ? 
                `${selectedCount}/${totalGenerated} base images selected` : '';
            
            // Set selectedImageData to front_headshot for primary reference
            if (selectedBaseImages['front_headshot']) {
                selectedImageData = selectedBaseImages['front_headshot'];
            } else {
                selectedImageData = Object.values(selectedBaseImages)[0] || null;
            }
        }
        
        async function loadExistingBaseImage() {
            // Only load in edit mode
            if (editorMode !== 'edit' || !personaId) {
                return;
            }
            
            try {
                // Fetch the base image URLs for this persona
                const response = await fetch(`/api/v1/personas/${personaId}/base-image-url`);
                if (!response.ok) {
                    console.error('Failed to fetch base image URL');
                    return;
                }
                
                const data = await response.json();
                const baseImages = data.base_images || {};
                const hasMultipleImages = Object.keys(baseImages).length > 0;
                
                // Image type labels (same as in displaySampleImages)
                const typeLabels = {
                    // Phase 1: Structural
                    'front_headshot': 'üì∏ Front Headshot',
                    'side_headshot': 'üì∏ Side Headshot',
                    'right_hand': 'ü§ö Right Hand',
                    'left_hand': '‚úã Left Hand',
                    'bust': 'üë§ Bust View',
                    'full_frontal': 'üßç Full Frontal',
                    'side_profile': 'üßç Side Profile',
                    'rear_view': 'üßç Rear View',
                    // Phase 2: Action
                    'compression_pose': 'ü™ë Compression',
                    'extension_pose': 'üôÜ Extension',
                    'twist_pose': 'üîÑ Twist',
                    // Phase 3: Background
                    'complex_bg_1': 'üèôÔ∏è Urban BG',
                    'complex_bg_2': 'üå≤ Nature BG',
                    'complex_bg_3': 'üè† Interior BG'
                };
                
                // Phase colors for visual distinction
                const phaseColors = {
                    'structural': 'var(--primary)',
                    'action': 'var(--accent)',
                    'background': '#f59e0b'
                };
                
                // Determine image phase by type
                const getPhase = (imageType) => {
                    if (['front_headshot', 'side_headshot', 'right_hand', 'left_hand', 'bust', 'full_frontal', 'side_profile', 'rear_view'].includes(imageType)) {
                        return 'structural';
                    } else if (['compression_pose', 'extension_pose', 'twist_pose'].includes(imageType)) {
                        return 'action';
                    } else if (['complex_bg_1', 'complex_bg_2', 'complex_bg_3'].includes(imageType)) {
                        return 'background';
                    }
                    return 'structural';
                };
                
                // If we have multiple base images from the expanded system, display them all
                if (hasMultipleImages) {
                    const gallery = document.getElementById('image-gallery');
                    gallery.innerHTML = '';
                    gallery.style.display = 'grid';
                    // Adjust grid for number of images
                    const imageCount = Object.keys(baseImages).length;
                    gallery.style.gridTemplateColumns = imageCount > 4 ? 'repeat(4, 1fr)' : 'repeat(2, 1fr)';
                    
                    // Sort images by phase and type for consistent display
                    const sortOrder = [
                        'front_headshot', 'side_headshot', 'right_hand', 'left_hand',
                        'bust', 'full_frontal', 'side_profile', 'rear_view',
                        'compression_pose', 'extension_pose', 'twist_pose',
                        'complex_bg_1', 'complex_bg_2', 'complex_bg_3'
                    ];
                    
                    const sortedTypes = Object.keys(baseImages).sort((a, b) => {
                        const indexA = sortOrder.indexOf(a);
                        const indexB = sortOrder.indexOf(b);
                        return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
                    });
                    
                    // Create cards for each existing base image
                    for (const imageType of sortedTypes) {
                        const imageUrl = baseImages[imageType];
                        if (!imageUrl) continue;
                        
                        const phase = getPhase(imageType);
                        const phaseColor = phaseColors[phase] || 'var(--primary)';
                        const label = typeLabels[imageType] || imageType;
                        const isBaseRef = imageType === 'front_headshot' ? '<span style="font-size: 0.65rem; color: var(--accent);">(Base Reference)</span>' : '';
                        
                        const card = document.createElement('div');
                        card.className = 'image-card selected';
                        card.id = `existing-base-image-${imageType}`;
                        
                        // Phase badge
                        const phaseBadge = `<span style="position: absolute; top: 8px; left: 8px; background: ${phaseColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; text-transform: uppercase;">${phase}</span>`;
                        
                        // Locked badge
                        const lockedBadge = data.appearance_locked 
                            ? '<span class="selected-badge">üîí</span>' 
                            : '<span class="selected-badge">‚úì</span>';
                        
                        card.innerHTML = `
                            ${phaseBadge}
                            ${lockedBadge}
                            <img src="${imageUrl}" alt="${label}" onerror="this.parentElement.style.display='none'" style="width: 100%; height: auto; border-radius: 8px;">
                            <div class="image-card-label">${label} ${isBaseRef}</div>
                        `;
                        
                        gallery.appendChild(card);
                    }
                    
                    // Show info message
                    const statusText = data.appearance_locked ? 'locked and being used for ControlNet consistency' : 'set but not locked';
                    const imageCountText = Object.keys(baseImages).length;
                    showAlert(`This persona has ${imageCountText} base images that are ${statusText}. You can generate new samples to update them.`, 'info');
                    
                } else if (data.base_image_url) {
                    // Fallback: Show single legacy base image
                    const gallery = document.getElementById('image-gallery');
                    gallery.innerHTML = '';
                    gallery.style.display = 'grid';
                    gallery.style.gridTemplateColumns = 'repeat(2, 1fr)';
                    
                    // Create a card for the existing base image
                    const card = document.createElement('div');
                    card.className = 'image-card selected';
                    card.id = 'existing-base-image';
                    
                    // Add locked badge if appearance is locked
                    const lockedBadge = data.appearance_locked ? '<span class="selected-badge">üîí Locked</span>' : '<span class="selected-badge">‚úì Current</span>';
                    
                    card.innerHTML = `
                        ${lockedBadge}
                        <img src="${data.base_image_url}" alt="Current Base Image" onerror="this.parentElement.style.display='none'">
                        <div class="image-card-label">Current Base Image (Legacy)</div>
                    `;
                    
                    gallery.appendChild(card);
                    
                    // Show info message
                    const statusText = data.appearance_locked ? 'locked and being used for consistency' : 'set but not locked';
                    showAlert(`This persona has a legacy single base image that is ${statusText}. Consider generating the full 14-image set for better ControlNet consistency.`, 'info');
                }
            } catch (error) {
                console.error('Failed to load existing base images:', error);
                // Don't show error to user, just log it
            }
        }
        
        // RSS Feed Assignment Functions
        async function loadAvailableFeeds() {
            try {
                const response = await fetch('/api/v1/feeds/rss?active_only=true');
                const data = await response.json();
                availableFeeds = data.feeds || [];
            } catch (error) {
                console.error('Failed to load available feeds:', error);
                availableFeeds = [];
            }
        }
        
        // Store installed models by category
        let installedModels = {
            text: [],
            image: [],
            video: [],
            voice: [],
            audio: []
        };
        
        // Helper function to build model options HTML for dropdowns
        function buildModelOptionsHtml(selectedModel = null) {
            let html = '';
            
            // Add image models as options
            const imageModels = installedModels.image || [];
            if (imageModels.length > 0) {
                html += '<optgroup label="Image Models">';
                imageModels.forEach(model => {
                    const isSelected = selectedModel && (
                        model.name === selectedModel ||
                        (model.display_name && model.display_name === selectedModel)
                    );
                    const displayName = model.display_name || model.name;
                    const loadedIndicator = model.loaded ? ' ‚úì' : '';
                    const isLora = model.model_type === 'lora' || model.name.toLowerCase().includes('lora');
                    if (!isLora) {  // Exclude LoRAs from main model list
                        html += `<option value="${escapeHtml(model.name)}" ${isSelected ? 'selected' : ''}>${escapeHtml(displayName)}${loadedIndicator}</option>`;
                    }
                });
                html += '</optgroup>';
            }
            
            return html;
        }
        
        // Helper function to build LoRA options HTML for dropdowns
        function buildLoraOptionsHtml(selectedLora = null) {
            let html = '';
            
            const imageModels = installedModels.image || [];
            const loraModels = imageModels.filter(model => 
                model.model_type === 'lora' || 
                model.name.toLowerCase().includes('lora') ||
                (model.base_model && model.base_model.toLowerCase() !== model.name.toLowerCase())
            );
            
            if (loraModels.length > 0) {
                loraModels.forEach(model => {
                    const isSelected = selectedLora && (
                        model.name === selectedLora ||
                        (model.display_name && model.display_name === selectedLora)
                    );
                    const displayName = model.display_name || model.name;
                    const loadedIndicator = model.loaded ? ' ‚úì' : '';
                    html += `<option value="${escapeHtml(model.name)}" ${isSelected ? 'selected' : ''}>${escapeHtml(displayName)}${loadedIndicator}</option>`;
                });
            }
            
            // If no LoRAs found, add a placeholder
            if (loraModels.length === 0) {
                html = '<option value="" disabled>No LoRAs installed</option>';
            }
            
            return html;
        }
        
        async function loadInstalledModels() {
            const loadingIndicator = document.getElementById('models-loading-indicator');
            const modelsGrid = document.getElementById('models-grid');
            const modelsError = document.getElementById('models-error');
            
            try {
                // Fetch installed models from the API
                const response = await fetch('/api/v1/setup/ai-models/status');
                
                if (!response.ok) {
                    throw new Error('Failed to fetch models');
                }
                
                const data = await response.json();
                const models = data.installed_models || [];
                
                // Group models by category
                installedModels = {
                    text: [],
                    image: [],
                    video: [],
                    voice: [],
                    audio: []
                };
                
                models.forEach(model => {
                    const category = model.category || 'other';
                    if (installedModels[category]) {
                        installedModels[category].push({
                            name: model.name,
                            display_name: model.display_name || model.name,
                            loaded: model.loaded,
                            source: model.source,
                            provider: model.provider,
                            size_gb: model.size_gb,
                            description: model.description,
                            model_type: model.model_type,
                            base_model: model.base_model
                        });
                    }
                });
                
                // Populate the dropdowns
                populateModelDropdown('text_model_preference', installedModels.text, 'Text Models');
                populateModelDropdown('image_model_preference', installedModels.image, 'Image Models');
                populateModelDropdown('video_model_preference', installedModels.video, 'Video Models');
                populateModelDropdown('voice_model_preference', installedModels.voice.concat(installedModels.audio), 'Voice/Audio Models');
                
                // Also populate the NSFW model preference with image models
                populateModelDropdown('nsfw_model_preference', installedModels.image, 'NSFW Image Models');
                
                // Populate the base generation model dropdown (for initial headshot generation)
                populateModelDropdown('base-gen-model-select', installedModels.image, 'Base Generation Models');
                
                // Show the grid, hide loading indicator
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                if (modelsGrid) modelsGrid.style.display = 'grid';
                
                console.log(`Loaded ${models.length} installed models`);
                
            } catch (error) {
                console.error('Failed to load installed models:', error);
                
                // Show error and still show the grid with empty dropdowns
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                if (modelsGrid) modelsGrid.style.display = 'grid';
                if (modelsError) modelsError.style.display = 'block';
                
                // Add a fallback option for manual input
                ['text_model_preference', 'image_model_preference', 'video_model_preference', 'voice_model_preference', 'base-gen-model-select'].forEach(id => {
                    const select = document.getElementById(id);
                    if (select && select.options.length === 1) {
                        // Only has "Use System Default" - add a note
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '(No models detected - check AI Models page)';
                        option.disabled = true;
                        select.appendChild(option);
                    }
                });
            }
        }
        
        function populateModelDropdown(selectId, models, groupLabel) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Clear existing options except the first one (Use System Default)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            if (models.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '(No models installed)';
                option.disabled = true;
                select.appendChild(option);
                return;
            }
            
            // Group models by source/provider
            const localModels = models.filter(m => m.source === 'local' || m.source === 'civitai' || m.provider === 'local');
            const ollamaModels = models.filter(m => m.source === 'ollama' || m.provider === 'ollama');
            const cloudModels = models.filter(m => m.source === 'cloud' || m.provider === 'openai' || m.provider === 'anthropic' || m.provider === 'elevenlabs');
            const otherModels = models.filter(m => 
                !localModels.includes(m) && !ollamaModels.includes(m) && !cloudModels.includes(m)
            );
            
            // Add local models group
            if (localModels.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'üíæ Local Models';
                localModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    let label = model.display_name || model.name;
                    if (model.loaded) label += ' ‚úì';
                    if (model.size_gb) label += ` (${model.size_gb}GB)`;
                    option.textContent = label;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
            
            // Add Ollama models group
            if (ollamaModels.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'ü¶ô Ollama Models';
                ollamaModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    let label = model.display_name || model.name;
                    if (model.loaded) label += ' ‚úì';
                    option.textContent = label;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
            
            // Add cloud models group
            if (cloudModels.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = '‚òÅÔ∏è Cloud Models';
                cloudModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.display_name || model.name;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
            
            // Add other models group
            if (otherModels.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'üì¶ Other Models';
                otherModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    let label = model.display_name || model.name;
                    if (model.loaded) label += ' ‚úì';
                    option.textContent = label;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
            
            // Check if there's a stored preferred model from persona data
            // (set when persona is loaded before models are fetched)
            if (select.dataset.preferredModel) {
                const preferredModel = select.dataset.preferredModel;
                // Check if this model exists in the dropdown
                const options = Array.from(select.options);
                const matchingOption = options.find(opt => opt.value === preferredModel);
                if (matchingOption) {
                    select.value = preferredModel;
                    console.log(`Set ${selectId} to preferred model: ${preferredModel}`);
                } else {
                    console.log(`Preferred model ${preferredModel} not found in ${selectId} options`);
                }
                // Clear the stored preference to avoid re-applying on subsequent loads
                delete select.dataset.preferredModel;
            }
        }
        
        async function loadAssignedFeeds() {
            if (editorMode !== 'edit' || !personaId) {
                renderAssignedFeeds();
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/feeds/personas/${personaId}/feeds`);
                if (response.ok) {
                    assignedFeeds = await response.json();
                }
            } catch (error) {
                console.error('Failed to load assigned feeds:', error);
                assignedFeeds = [];
            }
            
            renderAssignedFeeds();
        }
        
        function renderAssignedFeeds() {
            const container = document.getElementById('assigned-feeds-container');
            
            if (assignedFeeds.length === 0) {
                container.innerHTML = `
                    <p style="color: var(--text-secondary); font-size: 0.85rem; padding: 12px; background: var(--dark-card); border-radius: 8px;">
                        No RSS feeds assigned yet. Click "Assign RSS Feed" to add content sources.
                    </p>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            assignedFeeds.forEach((assignment, index) => {
                const card = document.createElement('div');
                card.className = 'feed-assignment-card';
                
                const topicsHtml = (assignment.topics || []).map(topic => 
                    `<span class="topic-tag">${topic}</span>`
                ).join('');
                
                const categoriesHtml = (assignment.feed_categories || []).map(cat => 
                    `<span class="category-tag" style="background: rgba(102, 126, 234, 0.3);">${cat}</span>`
                ).join('');
                
                card.innerHTML = `
                    <div class="feed-assignment-header">
                        <div class="feed-assignment-title">üì° ${assignment.feed_name || 'RSS Feed'}</div>
                        <button type="button" class="remove-btn" onclick="removeAssignedFeed(${index})">√ó</button>
                    </div>
                    <div class="feed-assignment-url">${assignment.feed_url || ''}</div>
                    ${categoriesHtml ? `<div style="margin-bottom: 8px;">${categoriesHtml}</div>` : ''}
                    ${topicsHtml ? `
                        <div>
                            <span style="font-size: 0.8rem; color: var(--text-secondary);">Filtered Topics:</span>
                            <div class="feed-topics">${topicsHtml}</div>
                        </div>
                    ` : ''}
                    <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-secondary);">
                        Priority: ${assignment.priority || 50}/100
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        function removeAssignedFeed(index) {
            assignedFeeds.splice(index, 1);
            renderAssignedFeeds();
        }
        
        async function showAssignFeedModal() {
            // Load available feeds if not already loaded
            if (availableFeeds.length === 0) {
                await loadAvailableFeeds();
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay show';
            modal.id = 'feed-assign-modal';
            
            const feedsListHtml = availableFeeds.map(feed => {
                const categoriesHtml = (feed.categories || []).map(cat => 
                    `<span class="category-chip">${cat}</span>`
                ).join('');
                
                return `
                    <div class="feed-select-item" onclick="selectFeedForAssignment('${feed.id}')">
                        <div class="feed-select-name">üì° ${feed.name}</div>
                        <div class="feed-select-url">${feed.url}</div>
                        ${categoriesHtml ? `<div class="category-chips">${categoriesHtml}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div class="modal-dialog">
                    <h2 class="modal-header">Assign RSS Feed</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Select Feed</label>
                        <div class="feed-select-list" id="feed-select-list">
                            ${feedsListHtml || '<p style="text-align: center; color: var(--text-secondary);">No RSS feeds available. Add feeds in the RSS page first.</p>'}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Filter by Topics (comma-separated, optional)</label>
                        <input type="text" class="form-input" id="feed-topics" placeholder="technology, AI, innovation">
                        <span class="form-help">Leave empty to use all content from the feed</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Priority (0-100)</label>
                        <input type="number" class="form-input" id="feed-priority" value="50" min="0" max="100">
                        <span class="form-help">Higher priority feeds are preferred for content suggestions</span>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeFeedAssignModal()">Cancel</button>
                        <button type="button" class="btn btn-primary" id="assign-feed-btn" onclick="assignSelectedFeed()" disabled>Assign Feed</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeFeedAssignModal();
            });
        }
        
        let selectedFeedForAssignment = null;
        
        function selectFeedForAssignment(feedId) {
            // Remove previous selection
            document.querySelectorAll('.feed-select-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Mark new selection
            const items = document.querySelectorAll('.feed-select-item');
            items.forEach(item => {
                if (item.onclick.toString().includes(feedId)) {
                    item.classList.add('selected');
                }
            });
            
            selectedFeedForAssignment = feedId;
            document.getElementById('assign-feed-btn').disabled = false;
        }
        
        function assignSelectedFeed() {
            if (!selectedFeedForAssignment) {
                alert('Please select a feed');
                return;
            }
            
            const feed = availableFeeds.find(f => f.id === selectedFeedForAssignment);
            if (!feed) {
                alert('Feed not found');
                return;
            }
            
            const topicsStr = document.getElementById('feed-topics').value.trim();
            const topics = topicsStr ? topicsStr.split(',').map(t => t.trim()).filter(t => t) : [];
            const priority = parseInt(document.getElementById('feed-priority').value) || 50;
            
            // Check if already assigned
            if (assignedFeeds.some(a => a.feed_id === feed.id)) {
                alert('This feed is already assigned to this persona');
                return;
            }
            
            // Add to assigned feeds
            assignedFeeds.push({
                feed_id: feed.id,
                feed_name: feed.name,
                feed_url: feed.url,
                feed_categories: feed.categories || [],
                topics: topics,
                priority: priority,
                is_active: true
            });
            
            renderAssignedFeeds();
            closeFeedAssignModal();
            showAlert('RSS feed assigned successfully!', 'success');
        }
        
        function closeFeedAssignModal() {
            const modal = document.getElementById('feed-assign-modal');
            if (modal) modal.remove();
            selectedFeedForAssignment = null;
        }
        
        // Form submission
        document.getElementById('persona-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            document.getElementById('submit-text').textContent = editorMode === 'create' ? 'Creating...' : 'Updating...';
            
            try {
                // Get optimism scale value (convert to int or null)
                const optimismValue = document.getElementById('optimism_cynicism_scale').value;
                const optimismInt = optimismValue ? parseInt(optimismValue, 10) : null;
                
                // Collect form data
                const formData = {
                    name: document.getElementById('name').value.trim(),
                    appearance: document.getElementById('appearance').value.trim(),
                    personality: document.getElementById('personality').value.trim(),
                    content_themes: themes,
                    style_preferences: stylePreferences,
                    default_content_rating: document.querySelector('input[name="default_content_rating"]:checked').value,
                    allowed_content_ratings: Array.from(document.querySelectorAll('input[name="allowed_ratings"]:checked')).map(cb => cb.value),
                    platform_restrictions: platformRestrictions,
                    base_appearance_description: document.getElementById('base_appearance_description').value.trim() || null,
                    appearance_locked: document.getElementById('appearance_locked').checked,
                    base_image_status: document.getElementById('base_image_status').value,
                    base_image_path: document.getElementById('base_image_path').value.trim() || null,
                    image_style: document.getElementById('image_style').value,
                    default_negative_prompt: document.getElementById('persona_negative_prompt').value.trim() || null,
                    default_image_resolution: document.getElementById('default_image_resolution').value,
                    default_video_resolution: document.getElementById('default_video_resolution').value,
                    post_style: document.getElementById('post_style').value,
                    video_types: Array.from(document.querySelectorAll('input[name="video_types"]:checked')).map(cb => cb.value),
                    nsfw_model_preference: document.getElementById('nsfw_model_preference').value || null,
                    generation_quality: document.getElementById('generation_quality').value,
                    is_active: document.getElementById('is_active').checked,
                    
                    // ==================== AI MODEL PREFERENCES ====================
                    text_model_preference: document.getElementById('text_model_preference').value || null,
                    image_model_preference: document.getElementById('image_model_preference').value || null,
                    video_model_preference: document.getElementById('video_model_preference').value || null,
                    voice_model_preference: document.getElementById('voice_model_preference').value || null,
                    
                    // ==================== DETAILED PHYSICAL APPEARANCE ====================
                    sex: document.getElementById('sex').value || null,
                    age_appearance: document.getElementById('age_appearance').value || null,
                    ethnicity: document.getElementById('ethnicity').value || null,
                    skin_tone: document.getElementById('skin_tone').value || null,
                    hair_color: document.getElementById('hair_color').value || null,
                    hair_style: document.getElementById('hair_style').value.trim() || null,
                    eye_color: document.getElementById('eye_color').value || null,
                    height: document.getElementById('height').value.trim() || null,
                    weight: document.getElementById('weight').value.trim() || null,
                    build_type: document.getElementById('build_type').value || null,
                    muscle_tone: document.getElementById('muscle_tone').value || null,
                    measurements: document.getElementById('measurements').value.trim() || null,
                    cup_size: document.getElementById('cup_size').value || null,
                    distinctive_features: document.getElementById('distinctive_features').value.trim() || null,
                    body_modifications: bodyModifications,
                    
                    // ==================== SEXUALITY & PREFERENCES ====================
                    sexual_orientation: document.getElementById('sexual_orientation').value || null,
                    turn_ons: turnOns,
                    turn_offs: turnOffs,
                    
                    // ==================== PERSONA SOUL FIELDS ====================
                    // Origin & Demographics
                    hometown: document.getElementById('hometown').value.trim() || null,
                    current_location: document.getElementById('current_location').value.trim() || null,
                    generation_age: document.getElementById('generation_age').value.trim() || null,
                    education_level: document.getElementById('education_level').value.trim() || null,
                    
                    // Psychological Profile
                    mbti_type: document.getElementById('mbti_type').value || null,
                    enneagram_type: document.getElementById('enneagram_type').value || null,
                    political_alignment: document.getElementById('political_alignment').value.trim() || null,
                    risk_tolerance: document.getElementById('risk_tolerance').value.trim() || null,
                    optimism_cynicism_scale: optimismInt,
                    
                    // Voice & Speech Patterns
                    linguistic_register: document.getElementById('linguistic_register').value,
                    typing_quirks: typingQuirks,
                    signature_phrases: signaturePhrases,
                    trigger_topics: triggerTopics,
                    
                    // Backstory & Lore
                    day_job: document.getElementById('day_job').value.trim() || null,
                    war_story: document.getElementById('war_story').value.trim() || null,
                    vices_hobbies: vicesHobbies,
                    
                    // Anti-Pattern
                    forbidden_phrases: forbiddenPhrases,
                    warmth_level: document.getElementById('warmth_level').value,
                    patience_level: document.getElementById('patience_level').value,
                    
                    // ==================== TRIGGER-BASED MODEL ORCHESTRATION ====================
                    content_triggers: buildContentTriggersConfig()
                };
                
                // Validate at least one allowed rating
                if (formData.allowed_content_ratings.length === 0) {
                    showAlert('Please select at least one allowed content rating.', 'error');
                    submitBtn.disabled = false;
                    document.getElementById('submit-text').textContent = editorMode === 'create' ? 'Create Persona' : 'Update Persona';
                    return;
                }
                
                // Make API request
                const url = editorMode === 'create' ? '/api/v1/personas/' : `/api/v1/personas/${personaId}`;
                const method = editorMode === 'create' ? 'POST' : 'PUT';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save persona');
                }
                
                const result = await response.json();
                const personaIdToUse = result.id;
                
                // If user selected base images, set them using the expanded endpoint
                if (Object.keys(selectedBaseImages).length > 0) {
                    try {
                        document.getElementById('submit-text').textContent = 'Setting base images...';
                        
                        // Use the new endpoint that accepts all 14 expanded base images
                        const imageResponse = await fetch(`/api/v1/personas/${personaIdToUse}/set-base-images`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                // Phase 1: Structural Set
                                front_headshot: selectedBaseImages['front_headshot'] || null,
                                side_headshot: selectedBaseImages['side_headshot'] || null,
                                right_hand: selectedBaseImages['right_hand'] || null,
                                left_hand: selectedBaseImages['left_hand'] || null,
                                bust: selectedBaseImages['bust'] || null,
                                full_frontal: selectedBaseImages['full_frontal'] || null,
                                side_profile: selectedBaseImages['side_profile'] || null,
                                rear_view: selectedBaseImages['rear_view'] || null,
                                // Phase 2: Action Set
                                compression_pose: selectedBaseImages['compression_pose'] || null,
                                extension_pose: selectedBaseImages['extension_pose'] || null,
                                twist_pose: selectedBaseImages['twist_pose'] || null,
                                // Phase 3: Background Variation
                                complex_bg_1: selectedBaseImages['complex_bg_1'] || null,
                                complex_bg_2: selectedBaseImages['complex_bg_2'] || null,
                                complex_bg_3: selectedBaseImages['complex_bg_3'] || null
                            })
                        });
                        
                        if (!imageResponse.ok) {
                            console.error(`Failed to set base images, but persona was ${editorMode === 'create' ? 'created' : 'updated'}`);
                        } else {
                            const imageCount = Object.keys(selectedBaseImages).filter(k => selectedBaseImages[k]).length;
                            console.log(`${imageCount} base images set successfully`);
                        }
                    } catch (imageError) {
                        console.error('Failed to set base images:', imageError);
                        // Don't fail the whole operation if image setting fails
                    }
                } else if (selectedImageData) {
                    // Fallback to single image endpoint for backward compatibility
                    try {
                        document.getElementById('submit-text').textContent = 'Setting base image...';
                        
                        const imageResponse = await fetch(`/api/v1/personas/${personaIdToUse}/set-base-image`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                image_data: selectedImageData
                            })
                        });
                        
                        if (!imageResponse.ok) {
                            console.error(`Failed to set base image, but persona was ${editorMode === 'create' ? 'created' : 'updated'}`);
                        } else {
                            console.log('Base image set successfully');
                        }
                    } catch (imageError) {
                        console.error('Failed to set base image:', imageError);
                    }
                }
                
                // Handle RSS feed assignments
                if (assignedFeeds.length > 0) {
                    try {
                        document.getElementById('submit-text').textContent = 'Assigning RSS feeds...';
                        
                        // When editing, we need to sync assignments (add new, remove old)
                        // For now, just assign all feeds (API will handle updates for existing ones)
                        for (const feed of assignedFeeds) {
                            try {
                                await fetch(`/api/v1/feeds/personas/${personaIdToUse}/feeds`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        feed_id: feed.feed_id,
                                        topics: feed.topics || [],
                                        priority: feed.priority || 50
                                    })
                                });
                            } catch (feedError) {
                                console.error('Failed to assign feed:', feedError);
                                // Continue with other feeds
                            }
                        }
                    } catch (error) {
                        console.error('Failed to assign RSS feeds:', error);
                        // Don't fail the whole operation
                    }
                }
                
                showAlert(`Persona ${editorMode === 'create' ? 'created' : 'updated'} successfully!`, 'success');
                
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = '/admin/personas';
                }, 1500);
                
            } catch (error) {
                console.error('Failed to save persona:', error);
                showAlert(error.message || 'Failed to save persona. Please try again.', 'error');
                submitBtn.disabled = false;
                document.getElementById('submit-text').textContent = editorMode === 'create' ? 'Create Persona' : 'Update Persona';
            }
        });
        
        // Delete persona
        async function deletePersona() {
            if (!confirm('Are you sure you want to delete this persona? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/personas/${personaId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete persona');
                }
                
                showAlert('Persona deleted successfully!', 'success');
                
                setTimeout(() => {
                    window.location.href = '/admin/personas';
                }, 1500);
                
            } catch (error) {
                console.error('Failed to delete persona:', error);
                showAlert('Failed to delete persona. Please try again.', 'error');
            }
        }
        
        // Theme input handler
        document.getElementById('theme-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = e.target;
                addTheme(input.value);
                input.value = '';
            }
        });
        
        // ==================== PERSONA SOUL FIELDS INPUT HANDLERS ====================
        
        // Signature Phrases input handler
        document.getElementById('signature-phrase-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = e.target;
                addSignaturePhrase(input.value);
                input.value = '';
            }
        });
        
        // Trigger Topics input handler
        document.getElementById('trigger-topic-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = e.target;
                addTriggerTopic(input.value);
                input.value = '';
            }
        });
        
        // Vices & Hobbies input handler
        document.getElementById('vices-hobbies-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = e.target;
                addViceHobby(input.value);
                input.value = '';
            }
        });
        
        // Forbidden Phrases input handler
        document.getElementById('forbidden-phrase-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = e.target;
                addForbiddenPhrase(input.value);
                input.value = '';
            }
        });
        
        // Body Modifications input handler
        document.getElementById('body-modification-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = e.target;
                addBodyModification(input.value);
                input.value = '';
            }
        });
        
        // Turn Ons input handler
        document.getElementById('turn-on-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = e.target;
                addTurnOn(input.value);
                input.value = '';
            }
        });
        
        // Turn Offs input handler
        document.getElementById('turn-off-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = e.target;
                addTurnOff(input.value);
                input.value = '';
            }
        });
        
        // Optimism/Cynicism scale slider handler
        document.getElementById('optimism_cynicism_scale').addEventListener('input', (e) => {
            document.getElementById('optimism_value').textContent = e.target.value;
        });
        
        // Persona Chat Testing Functions
        let chatHistory = [];
        let isChatting = false;
        
        // Build conversation history for context window
        function buildConversationHistory() {
            // Convert chatHistory to the format expected by the API
            // Only include the last 10 messages for context
            const recentMessages = chatHistory.slice(-10);
            // Filter out image-only messages and only include text messages for context
            return recentMessages
                .filter(msg => msg.type !== 'image')  // Exclude image-only messages
                .map(msg => ({
                    role: msg.type === 'user' ? 'user' : 'persona',
                    content: msg.text,
                    timestamp: msg.timestamp
                }));
        }
        
        function showChatSection() {
            // Only show chat section in edit mode (when persona exists)
            if (editorMode === 'edit' && personaId) {
                document.getElementById('chat-testing-section').style.display = 'block';
                
                // Auto-load proactive topics when showing the chat section
                autoLoadProactiveTopics();
            }
        }
        
        function handleChatKeydown(event) {
            // Send message on Enter (without Shift)
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || isChatting) return;
            
            if (!personaId) {
                showAlert('Please save the persona first before testing chat.', 'error');
                return;
            }
            
            isChatting = true;
            const sendBtn = document.getElementById('chat-send-btn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            
            // Update status
            const statusEl = document.getElementById('chat-status');
            const statusText = document.getElementById('chat-status-text');
            statusEl.classList.add('loading');
            statusText.textContent = 'Typing...';
            
            // Clear input
            input.value = '';
            
            // Hide empty state
            document.getElementById('chat-empty').style.display = 'none';
            
            // Add user message to chat
            addChatMessage(message, 'user');
            
            try {
                const response = await fetch(`/api/v1/personas/${personaId}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_history: buildConversationHistory()
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Chat request failed');
                }
                
                const data = await response.json();
                
                // Add persona response to chat
                addChatMessage(data.response, 'persona', data.persona_name, data.model_used);
                
                // If an image was generated, display it
                if (data.image_generated && data.image_data) {
                    addChatImage(data.image_data, data.persona_name, data.image_prompt);
                }
                
                // Update status (show ready state without model name for clean UI)
                statusEl.classList.remove('loading');
                const imageNote = data.image_generated ? ' üì∏' : '';
                statusText.textContent = `Ready${imageNote}`;
                
            } catch (error) {
                console.error('Chat error:', error);
                addChatMessage(`Error: ${error.message}`, 'persona', 'System', 'error');
                
                // Update status
                statusEl.classList.remove('loading');
                statusText.textContent = 'Error occurred - try again';
                
                showAlert(`Chat error: ${error.message}`, 'error');
            } finally {
                isChatting = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
                input.focus();
            }
        }
        
        function addChatMessage(text, type, senderName = null, modelInfo = null) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            let html = '';
            
            if (type === 'persona' && senderName) {
                html += `<div class="sender">${senderName}</div>`;
            } else if (type === 'user') {
                html += `<div class="sender">You</div>`;
            }
            
            html += `<div class="content">${escapeHtml(text)}</div>`;
            
            // Model info is stored in history for debugging but not displayed in UI
            // Users should see persona responses without technical model attribution
            
            messageDiv.innerHTML = html;
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Store in history
            chatHistory.push({
                type: type,
                text: text,
                sender: senderName,
                model: modelInfo,
                timestamp: new Date().toISOString()
            });
        }
        
        function addChatImage(imageData, senderName, imagePrompt = null) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message persona';
            
            let html = `<div class="sender">${senderName} üì∏</div>`;
            html += `<div class="content">`;
            html += `<img src="${imageData}" alt="Generated image" style="max-width: 100%; border-radius: 8px; margin: 8px 0;" />`;
            if (imagePrompt) {
                // Safely truncate prompt to ~100 chars without cutting multi-byte characters
                const truncatedPrompt = imagePrompt.length > 100 
                    ? [...imagePrompt].slice(0, 100).join('') + '...'
                    : imagePrompt;
                html += `<div class="image-prompt" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px; font-style: italic;">Prompt: ${escapeHtml(truncatedPrompt)}</div>`;
            }
            html += `</div>`;
            
            messageDiv.innerHTML = html;
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Store image in history as special message
            chatHistory.push({
                type: 'image',
                text: '[Image]',
                sender: senderName,
                imageData: imageData,
                imagePrompt: imagePrompt,
                timestamp: new Date().toISOString()
            });
        }
        
        function escapeHtml(text) {
            // First escape the HTML entities
            const div = document.createElement('div');
            div.textContent = text;
            const escaped = div.innerHTML;
            // Then convert newlines to <br> tags (safe since input was escaped)
            return escaped.split('\n').map(line => {
                // Each line is already escaped, join with <br>
                return line;
            }).join('<br>');
        }
        
        function clearChatHistory() {
            chatHistory = [];
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="chat-empty-state" id="chat-empty">
                    <div class="icon">üí¨</div>
                    <div>Start a conversation with your persona</div>
                    <div style="font-size: 0.8rem; margin-top: 8px;">
                        Type a message below to see how they respond
                    </div>
                </div>
            `;
            
            // Reset status
            const statusEl = document.getElementById('chat-status');
            const statusText = document.getElementById('chat-status-text');
            statusEl.classList.remove('loading');
            statusText.textContent = 'Ready to chat';
        }
        
        // ==================== PROACTIVE TOPICS FUNCTIONS ====================
        
        // Store proactive topics state
        let proactiveTopics = [];
        let currentProactiveOpinion = null;
        
        async function refreshProactiveTopics() {
            if (!currentPersonaId) {
                showAlert('Please save the persona first to load proactive topics.', 'warning');
                return;
            }
            
            const container = document.getElementById('proactive-topics-container');
            container.innerHTML = `
                <div class="loading-state" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                    <div>‚è≥ Loading proactive topics...</div>
                </div>
            `;
            
            try {
                const response = await fetch(`/api/v1/feeds/proactive/${currentPersonaId}/topics?limit=5&hours_window=48`);
                
                if (!response.ok) {
                    throw new Error(`Failed to load topics: ${response.status}`);
                }
                
                proactiveTopics = await response.json();
                
                if (!proactiveTopics || proactiveTopics.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            <div>üì≠ No topics available</div>
                            <div style="font-size: 0.8rem; margin-top: 4px;">
                                Assign RSS feeds to this persona or add content themes for auto-generated topics.
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Render topics
                renderProactiveTopics(proactiveTopics);
                
            } catch (error) {
                console.error('Error loading proactive topics:', error);
                container.innerHTML = `
                    <div class="error-state" style="text-align: center; padding: 20px; color: var(--danger);">
                        <div>‚ùå Failed to load topics</div>
                        <div style="font-size: 0.8rem; margin-top: 4px; color: var(--text-secondary);">${error.message}</div>
                    </div>
                `;
            }
        }
        
        function renderProactiveTopics(topics) {
            const container = document.getElementById('proactive-topics-container');
            
            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            
            topics.forEach((topic, index) => {
                const sourceIcon = topic.source === 'rss' ? 'üì∞' : 'üí≠';
                const sentimentIcon = topic.sentiment_score > 0.2 ? 'üòä' : (topic.sentiment_score < -0.2 ? 'üòü' : 'üòê');
                const relevanceBar = Math.min(100, topic.relevance_score || 50);
                
                html += `
                    <div class="proactive-topic-card" style="padding: 12px; background: var(--dark-surface); border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s;" onclick="selectProactiveTopic(${index})">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="font-weight: 600; font-size: 0.9rem; flex: 1;">${sourceIcon} ${escapeHtml(topic.title || 'Untitled')}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-left: 8px;">${sentimentIcon}</div>
                        </div>
                        ${topic.summary ? `<div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.4;">${escapeHtml(topic.summary.substring(0, 120))}${topic.summary.length > 120 ? '...' : ''}</div>` : ''}
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; gap: 4px;">
                                ${(topic.categories || []).slice(0, 3).map(cat => `<span style="font-size: 0.7rem; padding: 2px 6px; background: var(--primary); color: white; border-radius: 4px;">${escapeHtml(cat)}</span>`).join('')}
                            </div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">
                                Relevance: ${relevanceBar}%
                            </div>
                        </div>
                        <div style="margin-top: 8px;">
                            <button type="button" class="btn btn-primary" onclick="event.stopPropagation(); generateOpinionForTopic(${index})" style="padding: 6px 12px; font-size: 0.8rem;">
                                üí≠ Generate Opinion
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function selectProactiveTopic(index) {
            const topic = proactiveTopics[index];
            if (!topic) return;
            
            // Highlight the selected topic
            const cards = document.querySelectorAll('.proactive-topic-card');
            cards.forEach((card, i) => {
                if (i === index) {
                    card.style.borderColor = 'var(--primary)';
                    card.style.background = 'rgba(102, 126, 234, 0.1)';
                } else {
                    card.style.borderColor = 'var(--border-color)';
                    card.style.background = 'var(--dark-surface)';
                }
            });
        }
        
        async function generateOpinionForTopic(index) {
            const topic = proactiveTopics[index];
            if (!topic || !currentPersonaId) {
                showAlert('Please select a topic and save the persona first.', 'warning');
                return;
            }
            
            // Show loading state in the opinion preview
            const previewPanel = document.getElementById('proactive-opinion-preview');
            previewPanel.style.display = 'block';
            document.getElementById('proactive-opinion-topic').textContent = `Topic: ${topic.title}`;
            document.getElementById('proactive-opinion-text').innerHTML = '<em style="color: var(--text-secondary);">‚è≥ Generating opinion...</em>';
            document.getElementById('proactive-opinion-sentiment').textContent = '';
            
            try {
                const response = await fetch(`/api/v1/feeds/proactive/${currentPersonaId}/opinion`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: topic.title,
                        topic_summary: topic.summary || null,
                        use_ai: true
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to generate opinion: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    currentProactiveOpinion = result;
                    document.getElementById('proactive-opinion-text').textContent = result.opinion;
                    
                    const sentimentEmoji = result.sentiment === 'positive' ? 'üòä Positive' : 
                                          (result.sentiment === 'negative' ? 'üòü Negative' : 'üòê Neutral');
                    document.getElementById('proactive-opinion-sentiment').textContent = `Sentiment: ${sentimentEmoji}`;
                    
                    showAlert('Opinion generated successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
                
            } catch (error) {
                console.error('Error generating opinion:', error);
                document.getElementById('proactive-opinion-text').innerHTML = `<em style="color: var(--danger);">‚ùå ${error.message}</em>`;
                showAlert(`Failed to generate opinion: ${error.message}`, 'error');
            }
        }
        
        function closeProactiveOpinion() {
            document.getElementById('proactive-opinion-preview').style.display = 'none';
            currentProactiveOpinion = null;
        }
        
        function copyProactiveOpinion() {
            if (!currentProactiveOpinion) return;
            
            const text = currentProactiveOpinion.opinion;
            navigator.clipboard.writeText(text).then(() => {
                showAlert('Opinion copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showAlert('Failed to copy to clipboard', 'error');
            });
        }
        
        function discussProactiveOpinion() {
            if (!currentProactiveOpinion) return;
            
            // Put the topic in the chat input for further discussion
            const chatInput = document.getElementById('chat-input');
            chatInput.value = `I saw this topic: "${currentProactiveOpinion.topic}" - can you tell me more about what you think?`;
            chatInput.focus();
            
            // Scroll to the chat section
            document.getElementById('chat-input-area')?.scrollIntoView({ behavior: 'smooth' });
            
            showAlert('Topic added to chat - send to continue the conversation!', 'info');
        }
        
        // Auto-load proactive topics when editing a persona
        function autoLoadProactiveTopics() {
            if (currentPersonaId) {
                // Small delay to let the page settle
                setTimeout(() => {
                    refreshProactiveTopics();
                }, 500);
            }
        }
        
        // ==================== QUICK TEST FUNCTIONS ====================
        
        // Store current RSS topic for discussion
        let currentRssTopic = null;
        
        function testRssFeedReaction() {
            // Show the RSS test panel
            document.getElementById('rss-test-panel').style.display = 'block';
            
            // Populate the feed selector with assigned feeds
            populateRssFeedSelector();
        }
        
        function closeRssTestPanel() {
            document.getElementById('rss-test-panel').style.display = 'none';
            currentRssTopic = null;
            document.getElementById('rss-topic-preview').style.display = 'none';
            document.getElementById('rss-discuss-btn').disabled = true;
        }
        
        function populateRssFeedSelector() {
            const select = document.getElementById('rss-test-feed-select');
            select.innerHTML = '';
            
            if (assignedFeeds.length === 0) {
                select.innerHTML = '<option value="">No feeds assigned to this persona</option>';
                return;
            }
            
            // Add option for random from all feeds
            select.innerHTML = '<option value="random">üé≤ Random from all assigned feeds</option>';
            
            // Add each assigned feed
            assignedFeeds.forEach(feed => {
                const option = document.createElement('option');
                option.value = feed.feed_id;
                option.textContent = `üì° ${feed.feed_name}`;
                select.appendChild(option);
            });
        }
        
        async function fetchRandomRssTopic() {
            const select = document.getElementById('rss-test-feed-select');
            const feedId = select.value;
            
            if (!feedId && assignedFeeds.length === 0) {
                showAlert('No RSS feeds assigned to this persona. Add feeds first.', 'error');
                return;
            }
            
            try {
                // Fetch random article from the feed(s)
                let url = '/api/v1/feeds/rss/articles/random';
                if (feedId && feedId !== 'random') {
                    url += `?feed_id=${feedId}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    // If random endpoint doesn't exist, try fetching from the feed
                    const feedIdToUse = feedId || (assignedFeeds.length > 0 ? assignedFeeds[0].feed_id : null);
                    if (!feedIdToUse) {
                        throw new Error('No feed available');
                    }
                    const alternateResponse = await fetch(`/api/v1/feeds/rss/${feedIdToUse}/articles?limit=10`);
                    if (alternateResponse.ok) {
                        const articles = await alternateResponse.json();
                        if (articles && Array.isArray(articles) && articles.length > 0) {
                            // Pick a random article
                            const randomArticle = articles[Math.floor(Math.random() * articles.length)];
                            if (randomArticle) {
                                currentRssTopic = {
                                    title: randomArticle.title || 'Untitled',
                                    summary: randomArticle.summary || randomArticle.description || '',
                                    link: randomArticle.link || '',
                                    source: randomArticle.feed_name || 'RSS Feed'
                                };
                            }
                        } else {
                            throw new Error('No articles found in feed');
                        }
                    } else {
                        throw new Error('Could not fetch RSS articles');
                    }
                } else {
                    currentRssTopic = await response.json();
                }
                
                // Display the topic
                if (currentRssTopic) {
                    document.getElementById('rss-topic-preview').style.display = 'block';
                    document.getElementById('rss-topic-title').textContent = currentRssTopic.title || 'Untitled Article';
                    document.getElementById('rss-topic-summary').textContent = 
                        (currentRssTopic.summary || currentRssTopic.description || 'No summary available').substring(0, 200) + '...';
                    document.getElementById('rss-discuss-btn').disabled = false;
                }
                
            } catch (error) {
                console.error('Failed to fetch RSS topic:', error);
                // Generate a sample topic for testing
                currentRssTopic = {
                    title: 'Sample Topic: AI Revolution in Content Creation',
                    summary: 'New AI tools are transforming how content creators work, offering unprecedented capabilities for generating text, images, and videos. What are your thoughts on this?',
                    source: 'Test Feed'
                };
                document.getElementById('rss-topic-preview').style.display = 'block';
                document.getElementById('rss-topic-title').textContent = currentRssTopic.title;
                document.getElementById('rss-topic-summary').textContent = currentRssTopic.summary;
                document.getElementById('rss-discuss-btn').disabled = false;
                showAlert('Using sample topic for testing (RSS fetch failed)', 'info');
            }
        }
        
        async function testRssTopicDiscussion() {
            if (!currentRssTopic) {
                showAlert('Please fetch a topic first', 'error');
                return;
            }
            
            // Close the panel
            document.getElementById('rss-test-panel').style.display = 'none';
            
            // Create a message asking the persona to react to the topic
            const message = `Hey, I just read this article: "${currentRssTopic.title}". ${currentRssTopic.summary ? 'Summary: ' + currentRssTopic.summary.substring(0, 150) + '...' : ''} What do you think about this?`;
            
            // Set the input and send
            document.getElementById('chat-input').value = message;
            await sendChatMessage();
        }
        
        async function testTopicDiscussion() {
            // Get a random topic from the persona's content themes
            const themesArray = themes.length > 0 ? themes : ['life', 'current events', 'your day'];
            const randomTopic = themesArray[Math.floor(Math.random() * themesArray.length)];
            
            const messages = [
                `What's your take on ${randomTopic}?`,
                `I've been thinking about ${randomTopic} lately. What are your thoughts?`,
                `Can we talk about ${randomTopic}? I'd love to hear your perspective.`,
                `Have you been following news about ${randomTopic}? What do you think?`,
                `${randomTopic} has been on my mind. Tell me what you think about it.`
            ];
            
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            document.getElementById('chat-input').value = randomMessage;
            await sendChatMessage();
        }
        
        async function testPersonalityCheck() {
            const messages = [
                "Tell me about yourself. What makes you, you?",
                "What's your typical day like?",
                "What are you passionate about?",
                "How would your friends describe you?",
                "What gets you excited in the morning?",
                "If you could change one thing about the world, what would it be?"
            ];
            
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            document.getElementById('chat-input').value = randomMessage;
            await sendChatMessage();
        }
        
        async function testImageTrigger() {
            const messages = [
                "Hey, send me a selfie!",
                "I'd love to see a pic of you right now",
                "Take a picture for me?",
                "Can you show me what you look like?",
                "Send me a photo of yourself"
            ];
            
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            document.getElementById('chat-input').value = randomMessage;
            await sendChatMessage();
        }
        
        // ==================== TEMPLATE IMPORT/EXPORT FUNCTIONS ====================
        
        async function exportTriggerTemplate() {
            if (editorMode !== 'edit' || !personaId) {
                // For create mode, export the current unsaved configuration
                const template = {
                    version: '1.0',
                    exported_at: new Date().toISOString(),
                    persona_name: document.getElementById('name').value || 'Unsaved Persona',
                    content_triggers: buildContentTriggersConfig(),
                    model_preferences: {
                        text_model_preference: document.getElementById('text_model_preference')?.value || null,
                        image_model_preference: document.getElementById('image_model_preference')?.value || null,
                        video_model_preference: document.getElementById('video_model_preference')?.value || null,
                        voice_model_preference: document.getElementById('voice_model_preference')?.value || null,
                        nsfw_model_preference: document.getElementById('nsfw_model_preference')?.value || null,
                    },
                    generation_settings: {
                        default_image_resolution: document.getElementById('default_image_resolution')?.value || '1024x1024',
                        default_video_resolution: document.getElementById('default_video_resolution')?.value || '1920x1080',
                        generation_quality: document.getElementById('generation_quality')?.value || 'standard',
                        image_style: document.getElementById('image_style')?.value || 'photorealistic',
                        post_style: document.getElementById('post_style')?.value || 'casual',
                    }
                };
                
                downloadTemplate(template);
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/personas/${personaId}/template/export`);
                if (!response.ok) {
                    throw new Error('Failed to export template');
                }
                
                const template = await response.json();
                downloadTemplate(template);
                showAlert('Template exported successfully!', 'success');
                
            } catch (error) {
                console.error('Export failed:', error);
                showAlert('Failed to export template: ' + error.message, 'error');
            }
        }
        
        function downloadTemplate(template) {
            const dataStr = JSON.stringify(template, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `persona-template-${template.persona_name.replace(/[^a-z0-9]/gi, '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function importTriggerTemplate() {
            // Create a file input for import
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const template = JSON.parse(text);
                    
                    // Validate template structure
                    if (!template.version || !template.content_triggers) {
                        throw new Error('Invalid template format - missing required fields');
                    }
                    
                    // Show import options dialog
                    showImportOptionsModal(template);
                    
                } catch (error) {
                    console.error('Import failed:', error);
                    showAlert('Failed to import template: ' + error.message, 'error');
                }
            };
            
            input.click();
        }
        
        function showImportOptionsModal(template) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay show';
            modal.id = 'import-options-modal';
            
            const triggerCount = Object.keys(template.content_triggers || {}).filter(k => !k.startsWith('_')).length;
            const hasModelPrefs = template.model_preferences && Object.values(template.model_preferences).some(v => v);
            const hasGenSettings = template.generation_settings && Object.values(template.generation_settings).some(v => v);
            
            modal.innerHTML = `
                <div class="modal-dialog">
                    <h2 class="modal-header">üì• Import Template</h2>
                    
                    <div style="margin-bottom: 20px; padding: 12px; background: var(--dark-card); border-radius: 8px;">
                        <p style="color: var(--text-secondary); margin-bottom: 8px;">
                            <strong>Source:</strong> ${escapeHtml(template.persona_name || 'Unknown')}
                        </p>
                        <p style="color: var(--text-secondary); margin-bottom: 8px;">
                            <strong>Exported:</strong> ${template.exported_at ? new Date(template.exported_at).toLocaleDateString() : 'Unknown'}
                        </p>
                        <p style="color: var(--text-secondary);">
                            <strong>Contains:</strong> ${triggerCount} triggers${hasModelPrefs ? ', model preferences' : ''}${hasGenSettings ? ', generation settings' : ''}
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">What to import:</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="import-triggers" checked ${triggerCount === 0 ? 'disabled' : ''}>
                                <span>Content Triggers (${triggerCount})</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="import-model-prefs" ${hasModelPrefs ? 'checked' : 'disabled'}>
                                <span>Model Preferences</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="import-gen-settings" ${hasGenSettings ? 'checked' : 'disabled'}>
                                <span>Generation Settings</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Trigger merge mode:</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="merge-mode" value="replace" checked>
                                <span>Replace existing triggers</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="merge-mode" value="merge">
                                <span>Merge with existing triggers</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="modal-actions" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="applyImportedTemplate()" id="apply-import-btn">Import</button>
                    </div>
                </div>
            `;
            
            // Store template data for use in apply function
            modal.dataset.template = JSON.stringify(template);
            
            document.body.appendChild(modal);
            
            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeImportModal();
            });
        }
        
        function closeImportModal() {
            const modal = document.getElementById('import-options-modal');
            if (modal) modal.remove();
        }
        
        async function applyImportedTemplate() {
            const modal = document.getElementById('import-options-modal');
            if (!modal) return;
            
            try {
                const template = JSON.parse(modal.dataset.template);
                const importTriggers = document.getElementById('import-triggers').checked;
                const importModelPrefs = document.getElementById('import-model-prefs').checked;
                const importGenSettings = document.getElementById('import-gen-settings').checked;
                const mergeMode = document.querySelector('input[name="merge-mode"]:checked').value === 'merge';
                
                // If editing existing persona, use the API endpoint
                if (editorMode === 'edit' && personaId) {
                    const importData = {
                        content_triggers: importTriggers ? template.content_triggers : null,
                        model_preferences: importModelPrefs ? template.model_preferences : null,
                        generation_settings: importGenSettings ? template.generation_settings : null,
                        merge_triggers: mergeMode
                    };
                    
                    const response = await fetch(`/api/v1/personas/${personaId}/template/import`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(importData)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to import template');
                    }
                    
                    const result = await response.json();
                    showAlert(`Template imported: ${result.imported.triggers} triggers, ${result.imported.model_preferences} model prefs, ${result.imported.generation_settings} settings`, 'success');
                    
                    // Reload persona data to reflect changes
                    await loadPersonaData();
                    
                } else {
                    // For create mode or local apply, directly update the form
                    if (importTriggers && template.content_triggers) {
                        if (mergeMode) {
                            // Merge triggers
                            for (const [triggerId, triggerConfig] of Object.entries(template.content_triggers)) {
                                if (!triggerId.startsWith('_')) {
                                    contentTriggers[triggerId] = triggerConfig;
                                }
                            }
                            // Also merge _config
                            if (template.content_triggers._config) {
                                const config = template.content_triggers._config;
                                if (config.default_positive_prompt) {
                                    document.getElementById('default_positive_prompt').value = config.default_positive_prompt;
                                }
                                if (config.default_negative_prompt) {
                                    document.getElementById('default_negative_prompt').value = config.default_negative_prompt;
                                }
                                if (config.enable_auto_lora_selection !== undefined) {
                                    document.getElementById('enable_auto_lora_selection').checked = config.enable_auto_lora_selection;
                                }
                                if (config.enable_multi_model_routing !== undefined) {
                                    document.getElementById('enable_multi_model_routing').checked = config.enable_multi_model_routing;
                                }
                            }
                        } else {
                            // Replace triggers
                            contentTriggers = {};
                            for (const [triggerId, triggerConfig] of Object.entries(template.content_triggers)) {
                                if (!triggerId.startsWith('_')) {
                                    contentTriggers[triggerId] = triggerConfig;
                                }
                            }
                            // Apply _config
                            if (template.content_triggers._config) {
                                const config = template.content_triggers._config;
                                document.getElementById('default_positive_prompt').value = config.default_positive_prompt || '';
                                document.getElementById('default_negative_prompt').value = config.default_negative_prompt || '';
                                document.getElementById('enable_auto_lora_selection').checked = config.enable_auto_lora_selection !== false;
                                document.getElementById('enable_multi_model_routing').checked = config.enable_multi_model_routing !== false;
                            }
                        }
                        renderContentTriggers();
                    }
                    
                    if (importModelPrefs && template.model_preferences) {
                        const prefs = template.model_preferences;
                        if (prefs.text_model_preference) {
                            const el = document.getElementById('text_model_preference');
                            if (el) el.dataset.preferredModel = prefs.text_model_preference;
                        }
                        if (prefs.image_model_preference) {
                            const el = document.getElementById('image_model_preference');
                            if (el) el.dataset.preferredModel = prefs.image_model_preference;
                        }
                        if (prefs.video_model_preference) {
                            const el = document.getElementById('video_model_preference');
                            if (el) el.dataset.preferredModel = prefs.video_model_preference;
                        }
                        if (prefs.voice_model_preference) {
                            const el = document.getElementById('voice_model_preference');
                            if (el) el.dataset.preferredModel = prefs.voice_model_preference;
                        }
                        if (prefs.nsfw_model_preference) {
                            const el = document.getElementById('nsfw_model_preference');
                            if (el) el.dataset.preferredModel = prefs.nsfw_model_preference;
                        }
                        // Re-populate dropdowns to apply preferences
                        await loadInstalledModels();
                    }
                    
                    if (importGenSettings && template.generation_settings) {
                        const settings = template.generation_settings;
                        if (settings.default_image_resolution) {
                            const el = document.getElementById('default_image_resolution');
                            if (el) el.value = settings.default_image_resolution;
                        }
                        if (settings.default_video_resolution) {
                            const el = document.getElementById('default_video_resolution');
                            if (el) el.value = settings.default_video_resolution;
                        }
                        if (settings.generation_quality) {
                            const el = document.getElementById('generation_quality');
                            if (el) el.value = settings.generation_quality;
                        }
                        if (settings.image_style) {
                            const el = document.getElementById('image_style');
                            if (el) el.value = settings.image_style;
                        }
                        if (settings.post_style) {
                            const el = document.getElementById('post_style');
                            if (el) el.value = settings.post_style;
                        }
                    }
                    
                    showAlert('Template applied locally! Save the persona to persist changes.', 'success');
                }
                
                closeImportModal();
                
            } catch (error) {
                console.error('Apply import failed:', error);
                showAlert('Failed to apply template: ' + error.message, 'error');
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadBranding();
            parseUrlParams();
            loadPersonaData();
            loadAvailableFeeds(); // Load available feeds for assignment
            loadInstalledModels(); // Load installed AI models for preferences
            
            // If creating new persona, initialize empty assigned feeds
            if (editorMode === 'create') {
                renderAssignedFeeds();
            }
            
            // Show chat section after a short delay (after persona loads)
            setTimeout(() => {
                showChatSection();
            }, 500);
        });
    </script>
</body>
</html>
